<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Medicome - Cas Cliniques Interactifs ECN / EDN & Quiz Médecine</title>
    <meta name="description" content="Simulateur gratuit de diagnostic médical pour préparer les ECN et EDN (R2C). Entraînez-vous sur +100 pathologies (Cardio, Pneumo, Neuro...) avec notre IA pédagogique.">
    <meta name="keywords" content="ECN, EDN, R2C, cas clinique, médecine, quiz médical, diagnostic, sémiologie, révisions médecine, externat">
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Medicome",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      },
      "description": "Simulateur de diagnostic médical assisté par IA pour étudiants en médecine.",
      "image": "https://medicome.fr/favicon.png"
    }
    </script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="icon" href="favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #020b16; --bg-light: #1e3c72;
            --glass-bg: rgba(13, 25, 48, 0.95); --glass-border: rgba(100, 200, 255, 0.15);
            --accent: #00d2ff; --accent-glow: rgba(0, 210, 255, 0.4);
            --text-main: #ffffff; --text-muted: #b0c4de;
            --success: #00ff9d; --error: #ff4d4d;
            --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --ruby: #e01e37;
            --card-shadow: 0 15px 35px rgba(0,0,0,0.6);
        }
        [data-theme="light"] {
            --bg-dark: #e0f2fe; --bg-light: #f0f9ff;
            --glass-bg: rgba(255, 255, 255, 0.95); --glass-border: rgba(0, 114, 255, 0.2);
            --accent: #0072ff; --accent-glow: rgba(0, 114, 255, 0.2);
            --text-main: #0f172a; --text-muted: #475569;
            --success: #059669; --error: #dc2626;
        }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 50% 0%, var(--bg-light), var(--bg-dark) 80%); background-attachment: fixed; color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; padding: 10px 24px; background: var(--glass-bg); backdrop-filter: blur(15px); align-items: center; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .logo-img { height: 60px; width: auto; filter: drop-shadow(0 0 8px var(--accent-glow)); transition: transform 0.3s; }
        .brand:hover .logo-img { transform: scale(1.05); }
        .top-right { display:flex; gap:12px; align-items:center; }
        .pseudo { color:var(--accent); font-weight:600; padding:6px 12px; background: rgba(0, 210, 255, 0.05); border: 1px solid var(--glass-border); border-radius:20px; cursor:pointer; font-size: 14px; }

        /* UI ELEMENTS */
        .link { background: rgba(125,125,125,0.1); border:1px solid var(--glass-border); color: var(--text-muted); padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:14px; }
        .link:hover { background: rgba(125,125,125,0.2); color: var(--text-main); border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        main { flex:1; max-width:1000px; width:100%; margin:0 auto; padding:30px 20px; display:flex; flex-direction:column; align-items:center; }
        .card { background: var(--glass-bg); backdrop-filter: blur(12px); padding:32px; border-radius:20px; box-shadow: var(--card-shadow), inset 0 0 0 1px var(--glass-border); margin-bottom:16px; width:100%; max-width:600px; animation: fadeIn 0.5s ease-out; position: relative;}
        .input, select, textarea { width:100%; padding:14px; border-radius:10px; border:1px solid var(--glass-border); background: rgba(125,125,125,0.1); color: var(--text-main); margin-top:8px; margin-bottom:12px; font-size:14px; font-family: 'Inter', sans-serif; }
        
        select option { background-color: #020b16; color: #ffffff; }
        [data-theme="light"] select option { background-color: #ffffff; color: #000000; }

        .btn { background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%); border:none; padding:14px 24px; border-radius:12px; color: #fff; cursor:pointer; font-weight:700; font-size:15px; transition:all 0.3s; width: 100%; margin-top: 10px; display:flex; align-items:center; justify-content:center; gap:8px;}
        .btn:hover { transform:translateY(-2px); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6); }
        .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: #fff; }
        .btn-error { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; }
        .btn-back { background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 10px; width: auto; display:flex; align-items:center; gap:5px;}
        .btn-back:hover { background: rgba(0, 210, 255, 0.1); color: var(--text-main); }
        .center { text-align:center; display:flex; flex-direction:column; align-items:center; }
        .button-group { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:12px; width: 100%; }
        .small { opacity:0.6; font-size:13px; color:var(--text-muted); margin-top:12px; text-align:center; }
        
        i.ph, i.ph-fill, i.ph-bold, i.ph-duotone { vertical-align: middle; font-size: 1.3em; transition: transform 0.3s ease, color 0.3s ease; }
        .ph-duotone { --secondary-opacity: 0.4; }
        .icon-lg { font-size: 4em !important; filter: drop-shadow(0 0 15px rgba(0, 210, 255, 0.3)); margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        .icon-md { font-size: 2em !important; }
        .color-gold { color: var(--gold); } .color-silver { color: var(--silver); } .color-bronze { color: var(--bronze); } .color-ruby { color: var(--ruby); } .color-success { color: var(--success); } .color-error { color: var(--error); } .color-accent { color: var(--accent); }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }

        .ai-progress-container { width: 100%; height: 6px; background: rgba(125,125,125,0.1); border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .ai-progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.5s ease-out; }
        
        .daily-card { border: 1px solid var(--gold); background: rgba(255, 215, 0, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; width: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .daily-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; justify-content: center; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 20px; }
        .achievement-row { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 15px; background: rgba(125,125,125,0.1); border-radius: 12px; border: 1px solid transparent; text-align: center; height: 100%; transition: transform 0.2s;}
        .achievement-row:hover { transform: scale(1.02); }
        .achievement-row.unlocked { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
        .ach-icon { font-size: 30px; margin-bottom: 5px; opacity: 0.5; filter: grayscale(1); transition: all 0.3s;}
        .achievement-row.unlocked .ach-icon { opacity: 1; filter: grayscale(0) drop-shadow(0 0 8px var(--accent-glow)); }
        .ach-info { width: 100%; }
        .ach-title { font-weight: bold; font-size: 13px; color: var(--text-main); margin-bottom: 4px; }
        .ach-desc { font-size: 11px; color: var(--text-muted); line-height: 1.3; }

        @media (max-width: 700px) {
            .achievements-grid { grid-template-columns: repeat(1, 1fr); }
            .achievement-row { flex-direction: row; text-align: left; }
            .ach-icon { margin-bottom: 0; margin-right:15px; }
        }

        .reviews-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%; }
        .review-card { background: rgba(125,125,125,0.1); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; text-align: left; }
        .star-rating { display: flex; gap: 5px; justify-content: center; margin: 10px 0; direction: rtl; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 25px; color: #888; cursor: pointer; transition: color 0.2s; display: flex; align-items: center;}
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--gold); }
        .review-stars i { font-size: 1em; margin-right: 1px; }

        .mastery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; width: 100%; margin-top: 20px; }
        .mastery-item { background: rgba(125,125,125,0.1); border-radius: 10px; padding: 15px 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .m-locked { border-color: var(--glass-border); opacity: 0.5; filter: grayscale(1); border-style: dashed;}
        .m-bronze { border-color: var(--bronze); background: rgba(205, 127, 50, 0.1); }
        .m-silver { border-color: var(--silver); background: rgba(192, 192, 192, 0.1); }
        .m-gold { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
        .m-master { border-color: var(--ruby); background: rgba(224, 30, 55, 0.15); }
        
        .specialty-badge { font-size: 16px; font-weight: bold; color: var(--text-main); background: linear-gradient(90deg, rgba(0,210,255,0.2) 0%, rgba(0,210,255,0) 100%); padding: 10px 20px; border-radius: 30px; border-left: 4px solid var(--accent); display: inline-block; margin-bottom: 20px; }
        .error-tracker { margin-top: 20px; width: 100%; border-top: 1px solid var(--glass-border); padding-top: 15px; }
        .error-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 77, 77, 0.1); border-left: 3px solid var(--error); margin-bottom: 5px; border-radius: 4px; font-size: 13px; color: var(--text-main); }

        .result-list { background: rgba(0, 0, 0, 0.2); border-radius: 16px; padding: 10px; margin-top: 15px; border: 1px solid var(--glass-border); }
        .result-section-title { font-size: 14px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 5px; display: flex; align-items: center; gap: 8px; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); transition: all 0.2s ease; }
        .result-item:first-of-type { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .result-item:last-of-type { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
        .result-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(5px); }
        .result-label { font-weight: 500; color: var(--text-main); font-size: 15px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .badge-correct { background: rgba(0, 255, 157, 0.15); color: var(--success); border: 1px solid rgba(0, 255, 157, 0.3); }
        .badge-missing { background: rgba(255, 77, 77, 0.15); color: var(--error); border: 1px solid rgba(255, 77, 77, 0.3); }
        .badge-neutral { background: rgba(176, 196, 222, 0.15); color: var(--text-muted); border: 1px solid rgba(176, 196, 222, 0.3); }

        .glossary-wrapper { display: flex; align-items: flex-start; gap: 30px; width: 100%; }
        .search-container { width: 100%; max-width: 600px; margin: 0 auto 30px auto; position: relative; }
        .search-input { width: 100%; padding: 16px 20px 16px 55px; border-radius: 50px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-main); font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); outline: none; transform: translateY(-2px); }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; fill: var(--text-muted); pointer-events: none; transition: fill 0.3s; }
        .search-input:focus ~ .search-icon { fill: var(--accent); }
        .alphabet-sidebar { position: sticky; top: 90px; display: flex; flex-direction: column; gap: 8px; background: var(--glass-bg); padding: 15px 8px; border-radius: 30px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--glass-border); min-width: 50px; align-items: center; box-shadow: var(--card-shadow); scrollbar-width: none; }
        .alphabet-sidebar::-webkit-scrollbar { display: none; }
        .alpha-link { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 700; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; background: rgba(125,125,125,0.05); }
        .alpha-link:hover:not(.disabled) { color: #fff; background: var(--accent); transform: scale(1.1); box-shadow: 0 0 10px var(--accent-glow); }
        .alpha-link.disabled { opacity: 0.3; cursor: default; background: transparent; }
        .glossary-content { flex: 1; width: 100%; }
        .letter-header { font-size: 2rem; font-weight: 800; color: var(--accent); margin: 30px 0 15px; border-bottom: 2px solid var(--glass-border); padding-bottom: 10px; width: 100%; }
        .letter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .patho-card { background: var(--glass-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border); transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; border-left: 4px solid var(--glass-border); }
        .patho-card:hover { transform: translateY(-5px); border-left-color: var(--accent); background: rgba(125,125,125,0.1); box-shadow: var(--card-shadow); }
        .patho-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; color: var(--text-main); }
        .patho-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; }
        
        .stat-box { background: rgba(125,125,125,0.1); padding:20px; border-radius:12px; margin:10px 0; border: 1px solid var(--glass-border); text-align:center; }
        .stat-number { font-size:36px; font-weight:700; color:var(--text-main); }
        
        .notif-btn, .theme-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; margin-right: 5px; }
        .notif-btn i, .theme-btn i { font-size: 24px; color: var(--text-muted); transition: color 0.3s;}
        .notif-btn:hover i, .theme-btn:hover i { color: var(--accent); }

        .notif-badge { position:absolute; top:2px; right:2px; background:var(--error); width:8px; height:8px; border-radius:50%; display:none; }
        .notif-modal { position: absolute; top: 60px; right: 20px; width: 300px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; max-height: 400px; overflow-y: auto; color: var(--text-main); }
        .notif-item { border-bottom: 1px solid var(--glass-border); padding: 10px 0; font-size: 13px; text-align: left; }
        .notif-date { font-size: 11px; color: var(--accent); margin-bottom: 4px; }

        footer { text-align:center; padding:20px 15px; background: rgba(0,0,0,0.5); font-size:12px; border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .footer-nav { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom:5px;}
        .footer-link { color: var(--text-muted); text-decoration: none; cursor: pointer; opacity:0.8; transition:0.3s;} .footer-link:hover { color: var(--accent); opacity:1;}
        .social-links { display: flex; gap: 15px; margin-bottom: 5px; }
        .social-link { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: rgba(125,125,125,0.1); border-radius: 50%; transition: all 0.3s; text-decoration: none; cursor: pointer; }
        .social-link:hover { background: rgba(0, 210, 255, 0.1); transform: scale(1.1); }
        .social-icon { width: 18px; height: 18px; fill: var(--text-muted); transition: fill 0.3s; }
        .social-link:hover .social-icon { fill: var(--accent); }
        
        .alert { padding:14px; border-radius:10px; margin:12px 0; font-size:14px; width: 100%; text-align: center; display:flex; align-items:center; justify-content:center; gap:10px;}
        .alert-success { background: rgba(0, 255, 157, 0.1); border:1px solid var(--success); color:var(--success); }
        .alert-error { background: rgba(255, 77, 77, 0.1); border:1px solid var(--error); color:var(--error); }

        @media (max-width:600px){ 
            .reviews-container, .mastery-grid, .letter-grid { grid-template-columns: repeat(1, 1fr); } 
            .glossary-wrapper { flex-direction: column; } 
            .alphabet-sidebar { flex-direction: row; flex-wrap: nowrap; overflow-x: auto; width: 100%; position: sticky; top: 70px; z-index: 90; padding: 10px; justify-content: flex-start; gap: 10px; border-radius: 15px; margin-bottom: 20px;} 
            .alpha-link { min-width: 35px; min-height: 35px; font-size: 14px; }
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        /* NOUVEAU CSS POUR LES BADGES (CHIPS) */
.chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
}

.chip {
    background: rgba(125, 125, 125, 0.15);
    border: 1px solid var(--glass-border);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
}

.chip:hover {
    background: rgba(125, 125, 125, 0.3);
    color: var(--text-main);
}

.chip.selected {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
    box-shadow: 0 0 10px var(--accent-glow);
    font-weight: 600;
}

.gender-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    width: 100%;
}
.gender-btn {
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    background: rgba(125, 125, 125, 0.1);
    border: 1px solid var(--glass-border);
    cursor: pointer;
    color: var(--text-muted);
    font-size: 24px;
    transition: 0.2s;
}
.gender-btn.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 0 15px var(--accent-glow);
}
        /* --- NOUVEAU CSS POUR LE PROFIL PATIENT --- */

        /* 1. Titres des catégories (Habitudes, Contexte...) */
        .section-label {
            width: 100%;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            margin: 25px 0 10px 0;
            padding-left: 5px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
            opacity: 0.9;
        }

        /* 2. Conteneur des badges (Chips) */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start; /* Aligné à gauche pour la lecture */
            margin-bottom: 10px;
        }

        /* 3. Le Badge (Chip) individuel */
        .chip {
            background: rgba(125, 125, 125, 0.08);
            border: 1px solid var(--glass-border);
            padding: 10px 18px;
            border-radius: 50px; /* Plus arrondi */
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip i { font-size: 1.2em; } /* Icônes un peu plus grandes */

        .chip:hover {
            background: rgba(125, 125, 125, 0.2);
            color: var(--text-main);
            transform: translateY(-2px);
        }

        /* Quand le badge est sélectionné */
        .chip.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 15px var(--accent-glow);
            font-weight: 600;
        }

        /* 4. Les gros boutons Homme/Femme */
        .gender-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
        }

        .gender-btn {
            flex: 1;
            padding: 20px; /* Plus grand */
            border-radius: 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            color: var(--text-muted);
            font-size: 32px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Effet rebond */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gender-btn:hover {
            background: rgba(125,125,125,0.1);
        }

        .gender-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 10px 30px var(--accent-glow);
            transform: scale(1.05); /* Grossit un peu quand actif */
        }
    </style>
</head>
<body>

    <header>
        <div class="brand" id="brandLogo">
            <img src="logo.png" alt="Medicome Logo" class="logo-img">
            <h1 class="sr-only">Medicome</h1>
        </div>
        
        <div class="top-right">
            <button class="theme-btn" id="themeBtn" title="Changer le thème">
                <i class="ph-duotone ph-moon"></i>
            </button>

            <button class="notif-btn" id="notifBtn" title="Nouveautés">
                <i class="ph-duotone ph-bell"></i>
                <div class="notif-badge" id="notifBadge"></div>
            </button>
            <div class="notif-modal" id="notifModal">
                <h4 style="color:var(--text-main); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:10px;"><i class="ph-duotone ph-bell-ringing"></i> Actualités</h4>
                <div id="notifContent"><div class="small">Chargement...</div></div>
            </div>

            <button id="homeBtn" class="link" style="display:none;">Accueil</button>
            <div id="pseudoBox" class="pseudo" style="display:none;">Utilisateur</div>
            <button id="logoutBtn" class="link" style="display:none;">Déconnexion</button>
        </div>
    </header>

    <main id="app">
        <div class="center" id="landing-content" style="padding: 20px; text-align: center;">
            <div class="icon-lg color-accent">
                <i class="ph-duotone ph-stethoscope"></i>
            </div>
            <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-main);">Medicome</h1>
            <h2 style="font-size: 1.2rem; color: var(--accent); margin-bottom: 20px; font-weight: normal;">
                Version 1 
            </h2>
            <div style="max-width: 600px; margin: 0 auto; color: var(--text-muted); line-height: 1.5;">
                <p>Préparez vos ECN, EDN et examens de médecine grâce à notre simulateur de cas cliniques interactif. Cette version inclut l'imagerie médicale.</p>
            </div>
            
            <div style="margin-top: 40px;">
                <div style="font-size: 30px; animation: spin 1s infinite linear;">
                    <i class="ph-duotone ph-gear"></i>
                </div>
                <div class="small" style="margin-top: 10px;">Chargement du noyau médical avec images...</div>
            </div>
        </div>
    </main>

    <footer>
        <div class="social-links">
            <a id="linkInsta" href="https://instagram.com/medicome.fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg></a>
            <a id="linkTiktok" href="https://www.tiktok.com/@medicome.fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M12.5 3.5v10.55c0 1.9-1.55 3.45-3.45 3.45S5.6 15.95 5.6 14.05c0-1.9 1.55-3.45 3.45-3.45 0.3 0 0.6 0.05 0.85 0.15V7.4c-0.25-0.1-0.55-0.15-0.85-0.15-3.8 0-6.9 3.1-6.9 6.9s3.1 6.9 6.9 6.9c3.8 0 6.9-3.1 6.9-6.9V7.6c1.7 1.2 3.8 1.9 6.05 1.9v-3.75c-2.15 0-4.05-0.9-5.3-2.3H12.5z"/></svg></a>
            <a id="linkX" href="https://x.com/medicome_fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10.03 2.38,10.05C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /></svg></a>
        </div>
        <div class="footer-nav">
            <span class="footer-link" onclick="window.scrollTo(0,0)">Haut de page</span>
            <span class="footer-link" id="reviewsLink">Avis Utilisateurs</span>
            <span class="footer-link" id="contactLink">Nous Contacter</span>
            <span class="footer-link" id="legalLink">Mentions Légales & Confidentialité</span>
        </div>
        <section style="max-width:800px; text-align:center; color:var(--text-muted); font-size:0.8em; line-height:1.4; padding:0 15px; margin-bottom:5px;">
            <p style="margin:0;">Medicome : Simulateur de cas cliniques (ECNi, EDN, R2C) et entraînement au diagnostic par pédagogie inversée.</p>
        </section>
        <div style="opacity:0.5; font-size:11px;">Medicome © 2025</div>
    </footer>

    <script type="module">
        if (window.location.hostname.includes("github.io")) { window.location.href = "https://medicome.fr"; }

        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, collection, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FONCTION POUR CHANGER LE TITRE DYNAMIQUEMENT ---
        function setDocTitle(titre) {
            const baseName = "Medicome";
            if (titre) {
                document.title = `${titre} • ${baseName}`;
            } else {
                document.title = `${baseName} - Cas Cliniques Interactifs`;
            }
        }

        // --- NEW GLOBAL IMAGE MAP ---
        // Cette variable va stocker toutes les associations Signe -> Image au chargement du JSON
        let GLOBAL_IMG_MAP = {};

        const REFINEMENTS = {
            "douleur_thoracique": ["douleur_thoracique_oppressive", "douleur_thoracique_dechirante", "douleur_thoracique_coté", "irradiation_bras_machoire", "irradiation_dos", "douleur_effort", "soulage_penche_avant", "oppression_thoracique"],
            "douleur_abdominale": ["douleur_fosse_iliaque_droite", "douleur_fosse_iliaque_gauche", "douleur_hypocondre_droit", "douleur_epigastrique", "douleur_transfixiante_dos", "douleur_abdominale_brutale", "defense_abdominale", "ventre_dur_bois", "douleur_migration_ombilic"],
            "toux": ["toux_seche", "toux_grasse", "toux_sanglante", "toux_chronique", "toux_seche_aboyante", "quintes_toux_violentes", "reprise_inspiratoire_bruyante"],
            "dyspnee": ["dyspnee_effort", "dyspnee_brutale", "orthopnee_dyspnee_couchee", "dyspnee_expiratoire", "dyspnee_inspiratoire", "sifflements_respiratoires"],
            "fievre": ["fievre_elevee", "frissons_intenses", "sueurs_nocturnes", "convulsions_generalisees"],
            "cephalees": ["cephalees_intenses", "cephalees_explosives_brutales", "pulsatile_coeur_cogne", "mal_tete_unilateral", "raideur_nuque", "gene_lumiere"],
            "troubles_visuels": ["vision_double", "vision_floue", "baisse_vision_brutale", "eclairs_lumineux", "pluie_de_suie", "halo_autour_phares", "vision_centrale_floue", "lignes_droites_ondulees"],
            "troubles_neuro": ["paralysie_unilaterale", "troubles_parole_aphasie", "perte_connaissance", "convulsions", "confusion", "tremblement_repos", "rigidite_musculaire"],
            "anomalie_peau": ["ictere_jaunisse", "purpura", "taches_rouges_peau", "eruption_vesicules_bulles", "plaques_rouges", "grain_beaute_asymetrique", "croutes_jaunes_miel"],
            "genes_urinaires": ["brulures_urinaires", "sang_urines", "urines_troubles_odorantes", "envie_frequente_uriner", "difficulte_uriner", "absence_urine"],
            "douleur_membre_traumatisme": ["impossibilite_marcher", "raccourcissement_jambe", "rotation_externe_pied", "poignet_dos_fourchette", "douleur_jambe_brutale_intense", "absence_pouls"],
            "douleur_dos": ["douleur_lombaire_brutale", "irradiation_vers_pubis", "douleur_bas_dos_nuit", "raideur_matin", "irradiation_fesse_jambe"],
            "trouble_psy": ["tristesse_permanente", "idees_noires", "delire_paranoiaque", "excitation_euphorie", "peur_mourir_devenir_fou", "maigreur_extreme"]
        };

        const PATHO_GROUPS = {
            "Infarctus du myocarde": "Cardio", "Embolie pulmonaire": "Cardio", "OAP": "Cardio", "Dissection Aortique": "Cardio", "Péricardite Aiguë": "Cardio", "Fibrillation Atriale": "Cardio", "Endocardite Infectieuse": "Cardio", "Ischémie Aiguë Membre": "Cardio", "Rupture Anévrisme Aorte": "Cardio", "Choc Septique": "Cardio",
            "AVC Ischémique": "Neuro", "Méningite Aiguë": "Neuro", "Hémorragie Méningée": "Neuro", "Crise d'Épilepsie": "Neuro", "Parkinson": "Neuro", "Sclérose en Plaques": "Neuro", "Maladie d'Alzheimer": "Neuro", "Myasthénie": "Neuro", "Hématome Sous-Dural": "Neuro", "Hématome Extra-Dural": "Neuro", "Guillain-Barré": "Neuro",
            "Pneumopathie Franche": "Pneumo", "Pneumothorax": "Pneumo", "Crise d'Asthme": "Pneumo", "Bronchiolite": "Pneumo", "BPCO Exacerbation": "Pneumo", "Cancer Bronchique": "Pneumo", "Tuberculose Pulmonaire": "Pneumo", "Apnée du Sommeil": "Pneumo", "Pleurésie": "Pneumo",
            "Appendicite Aiguë": "Digestif", "Cholécystite Aiguë": "Digestif", "Gastro-entérite": "Digestif", "Occlusion Intestinale": "Digestif", "Pancreatite Aiguë": "Digestif", "Hémorragie Digestive Haute": "Digestif", "Sigmoïdite": "Digestif", "Hernie Inguinale Étranglée": "Digestif", "Reflux Gastro-Oesophagien": "Digestif", "Cirrhose Décompensée": "Digestif", "Cancer Colorectal": "Digestif", "Maladie de Crohn": "Digestif", "Rectocolite Hémorragique": "Digestif", "Ulcère Gastroduodénal": "Digestif", "Hépatite Aiguë": "Digestif", "Lithiase Biliaire": "Digestif", "Hernie Hiatale": "Digestif", "Péritonite": "Digestif", "Ischémie Mésentérique": "Digestif", "Sténose du Pylore": "Digestif",
            "Colique Néphrétique": "Uro/Nephro", "Pyélonéphrite Aiguë": "Uro/Nephro", "Torsion du Testicule": "Uro/Nephro", "Rétention Aiguë d'Urine": "Uro/Nephro", "Cancer Prostate": "Uro/Nephro", "Tumeur Vessie": "Uro/Nephro", "Insuffisance Rénale Aiguë": "Uro/Nephro", "Syndrome Néphrotique": "Uro/Nephro", "Cystite Aiguë": "Uro/Nephro", "Cancer du Testicule": "Uro/Nephro", "Insuffisance Rénale Chronique": "Uro/Nephro", "Diabète Insipide": "Endo",
            "Grossesse Extra-Utérine": "Gynéco", "Salpingite Aiguë": "Gynéco", "Endométriose": "Gynéco", "Cancer du Sein": "Gynéco", "Pré-éclampsie": "Gynéco", "Fibrome Utérin": "Gynéco", "Kyste Ovarien": "Gynéco", "Mycose Vaginale": "Gynéco", "SOPK": "Gynéco",
            "Érysipèle": "Dermato", "Zona": "Dermato", "Purpura Rhumatoïde": "Dermato", "Varicelle": "Dermato", "Psoriasis": "Dermato", "Mélanome": "Dermato", "Carcinome Basocellulaire": "Dermato", "Gale": "Dermato", "Rougeole": "Dermato", "Syndrome de Kawasaki": "Dermato", "Scarlatine": "Dermato", "Impétigo": "Dermato", "Acné Sévère": "Dermato", "Eczéma Atopique": "Dermato", "Urticaire Aiguë": "Dermato",
            "Fracture Col Fémur": "Rhumato/Ortho", "Arthrite Septique": "Rhumato/Ortho", "Sciatique": "Rhumato/Ortho", "Crise de Goutte": "Rhumato/Ortho", "Fracture Pouteau-Colles": "Rhumato/Ortho", "Polyarthrite Rhumatoïde": "Rhumato/Ortho", "Spondylarthrite": "Rhumato/Ortho", "Ostéoporose Fracturaire": "Rhumato/Ortho", "Canal Carpien": "Rhumato/Ortho", "Lumbago": "Rhumato/Ortho", "Entorse de Cheville": "Rhumato/Ortho", "Arthrose": "Rhumato/Ortho", "Lupus Érythémateux": "Rhumato/Ortho", "Hernie Discale": "Rhumato/Ortho",
            "Anémie Ferriprive": "Hémato/Endo", "Hypothyroïdie": "Hémato/Endo", "Hyperthyroïdie": "Hémato/Endo", "Diabète Type 1": "Hémato/Endo", "Diabète Type 2": "Hémato/Endo", "Insuffisance Surrénalienne": "Hémato/Endo", "Syndrome de Cushing": "Hémato/Endo", "Leucémie Aiguë": "Hémato/Endo", "Lymphome de Hodgkin": "Hémato/Endo", "Myélome Multiple": "Hémato/Endo", "Drépanocytose": "Hémato/Endo", "Hyperparathyroïdie": "Hémato/Endo", "Acromégalie": "Hémato/Endo", "Hémophilie": "Hémato/Endo", "Anémie de Biermer": "Hémato/Endo",
            "Attaque de Panique": "Psy", "Dépression": "Psy", "Schizophrénie": "Psy", "Trouble Bipolaire": "Psy", "Anorexie Mentale": "Psy",
            "Glaucome Aigu": "ORL/Ophtalmo", "Otite Moyenne Aiguë": "ORL/Ophtalmo", "DMLA": "ORL/Ophtalmo", "Cataracte": "ORL/Ophtalmo", "Décollement de Rétine": "ORL/Ophtalmo", "VPPB": "ORL/Ophtalmo", "Angine Bactérienne": "ORL/Ophtalmo", "Epistaxis": "ORL/Ophtalmo", "Sinusite Aiguë": "ORL/Ophtalmo", "Laryngite Aiguë": "ORL/Ophtalmo", "Conjonctivite": "ORL/Ophtalmo", "Orgelet": "ORL/Ophtalmo",
            "Paludisme": "Infectio", "Coqueluche": "Infectio", "Grippe": "Infectio", "Mononucléose Infectieuse": "Infectio", "Primo-Infection VIH": "Infectio", "Maladie de Lyme": "Infectio", "Tétanos": "Infectio", "Botulisme": "Infectio", "Rubéole": "Infectio", "Syphilis": "Infectio", "Oreillons": "Infectio", "Muguet Buccal": "Infectio"
        };
        
        // --- 3D-STYLE ICONS (USING PHOSPHOR DUOTONE) ---
        const ACHIEVEMENTS = [
            { id: "played_10_days", title: "Habitué", desc: "Connexion 10 jours", iconClass: "ph-duotone ph-calendar-check color-bronze" },
            { id: "played_30_days", title: "Fidèle", desc: "Connexion 30 jours", iconClass: "ph-duotone ph-calendar-check color-silver" },
            { id: "played_90_days", title: "Addict", desc: "Connexion 90 jours", iconClass: "ph-duotone ph-calendar-check color-gold" },

            { id: "baby_doc", title: "P1 validée", desc: "Identifier 1 pathologie", iconClass: "ph-duotone ph-baby color-silver" },
            { id: "med_student", title: "Externe", desc: "Identifier 25 pathologies", iconClass: "ph-duotone ph-student color-accent" },
            { id: "intern", title: "Interne", desc: "Identifier 50 pathologies", iconClass: "ph-duotone ph-stethoscope color-accent" },
            { id: "chief", title: "Chef de Clinique", desc: "Identifier 100 pathologies", iconClass: "ph-duotone ph-hospital color-gold" },
            
            { id: "cases_100", title: "Débutant", desc: "100 cas joués", iconClass: "ph-duotone ph-folder-open color-bronze" },
            { id: "cases_1000", title: "Expérimenté", desc: "1000 cas joués", iconClass: "ph-duotone ph-folder-open color-silver" },
            { id: "cases_5000", title: "Vétéran", desc: "5000 cas joués", iconClass: "ph-duotone ph-folder-open color-gold" },

            { id: "daily_10", title: "Expert du Quotidien", desc: "10 défis du jour", iconClass: "ph-duotone ph-sun color-bronze" },
            { id: "daily_50", title: "Champion du Jour", desc: "50 défis du jour", iconClass: "ph-duotone ph-sun color-silver" },
            { id: "daily_150", title: "Légende Solaire", desc: "150 défis du jour", iconClass: "ph-duotone ph-sun color-gold" },

            { id: "critic", title: "Critique Médical", desc: "Publier un avis", iconClass: "ph-duotone ph-star color-gold" },
            { id: "fan", title: "Fan Club", desc: "Suivre sur les réseaux", iconClass: "ph-duotone ph-heart color-ruby" },
            { id: "bookworm_1", title: "Rat de Bibliothèque", desc: "Télécharger 1 fiche PDF", iconClass: "ph-duotone ph-scroll color-bronze" },
            { id: "bookworm_25", title: "Archiviste", desc: "Télécharger 25 fiches PDF", iconClass: "ph-duotone ph-books color-silver" },
            { id: "bookworm_50", title: "Bibliothécaire", desc: "Télécharger 50 fiches PDF", iconClass: "ph-duotone ph-columns color-gold" },
            { id: "bookworm_100", title: "Savoir Absolu", desc: "Télécharger 100 fiches PDF", iconClass: "ph-duotone ph-brain color-accent" },
            { id: "master_5", title: "Major de Promo", desc: "5 pathologies au rang Maître", iconClass: "ph-duotone ph-medal color-bronze" },
            { id: "master_30", title: "Professeur", desc: "30 pathologies au rang Maître", iconClass: "ph-duotone ph-crown color-silver" },
            { id: "master_100", title: "Légende", desc: "100 pathologies au rang Maître", iconClass: "ph-duotone ph-trophy color-gold" },
            { id: "encyclopedia", title: "Encyclopédie Vivante", desc: "Débloquer toutes les pathologies", iconClass: "ph-duotone ph-globe color-accent" },
            { id: "god_mode", title: "Dieu de la Médecine", desc: "Toutes pathologies en Maître", iconClass: "ph-duotone ph-lightning color-gold" },
            { id: "speed_demon", title: "Flash", desc: "10 diagnostics en moins de 30s", iconClass: "ph-duotone ph-rocket color-ruby" }, 
            { id: "speed_50", title: "Vitesse Lumière", desc: "50 diagnostics en moins de 30s", iconClass: "ph-duotone ph-shooting-star color-gold" },
            { id: "speed_100", title: "Voyageur Temporel", desc: "100 diagnostics en moins de 30s", iconClass: "ph-duotone ph-hourglass color-accent" }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCig9G4gYHU5h642YV1IZxthYm_IXp6vZU",
            authDomain: "medicome-paco.firebaseapp.com",
            projectId: "medicome-paco",
            storageBucket: "medicome-paco.firebasestorage.app",
            messagingSenderId: "332171806096",
            appId: "1:332171806096:web:36889325196a7a718b5f15",
            measurementId: "G-81HJ9DWBMX"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erreur Firebase:", error);
            document.querySelector('#app').innerHTML = `<div class="alert alert-error">Erreur de configuration : ${error.message}</div>`;
        }

        let PATHOLOGIES = [];
        const ACCESS_CODES = [ { code: "SuperCode1", pseudo:"Admin" } ];

        let state = {
            currentUser: null, pseudo: null, 
            progression: { 
                correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {},
                pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false
            },
            isGuest: false, demo:{}, currentSign:null, answers:{}, asked:[], allSigns:[], ranked: [], diagnosticShown:false, previousDiagnostics:[],
            history: [],
            confirmationMode: false, confirmationQueue: [], confirmedPatho: null,
            priorityQueue: [],
            isChrono: false, startTime: null, dailyTarget: null
        };

        // --- THEME LOGIC ---
        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('medicome_theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const btn = document.getElementById('themeBtn');
            if(btn) {
                btn.innerHTML = theme === 'light' ? '<i class="ph-duotone ph-moon"></i>' : '<i class="ph-duotone ph-sun"></i>';
            }
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('medicome_theme');
            if(saved) {
                document.body.setAttribute('data-theme', saved);
                updateThemeIcon(saved);
            }
            const btn = document.getElementById('themeBtn');
            if(btn) btn.onclick = toggleTheme;
        }

        // --- DAILY CHALLENGE LOGIC ---
        function getDailyPatho() {
            if(PATHOLOGIES.length === 0) return null;
            const today = new Date().toDateString(); 
            let hash = 0;
            for (let i = 0; i < today.length; i++) {
                hash = today.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % PATHOLOGIES.length;
            return PATHOLOGIES[index];
        }

        async function initApp() {
            try {
                // Chargement des données
                const response = await fetch('./pathologies.json');
                if (!response.ok) throw new Error("Impossible de lire le fichier de données pathologies.json");
                PATHOLOGIES = await response.json();
                
                // --- NEW : GENERATE GLOBAL IMAGE MAP FROM JSON DATA ---
                // This allows renderCurrentQuestion to access images easily
                PATHOLOGIES.forEach(p => {
                    if(p.images) {
                        for (const [signKey, imgUrl] of Object.entries(p.images)) {
                            GLOBAL_IMG_MAP[signKey] = imgUrl;
                        }
                    }
                });
                console.log("Images loaded:", Object.keys(GLOBAL_IMG_MAP).length);
                
                // DEEP LINKING
                const urlParams = new URLSearchParams(window.location.search);
                const ficheDemandee = urlParams.get('fiche');
                if (ficheDemandee) {
                    const pathoTrouvee = PATHOLOGIES.find(p => p.name.toLowerCase() === ficheDemandee.toLowerCase());
                    if (pathoTrouvee) {
                        q('#app').innerHTML = ''; 
                        showDiagnosticDetails({patho: pathoTrouvee});
                        return;
                    }
                }
                
                loadTheme();
                startAuthListener();
                fetchNotifications();
                
                // === INIT BUTTON LISTENERS ===
                const btnLegal = q('#legalLink');
                if(btnLegal) btnLegal.onclick = renderLegalPage;
                
                const cLink = q('#contactLink');
                if(cLink) cLink.onclick = renderContact;
                
                const rLink = q('#reviewsLink');
                if(rLink) rLink.onclick = renderReviews;

                // Social Links
                ['linkInsta', 'linkTiktok', 'linkX'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('click', trackSocial);
                });

                // Notifs
                const notifBtn = q('#notifBtn');
                const notifModal = q('#notifModal');
                if(notifBtn) {
                    notifBtn.onclick = (e) => {
                        e.stopPropagation();
                        const isVisible = notifModal.style.display === 'block';
                        notifModal.style.display = isVisible ? 'none' : 'block';
                        
                        if(!isVisible) { 
                            const badge = q('#notifBadge'); 
                            if(badge) badge.style.display = 'none'; 
                            
                            if(state.latestNotifId) {
                                localStorage.setItem('medicome_last_read_notif', state.latestNotifId);
                            }
                        }
                    };
                }
                window.onclick = () => { if(notifModal) notifModal.style.display = 'none'; };

                const brandLogo = document.getElementById('brandLogo');
                if(brandLogo) {
                    brandLogo.onclick = () => { if (state.currentUser || state.isGuest) { renderHome(); } };
                }

                // GESTION DE LA VISIBILITÉ DE L'ONGLET (TITRE)
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) {
                        // L'utilisateur a changé d'onglet
                        document.title = "⚠️ Le patient attend !";
                    } else {
                        // L'utilisateur est revenu
                        if(q('.question-text')) {
                             setDocTitle(`Question ${state.asked.length}`);
                        } else if(state.diagnosticShown && state.ranked.length > 0) {
                             setDocTitle(`Diagnostic : ${state.ranked[0].patho.name}`);
                        } else if(state.currentUser) {
                             // Si on est connecté mais pas en quiz, on peut mettre Accueil ou laisser générique
                             document.title = "Medicome";
                        } else {
                             document.title = "Medicome";
                        }
                    }
                });

                // GESTION CLAVIER AJOUTÉE
                // GESTION CLAVIER CORRIGÉE
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Navigation Quiz
            if (q('.question-text')) {
                if (e.key === 'ArrowRight' || e.key === 'y' || e.key === 'o') {
                    const btn = document.querySelector('.btn-success');
                    if(btn) btn.click();
                } else if (e.key === 'ArrowLeft' || e.key === 'n') {
                    const btn = document.querySelector('.btn-error');
                    if(btn) btn.click();
                } else if (e.key === 'ArrowUp' || e.key === 'i' || e.key === ' ') {
                    e.preventDefault();
                    const btns = document.querySelectorAll('.button-group .link');
                    if(btns.length > 0) btns[0].click();
                } else if (e.key === 'Enter') {
                    const btn = document.querySelector('.btn-success');
                    if(btn) btn.click();
                }
            } else {
                // Navigation Menus / Accueil
                if (e.key === 'Enter') {
                    // On vérifie si l'utilisateur est déjà sur un élément cliquable (via TAB)
                    const active = document.activeElement;
                    const isInteractive = active && (
                        active.tagName === 'BUTTON' || 
                        active.tagName === 'A' || 
                        active.classList.contains('link') || 
                        active.classList.contains('footer-link') ||
                        active.classList.contains('social-link')
                    );

                    // Si on n'est PAS sur un élément interactif, on clique sur le bouton principal
                    if (!isInteractive) {
                        const primaryBtn = q('.btn'); 
                        if(primaryBtn && primaryBtn.offsetParent !== null) {
                            primaryBtn.click();
                        }
                    }
                }
            }
            
            if (e.key === 'Escape') {
                const notifModal = q('#notifModal');
                if(notifModal && notifModal.style.display === 'block') {
                    notifModal.style.display = 'none';
                } else if (!q('.question-text') && state.currentUser) {
                    renderHome();
                }
            }
        });

            } catch (err) {
                console.error(err);
                document.querySelector('#app').innerHTML = `<div class="card center"><h2 style="color:var(--error)">Erreur de chargement</h2><div class="small" style="color:orange">${err.message}</div></div>`;
            }
        }
        initApp();

        async function fetchNotifications() {
            try {
                const qRef = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
                const snapshot = await getDocs(qRef);
                const container = q('#notifContent');
                
                if (snapshot.empty) { 
                    container.innerHTML = '<div class="small">Aucune nouveauté pour le moment.</div>'; 
                    return; 
                }
                
                container.innerHTML = '';
                
                const latestNotifId = snapshot.docs[0].id;
                state.latestNotifId = latestNotifId; 

                snapshot.forEach(doc => {
                    const n = doc.data();
                    const div = document.createElement('div');
                    div.className = 'notif-item';
                    const dateStr = n.date && n.date.seconds ? new Date(n.date.seconds * 1000).toLocaleDateString() : 'Récemment';
                    div.innerHTML = `<div class="notif-date">${dateStr}</div><div style="color:var(--text-main);">${n.message}</div>`;
                    container.appendChild(div);
                });

                const badge = q('#notifBadge');
                const lastReadId = localStorage.getItem('medicome_last_read_notif');

                if(badge && latestNotifId !== lastReadId) {
                    badge.style.display = 'block';
                } else if (badge) {
                    badge.style.display = 'none';
                }

            } catch (e) { console.log("Erreur notifs", e); }
        }

        function startAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user; state.isGuest = false;
                    let displayPseudo = user.displayName;
                    if (!displayPseudo && user.email) displayPseudo = user.email.split('@')[0];
                    state.pseudo = displayPseudo; updateHeader(); 
                    const docRef = doc(db, "users", user.uid);
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.pseudo) state.pseudo = data.pseudo;
                            state.progression = { ...state.progression, ...data.progression };
                        } else { saveProgression(); }
                        updateHeader(); renderHome();
                    } catch(e) { renderHome(); }
                } else {
                    const savedGuest = localStorage.getItem('medicome_guest_progression');
                    const savedPseudo = localStorage.getItem('medicome_guest_pseudo');
                    if(!state.isGuest && savedGuest && savedPseudo) {
                        state.isGuest = true; state.pseudo = savedPseudo;
                        const parsed = JSON.parse(savedGuest);
                        state.progression = { ...state.progression, ...parsed };
                        
                        if(state.progression.streak === undefined) state.progression.streak = 0;
                        if(!state.progression.mastery) state.progression.mastery = {};
                        updateHeader(); renderHome();
                        setTimeout(() => showAlert(`<i class="ph-duotone ph-party-popper"></i> Bon retour, ${state.pseudo} !`, 'success'), 500);
                    } else {
                        state.currentUser = null; state.pseudo = null; 
                        state.progression = { 
                            correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {},
                            pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false
                        };
                        renderLogin(); updateHeader();
                    }
                }
            });
        }

        function q(sel){ return document.querySelector(sel); }
        function formatSigneName(sign){ return sign.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }
        function showAlert(message,type){
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type;
            alertDiv.innerHTML = message; 
            const app = q('#app');
            if(app){ app.insertBefore(alertDiv,app.firstChild); setTimeout(()=>{ if(alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv); },3000); }
        }
        
        function triggerConfetti() {
            if(window.confetti) { window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        }

        async function saveProgression() {
            checkAchievements();
            if (!state.isGuest && state.currentUser) {
                try {
                    const userRef = doc(db, "users", state.currentUser.uid);
                    await setDoc(userRef, { progression: state.progression, pseudo: state.pseudo, lastUpdate: new Date() }, { merge: true });
                } catch (e) { console.error("Erreur sauvegarde Cloud", e); }
            } else if (state.isGuest) {
                localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
                localStorage.setItem('medicome_guest_pseudo', state.pseudo);
            }
        }
        
        function checkAchievements() {
            if(!state.progression.achievements) state.progression.achievements = [];
            const unlock = (id) => {
                if(!state.progression.achievements.includes(id)) {
                    state.progression.achievements.push(id);
                    showAlert(`<i class="ph-duotone ph-trophy"></i> Succès débloqué !`, 'success');
                    triggerConfetti();
                }
            };
            
            const p = state.progression;
            const totalPlayed = p.correct + p.incorrect;
            const dailyVal = p.dailyStreak || 0;

            if(p.correct >= 1) unlock('baby_doc');
            if(p.correct >= 25) unlock('med_student');
            if(p.correct >= 50) unlock('intern');
            if(p.correct >= 100) unlock('chief');
            if(p.reviewDone) unlock('critic');
            if(p.socialDone) unlock('fan');
            if(p.pdfDownloads >= 1) unlock('bookworm_1');
            if(p.pdfDownloads >= 25) unlock('bookworm_25');
            if(p.pdfDownloads >= 50) unlock('bookworm_50');
            if(p.pdfDownloads >= 100) unlock('bookworm_100');
            
            if(p.speedWins >= 10) unlock('speed_demon'); 
            if(p.speedWins >= 50) unlock('speed_50');
            if(p.speedWins >= 100) unlock('speed_100');
            
            if (totalPlayed >= 100) unlock('cases_100');
            if (totalPlayed >= 1000) unlock('cases_1000');
            if (totalPlayed >= 5000) unlock('cases_5000');

            if (dailyVal >= 10) unlock('played_10_days');
            if (dailyVal >= 30) unlock('played_30_days');
            if (dailyVal >= 90) unlock('played_90_days');

            if (dailyVal >= 10) unlock('daily_10');
            if (dailyVal >= 50) unlock('daily_50');
            if (dailyVal >= 150) unlock('daily_150');
            
            const unlockedCount = Object.keys(p.mastery || {}).filter(k => p.mastery[k].success > 0).length;
            const masterCount = Object.keys(p.mastery || {}).filter(k => p.mastery[k].success >= 10).length;
            
            if(masterCount >= 5) unlock('master_5');
            if(masterCount >= 30) unlock('master_30');
            if(masterCount >= 100) unlock('master_100');
            
            if(unlockedCount >= PATHOLOGIES.length && PATHOLOGIES.length > 0) unlock('encyclopedia');
            if(masterCount >= PATHOLOGIES.length && PATHOLOGIES.length > 0) unlock('god_mode');
        }
        
        function trackPdf() {
            state.progression.pdfDownloads = (state.progression.pdfDownloads || 0) + 1;
            saveProgression();
        }
        
        function trackSocial() {
            if(!state.progression.socialDone) {
                state.progression.socialDone = true;
                saveProgression();
            }
        }

        function updateHeader(){
            const pseudoBox = q("#pseudoBox"); const homeBtn = q("#homeBtn"); const logoutBtn = q("#logoutBtn");
            const currentStreak = state.progression.streak || 0;
            const streakDisplay = currentStreak > 0 ? ` <span style="color:#ff9f43; margin-left:8px; display:inline-flex; align-items:center; gap:4px;"><i class="ph-duotone ph-fire"></i> ${currentStreak}</span>` : '';

            if(state.pseudo){ 
                pseudoBox.innerHTML = state.pseudo + (state.isGuest ? " (Local)" : "") + streakDisplay; 
                pseudoBox.style.display='inline-block'; pseudoBox.onclick=renderProfile;
                homeBtn.style.display='inline-block'; logoutBtn.style.display='inline-block';
            } else { 
                pseudoBox.style.display='none'; homeBtn.style.display='none'; logoutBtn.style.display='none';
            }
            homeBtn.onclick=renderHome;
            logoutBtn.onclick = () => {
                localStorage.removeItem('medicome_guest_progression'); localStorage.removeItem('medicome_guest_pseudo');
                state.isGuest = false; state.pseudo = null; state.currentUser = null; 
                state.progression = { correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {}, pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false }; 
                signOut(auth).then(() => { renderLogin(); updateHeader(); showAlert("Déconnecté", "success"); }).catch(() => { renderLogin(); updateHeader(); });
            };
        }

        function renderLogin() {
            setDocTitle("Connexion");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center'; card.innerHTML='<h2><i class="ph-duotone ph-cloud"></i>Connexion</h2>';
            const inputUser = document.createElement('input'); inputUser.placeholder='Email'; inputUser.className='input';
            const inputPass = document.createElement('input'); inputPass.placeholder='Mot de passe'; inputPass.className='input'; inputPass.type='password';
            
            const btnLogin = document.createElement('button'); btnLogin.className='btn'; btnLogin.textContent='Se connecter';
            btnLogin.onclick = async () => { try { await signInWithEmailAndPassword(auth, inputUser.value, inputPass.value); showAlert("Connexion réussie !", "success"); } catch (error) { showAlert("Erreur: " + error.message, "error"); } };
            
            const btnForgot = document.createElement('div'); 
            btnForgot.className='small link'; btnForgot.style.border='none'; btnForgot.textContent='Mot de passe oublié ?';
            btnForgot.onclick = async () => {
                if(!inputUser.value) return showAlert("Veuillez entrer votre email d'abord", "error");
                try { await sendPasswordResetEmail(auth, inputUser.value); showAlert("Email de réinitialisation envoyé !", "success"); } catch(e) { showAlert("Erreur: " + e.message, "error"); }
            };

            card.appendChild(inputUser); card.appendChild(inputPass); card.appendChild(btnLogin); card.appendChild(btnForgot);
            
            const sep = document.createElement('div'); sep.textContent='— Pas encore de compte ? —'; sep.className='small'; sep.style.margin='16px 0'; card.appendChild(sep);
            const inRegEmail = document.createElement('input'); inRegEmail.placeholder='Nouvel Email'; inRegEmail.className='input';
            const inRegPass = document.createElement('input'); inRegPass.placeholder='Nouveau Mot de passe'; inRegPass.className='input'; inRegPass.type='password';
            const inPseudo = document.createElement('input'); inPseudo.placeholder='Votre Pseudo'; inPseudo.className='input';
            const btnReg = document.createElement('button'); btnReg.className='link'; btnReg.textContent='Créer un compte Cloud';
            btnReg.onclick = async () => {
                if(!inRegEmail.value || !inRegPass.value || !inPseudo.value) return showAlert('Remplissez tout','error');
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, inRegEmail.value, inRegPass.value);
                    const user = userCredential.user; await updateProfile(user, { displayName: inPseudo.value });
                    await setDoc(doc(db, "users", user.uid), { pseudo: inPseudo.value, email: inRegEmail.value, progression: { correct: 0, incorrect: 0, streak: 0, mastery: {} }, createdAt: new Date() }, { merge: true });
                    state.pseudo = inPseudo.value; showAlert("Compte créé !", "success"); updateHeader(); renderHome();
                } catch (error) { showAlert("Erreur création: " + error.message, "error"); }
            };
            card.appendChild(inRegEmail); card.appendChild(inRegPass); card.appendChild(inPseudo); card.appendChild(btnReg);
            const sepCode = document.createElement('div'); sepCode.textContent='— ou Accès Rapide (Local) —'; sepCode.className='small'; sepCode.style.margin='16px 0'; card.appendChild(sepCode);
            const inputCode = document.createElement('input'); inputCode.placeholder='Clé d\'accès'; inputCode.className='input';
            const btnCode = document.createElement('button'); btnCode.className='btn btn-code'; btnCode.textContent='Utiliser une clé';
            btnCode.onclick = () => {
                const codeFound = ACCESS_CODES.find(ac => ac.code === inputCode.value);
                if(codeFound) {
                    state.isGuest = true; state.pseudo = codeFound.pseudo; state.progression = {correct:0, incorrect:0, streak:0, mastery:{}};
                    saveProgression(); updateHeader(); renderHome(); showAlert(`Mode Invité: ${codeFound.pseudo}`, 'success');
                } else { showAlert('Clé invalide', 'error'); }
            };
            card.appendChild(inputCode); card.appendChild(btnCode); app.appendChild(card);
        }

        function renderHome() {
            setDocTitle("Accueil");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const card = document.createElement('div'); card.className='card center';
            let cloudBadge = state.isGuest ? '<span style="color:orange; font-size:0.8em; margin-bottom:10px"><i class="ph-duotone ph-floppy-disk"></i> Mode Local</span>' : '<span style="color:var(--success); font-size:0.8em; margin-bottom:10px"><i class="ph-duotone ph-cloud-check"></i> Sauvegarde Active</span>';
            const displayName = state.pseudo || '...';
            
            const dailyPatho = getDailyPatho();
            const todayStr = new Date().toDateString();
            const isDailyDone = prog.lastDaily === todayStr;
            const dailyClass = isDailyDone ? "daily-title" : "daily-title"; 
            const dailyText = isDailyDone ? `<i class='ph-duotone ph-check-circle color-success'></i> Défi du jour validé !` : `<i class='ph-duotone ph-sun color-gold'></i> Défi du ${new Date().toLocaleDateString()}`;
            const dailyContent = isDailyDone ? "Revenez demain pour un nouveau défi du jour!" : `Faire identifier : <strong>${dailyPatho ? dailyPatho.name : 'Chargement...'}</strong>`;

            card.innerHTML = `<h2>Bonjour ${displayName}</h2>${cloudBadge}
                            
                            <div class="daily-card">
                                <div class="${dailyClass}">${dailyText}</div>
                                <div style="font-size:0.9em; color:var(--text-main); margin-bottom:5px;">${dailyContent}</div>
                                ${!isDailyDone ? `<button id="btnDaily" class="btn" style="background:var(--gold); color:#000; font-size:12px; padding:8px 15px; margin-top:5px;">Relever le défi</button>` : ''}
                            </div>

                            <div class="stat-box" style="width:100%"><div class="stat-number">${prog.correct + prog.incorrect}</div><div class="stat-label">Cas joués</div></div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-top:12px;">
                            <div class="stat-box" style="text-align:center; background:rgba(0, 255, 157, 0.1); border-color:var(--success)"><div class="stat-number" style="color:var(--success);">${prog.correct}</div><div class="stat-label">Succès</div></div>
                            <div class="stat-box" style="text-align:center; background:rgba(255, 77, 77, 0.1); border-color:var(--error)"><div class="stat-number" style="color:var(--error);">${prog.incorrect}</div><div class="stat-label">Échecs</div></div>
                            </div>`;
            
            const howToCard = document.createElement('div');
            howToCard.style.cssText = "background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); padding:15px; border-radius:12px; margin-top:20px; width:100%; text-align:left;";
            howToCard.innerHTML = `
                <div style="font-weight:bold; color:var(--accent); margin-bottom:8px;"><i class="ph-duotone ph-info"></i> Comment ça marche ?</div>
                <div style="font-size:0.9em; color:var(--text-muted); line-height:1.4;">
                    1. Réfléchissez à une pathologie et ses signes cliniques associés.<br>
                    2. Faites deviner à l'IA la pathologie à laquelle vous pensez.<br>
                    3. Répondez correctement aux questions de l'IA.<br>
                    4. La pathologie est découverte si les signes cliniques sont corrects!
                </div>
            `;
            card.appendChild(howToCard);

            const btnDiag = document.createElement('button'); btnDiag.className='btn'; btnDiag.innerHTML='<i class="ph-duotone ph-stethoscope"></i> Entraînement Libre'; btnDiag.style.marginTop='24px'; btnDiag.style.width='100%'; 
            btnDiag.onclick= () => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                state.dailyTarget = null;
                renderDemographics();
            };
            const btnGloss = document.createElement('button'); btnGloss.className='link'; btnGloss.innerHTML='<i class="ph-duotone ph-book-bookmark"></i> Glossaire'; btnGloss.style.marginTop='12px'; btnGloss.onclick=renderGlossary;
            const btnProf = document.createElement('button'); btnProf.className='link'; btnProf.innerHTML='<i class="ph-duotone ph-user-circle"></i> Profil & Succès'; btnProf.style.marginTop='6px'; btnProf.onclick=renderProfile;
            
            card.appendChild(btnDiag); card.appendChild(btnGloss); card.appendChild(btnProf); 
            app.appendChild(card);

            const btnDaily = q('#btnDaily');
            if(btnDaily) {
                btnDaily.onclick = () => {
                    if(audioCtx.state === 'suspended') audioCtx.resume();
                    state.dailyTarget = dailyPatho;
                    state.isChrono = false; 
                    renderDemographics();
                };
            }
        }

        async function renderReviews() {
            setDocTitle("Avis Utilisateurs");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2><i class="ph-duotone ph-star color-gold"></i> Avis Utilisateurs</h2><p class="small" style="margin-bottom:20px">Ce qu'ils pensent de Medicome.</p>`;

            const formDiv = document.createElement('div');
            formDiv.style.background = 'rgba(125,125,125,0.1)'; formDiv.style.padding='15px'; formDiv.style.borderRadius='10px'; formDiv.style.width='100%'; formDiv.style.marginBottom='20px';
            
            formDiv.innerHTML = `<h4 style="margin-bottom:10px; color:var(--accent);">Laisser un avis</h4>
            <div class="star-rating">
                <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars"><i class="ph-fill ph-star"></i></label>
                <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars"><i class="ph-fill ph-star"></i></label>
                <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars"><i class="ph-fill ph-star"></i></label>
                <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars"><i class="ph-fill ph-star"></i></label>
                <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star"><i class="ph-fill ph-star"></i></label>
            </div>
            <textarea id="reviewText" class="input" placeholder="Votre commentaire..." style="min-height:60px;"></textarea>
            <button id="submitReviewBtn" class="btn" style="width:100%; font-size:13px;">Envoyer (Soumis à modération)</button>`;
            
            card.appendChild(formDiv);

            const reviewsContainer = document.createElement('div');
            reviewsContainer.className = 'reviews-container';
            
            try {
                const qRev = query(collection(db, "reviews"), where("approved", "==", true), orderBy("date", "desc"), limit(10));
                const snap = await getDocs(qRev);
                snap.forEach(doc => {
                    const r = doc.data();
                    let stars = "";
                    for(let i=0; i<5; i++) {
                        if(i < r.rating) stars += '<i class="ph-fill ph-star"></i>';
                        else stars += '<i class="ph-duotone ph-star"></i>';
                    }

                    const div = document.createElement('div');
                    div.className = 'review-card';
                    div.innerHTML = `
                        <div class="review-header">
                            <div><div class="review-name">${r.pseudo}</div><div class="review-stars" style="color:var(--gold)">${stars}</div></div>
                        </div>
                        <div class="review-text">${r.text}</div>
                    `;
                    reviewsContainer.insertBefore(div, reviewsContainer.firstChild);
                });
            } catch(e) { 
                console.log("Erreur avis", e); 
            }

            card.appendChild(reviewsContainer);
            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
            btnBack.style.marginTop = '20px'; btnBack.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
            card.appendChild(btnBack); app.appendChild(card);

            setTimeout(() => {
                const submitBtn = q('#submitReviewBtn');
                if(submitBtn){
                    submitBtn.onclick = async () => {
                        const text = q('#reviewText').value;
                        const ratingEl = document.querySelector('input[name="rating"]:checked');
                        if(!text || !ratingEl) return showAlert("Note et message requis", "error");
                        try {
                            await addDoc(collection(db, "reviews"), { 
                                pseudo: state.pseudo || "Anonyme", 
                                text, 
                                rating: parseInt(ratingEl.value), 
                                date: new Date(),
                                approved: false 
                            });
                            showAlert("Avis envoyé ! Il sera visible après validation.", "success"); 
                            
                            if(!state.progression.reviewDone) {
                                state.progression.reviewDone = true;
                                saveProgression();
                            }

                            q('#reviewText').value = ''; 
                        } catch(e) { showAlert("Erreur d'envoi", "error"); }
                    };
                }
            }, 100);
        }

        function renderContact() {
            setDocTitle("Nous Contacter");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2><i class="ph-duotone ph-envelope"></i> Nous Contacter</h2>`;
            const inputName = document.createElement('input'); inputName.className='input'; inputName.placeholder='Votre Nom';
            if(state.pseudo) inputName.value = state.pseudo;
            const inputEmail = document.createElement('input'); inputEmail.className='input'; inputEmail.placeholder='Votre Email';
            if(state.currentUser) inputEmail.value = state.currentUser.email;
            const inputText = document.createElement('textarea'); inputText.className='input'; inputText.placeholder='Votre message...';
            const btnSend = document.createElement('button'); btnSend.className='btn'; btnSend.textContent='Envoyer';
            btnSend.onclick = async () => {
                if(!inputText.value) return;
                try {
                    await addDoc(collection(db, "messages"), { name: inputName.value, email: inputEmail.value, message: inputText.value, date: new Date(), uid: state.currentUser ? state.currentUser.uid : 'guest' });
                    showAlert("Envoyé !", "success"); setTimeout(() => { if(state.pseudo) renderHome(); else renderLogin(); }, 1500);
                } catch(e) { showAlert("Erreur", "error"); }
            };
            const btnCancel = document.createElement('button'); btnCancel.className='link'; btnCancel.textContent='Annuler';
            btnCancel.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
            card.append(inputName, inputEmail, inputText, btnSend, btnCancel); app.appendChild(card);
        }
        
        function renderAbandonMenu() {
            setDocTitle("Abandon ?");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>Abandonner ?</h2><p class="small">Vous arrêtez le cas clinique en cours.</p>`;
            
            const btnHome = document.createElement('button'); btnHome.className='btn'; btnHome.innerHTML='<i class="ph-duotone ph-house"></i> Juste arrêter (Retour Accueil)';
            btnHome.onclick = renderHome;

            const divSearch = document.createElement('div');
            divSearch.style.marginTop = '20px'; divSearch.style.width = '100%';
            divSearch.innerHTML = `<p style="margin-bottom:10px; color:var(--accent);">Je pensais à une pathologie précise (C'était une erreur de l'IA) :</p>`;
            const select = document.createElement('select'); select.className = 'input';
            select.innerHTML = '<option value="">-- Choisir la pathologie --</option>';
            PATHOLOGIES.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
                select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
            select.onchange = () => {
                if(!select.value) return;
                const patho = PATHOLOGIES.find(p=>p.name === select.value);
                state.progression.incorrect++;
                saveProgression();
                showDiagnosticDetails({patho: patho}, true); 
            };
            divSearch.appendChild(select);

            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='Annuler, reprendre';
            btnBack.onclick = renderCurrentQuestion;

            card.append(btnHome, divSearch, btnBack);
            app.appendChild(card);
        }

        function renderProfile() {
            setDocTitle("Profil");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const card = document.createElement('div'); card.className='card center'; card.style.maxWidth = '800px';
            
            let contentHTML = `<h2>Profil de ${state.pseudo}</h2>`;
            
            const groupScores = {};
            let maxScore = 0; let bestGroup = null;
            Object.keys(prog.mastery || {}).forEach(pName => {
                const data = prog.mastery[pName];
                const count = (typeof data === 'number') ? data : (data.success || 0);
                if(count > 0) {
                    const group = PATHO_GROUPS[pName] || "Autre";
                    if(!groupScores[group]) groupScores[group] = 0;
                    groupScores[group] += count;
                    if(groupScores[group] > maxScore) { maxScore = groupScores[group]; bestGroup = group; }
                }
            });

            if(bestGroup && maxScore >= 3) {
                contentHTML += `<div class="specialty-badge"><i class="ph-duotone ph-medal"></i> Spécialiste ${bestGroup}</div>`;
            }

            const totalPathos = PATHOLOGIES.length;
            const unlockedPathos = Object.keys(prog.mastery || {}).filter(k => {
                const d = prog.mastery[k];
                const s = (typeof d === 'number') ? d : d.success;
                return s > 0;
            }).length;
            const percentage = totalPathos > 0 ? Math.round((unlockedPathos / totalPathos) * 100) : 0;
            
            contentHTML += `
                <div style="width:100%; background:rgba(125,125,125,0.1); border-radius:10px; height:10px; margin-bottom:5px; overflow:hidden;">
                    <div style="width:${percentage}%; background:var(--accent); height:100%;"></div>
                </div>
                <div class="small" style="margin-bottom:30px;">Progression globale : ${percentage}% (${unlockedPathos}/${totalPathos})</div>
            `;
            
            card.innerHTML = contentHTML;

            const btnAch = document.createElement('button'); 
            btnAch.className='btn'; 
            btnAch.style.background = 'var(--gold)'; 
            btnAch.style.color = 'black'; 
            btnAch.style.marginBottom = '20px';
            btnAch.innerHTML = '<i class="ph-duotone ph-trophy"></i> Voir mes Succès';
            btnAch.onclick = renderAchievementsPage;
            
            if(card.children.length > 0) {
                card.insertBefore(btnAch, card.children[1]);
            } else {
                card.appendChild(btnAch);
            }

            const errorTracker = document.createElement('div');
            errorTracker.className = 'error-tracker';
            errorTracker.innerHTML = `<h3 style="color:var(--error); font-size:16px;"><i class="ph-duotone ph-warning"></i> Boîte à Erreurs (Suivi)</h3>`;
            const now = Date.now();
            let hasErrors = false;
            Object.entries(prog.errorLog || {}).forEach(([pName, data]) => {
                if(now - data.date > 7 * 24 * 60 * 60 * 1000) {
                    hasErrors = true;
                    const item = document.createElement('div');
                    item.className = 'error-item';
                    item.innerHTML = `<span>${pName}</span> <span style="opacity:0.7">À revoir !</span>`;
                    errorTracker.appendChild(item);
                }
            });
            if(!hasErrors) errorTracker.innerHTML += `<div class="small">Aucune pathologie oubliée depuis 1 semaine. Bien joué !</div>`;
            card.appendChild(errorTracker);

            const globalMissedSigns = {};
            Object.values(prog.mastery || {}).forEach(m => {
                if(m.missedSigns) {
                    Object.entries(m.missedSigns).forEach(([sign, count]) => {
                        if(!globalMissedSigns[sign]) globalMissedSigns[sign] = 0;
                        globalMissedSigns[sign] += count;
                    });
                }
            });

            const frequentMisses = Object.entries(globalMissedSigns)
                .filter(([s, c]) => c >= 3)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if(frequentMisses.length > 0) {
                const weakDiv = document.createElement('div');
                weakDiv.style.marginTop = "20px";
                weakDiv.style.padding = "15px";
                weakDiv.style.background = "rgba(255, 77, 77, 0.05)";
                weakDiv.style.borderRadius = "12px";
                weakDiv.style.border = "1px solid rgba(255, 77, 77, 0.2)";
                
                let weakHTML = `<h3 style="color:var(--error); font-size:16px; margin-bottom:10px;"><i class="ph-duotone ph-trend-down"></i> Vos points faibles (Global)</h3>`;
                weakHTML += `<div class="small" style="margin-bottom:10px;">Signes cliniques souvent oubliés ou erronés :</div>`;
                weakHTML += `<ul style="text-align:left; padding-left:20px; color:var(--text-main);">`;
                
                frequentMisses.forEach(([sign, count]) => {
                    weakHTML += `<li style="margin-bottom:4px;"><strong>${formatSigneName(sign)}</strong> (${count} erreurs)</li>`;
                });
                
                weakHTML += `</ul>`;
                weakDiv.innerHTML = weakHTML;
                card.appendChild(weakDiv);
            }

            const masteryTitle = document.createElement('h3'); masteryTitle.innerHTML = 'Maitrise Clinique'; 
            masteryTitle.style.marginTop = "30px";
            card.appendChild(masteryTitle);

            const masteryGrid = document.createElement('div'); masteryGrid.className = 'mastery-grid';
            const sortedPathos = [...PATHOLOGIES].sort((a, b) => a.name.localeCompare(b.name));
            const masteryData = prog.mastery || {};

            sortedPathos.forEach(p => {
                const m = masteryData[p.name];
                const successCount = (typeof m === 'number') ? m : (m?.success || 0);
                const mItem = document.createElement('div');
                
                let sClass = 'm-locked', icon = '<i class="ph-duotone ph-lock-key"></i>';
                if (successCount >= 10) { sClass = 'm-master'; icon = '<i class="ph-duotone ph-diamond color-ruby"></i>'; }
                else if (successCount >= 5) { sClass = 'm-gold'; icon = '<i class="ph-duotone ph-trophy color-gold"></i>'; }
                else if (successCount >= 3) { sClass = 'm-silver'; icon = '<i class="ph-duotone ph-medal color-silver"></i>'; }
                else if (successCount >= 1) { sClass = 'm-bronze'; icon = '<i class="ph-duotone ph-medal color-bronze"></i>'; }

                mItem.className = `mastery-item ${sClass}`;
                mItem.innerHTML = `<div class="mastery-icon">${icon}</div><div class="mastery-name">${p.name}</div><div class="mastery-count">${successCount} réussite(s)</div>`;
                mItem.onclick = () => renderPathoStats(p); 
                masteryGrid.appendChild(mItem);
            });
            card.appendChild(masteryGrid);

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
            btnBack.style.marginTop='20px'; btnBack.onclick=renderHome;
            card.appendChild(btnBack); app.appendChild(card);
        }

        function renderAchievementsPage() {
            setDocTitle("Succès");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card center'; card.style.maxWidth = '800px';
            card.innerHTML = `<h2 style="color:var(--gold)"><i class="ph-duotone ph-trophy"></i> Mes Succès</h2>`;
            
            const prog = state.progression;
            
            const grid = document.createElement('div');
            grid.className = 'achievements-grid';

            ACHIEVEMENTS.forEach(ach => {
                const unlocked = (prog.achievements || []).includes(ach.id);
                const row = document.createElement('div');
                row.className = `achievement-row ${unlocked ? 'unlocked' : ''}`;
                
                const iconHtml = unlocked 
                    ? `<i class="${ach.iconClass} icon-md"></i>` 
                    : `<i class="ph-duotone ph-lock-key icon-md"></i>`;

                row.innerHTML = `
                    <div class="ach-icon">${iconHtml}</div>
                    <div class="ach-info">
                        <div class="ach-title" style="color:${unlocked ? 'var(--text-main)' : 'var(--text-muted)'}">${ach.title}</div>
                        <div class="ach-desc">${ach.desc}</div>
                    </div>
                `;
                grid.appendChild(row);
            });
            
            card.appendChild(grid);

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour au Profil';
            btnBack.style.marginTop = '20px';
            btnBack.onclick = renderProfile; 
            card.appendChild(btnBack);
            app.appendChild(card);
        }

        function renderLegalPage() {
            setDocTitle("Mentions Légales");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card center';
            
            const creditsHtml = `
                <h3 style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:15px;">4. Crédits Images</h3>
                <p style="font-size:0.9em; color:var(--text-muted); margin-bottom:10px;">
                    Les images médicales sont issues de banques d'images libres (Wikimedia Commons, Open-i, Wellcome Collection) sous licence Creative Commons (CC-BY, SA, ou Domaine Public).
                </p>
                
                <div style="text-align:left; font-size:0.8em; max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:15px; border-radius:8px; line-height:1.4;">
                    
                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Cardio & Vasculaire</strong>
                    <div>• <strong>st_elevation_ecg.png</strong> : Wikimedia Commons / Own work</div>
                    <div>• <strong>dvt_leg_swelling.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>hemoptysis_tissue.png</strong> : Wikimedia Commons / Dezidor</div>
                    <div>• <strong>cyanosis_lips.png</strong> : Wikimedia Commons / Thomas Godart</div>
                    <div>• <strong>livedo_reticularis.png</strong> : Wikimedia Commons / Uva L</div>
                    <div>• <strong>pale_leg_ischemia.png</strong> : Open-i / Park CB et al. (2014)</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Dermatologie : Rougeurs & Éruptions</strong>
                    <div>• <strong>erysipelas_leg.png</strong> : Wikimedia Commons / Grook Da Oger</div>
                    <div>• <strong>urticaria_hives.png</strong> : Wikimedia Commons / Verysmallkisses</div>
                    <div>• <strong>psoriasis_plaque.png</strong> : Wikimedia Commons / MediaJet</div>
                    <div>• <strong>eczema_flexural.png</strong> : Wikimedia Commons / Gzzz</div>
                    <div>• <strong>anaphylaxis_rash.png</strong> : Wikimedia Commons / מ.י.ש.הו 0</div>
                    <div>• <strong>erythema_migrans.png</strong> : Wikimedia Commons / BruceBlaus</div>
                    <div>• <strong>lupus_butterfly_rash.png</strong> : Wikimedia Commons / Doktorinternet</div>
                    <div>• <strong>cushing_striae.png</strong> : Wikimedia Commons / PanaromicTiger</div>
                    <div>• <strong>addison_hyperpigmentation.png</strong> : Wellcome Collection</div>
                    <div>• <strong>peau_d_orange_breast.png</strong> : Open-i / Nouh MA et al. (2011)</div>
                    <div>• <strong>shingles_zoster.png</strong> : Wikimedia Commons / N.M. Matheson</div>
                    <div>• <strong>chickenpox_rash.png</strong> : Open-i / Singh R, Xess I (2010)</div>
                    <div>• <strong>rubella_rash.png</strong> : Wikimedia Commons / CDC</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Dermatologie : Lésions & Tumeurs</strong>
                    <div>• <strong>severe_acne_face.png</strong> : Wikimedia Commons / Sedef94</div>
                    <div>• <strong>pcos_acne.png</strong> : Wikimedia Commons / Medical Photographic Library</div>
                    <div>• <strong>impetigo_crusts.png</strong> : Open-i / Lakshmi C. et al</div>
                    <div>• <strong>scabies_burrow.png</strong> : Open-i / Sugathan P. et al (2010)</div>
                    <div>• <strong>syphilis_chancre.png</strong> : Open-i / Burnett A (2014)</div>
                    <div>• <strong>melanoma.png</strong> : Wikimedia Commons / J.C.T. Braga et al.</div>
                    <div>• <strong>basal_cell_carcinoma.png</strong> : Open-i / Cureus</div>
                    <div>• <strong>hirsutism_face.png</strong> : Wikimedia Commons / Gacaferri Lumezi B et al.</div>
                    <div>• <strong>cervical_lymphadenopathy.png</strong> : Wikimedia Commons / Hudson Bernard</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Dermatologie : Sang </strong>
                    <div>• <strong>purpura_skin.png</strong> : Wikimedia Commons / Hektor</div>
                    <div>• <strong>janeway_lesions.png</strong> : Wikimedia Commons / Warfieldian</div>
                    <div>• <strong>henoch_schonlein_purpura.png</strong> : Wikimedia Commons / Diasbuenasio</div>
                    <div>• <strong>ecchymoses_petechiae.png</strong> : Wikimedia Commons / James Heilman, MD</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Visage & Cou</strong>
                    <div>• <strong>facial_droop.png</strong> : Wikimedia Commons / Another-anon-artist-234</div>
                    <div>• <strong>myxedema_face.png</strong> : Scientific Animations (Wiki)</div>
                    <div>• <strong>moon_face_cushing.png</strong> : Wikimedia Commons / Ozlem Celik et al.</div>
                    <div>• <strong>acromegaly_face.png</strong> : Wikimedia Commons / Philippe Chanson</div>
                    <div>• <strong>nuchal_rigidity_exam.png</strong> : Wikimedia Commons / L.A. Marty, M.D</div>
                    <div>• <strong>mumps_parotitis.png</strong> : Wikimedia Commons / Fischer, Louis (1914)</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Yeux (Ophtalmo)</strong>
                    <div>• <strong>conjunctivitis_red_eye.png</strong> : Wikimedia Commons / Tanalai</div>
                    <div>• <strong>scleral_icterus.png</strong> : Wikimedia Commons / Unknown author</div>
                    <div>• <strong>exophthalmos.png</strong> : Wikimedia Commons / CDC / Dr. Sellers</div>
                    <div>• <strong>fixed_dilated_pupil.png</strong> : Wikimedia Commons / Jonathan Trobe, M.D.</div>
                    <div>• <strong>stye_hordeolum.png</strong> : Wikimedia Commons / Andre Riemann</div>
                    <div>• <strong>ptosis_eye.png</strong> : Wikimedia Commons / Mohankumar Kurukumbi</div>
                    <div>• <strong>amsler_grid_distortion.png</strong> : Wikimedia Commons / Isislunsky</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Bouche & Gorge (ORL)</strong>
                    <div>• <strong>coated_tongue.png</strong> : Wikimedia Commons / Grook da oger</div>
                    <div>• <strong>strawberry_tongue.png</strong> : Wikimedia Commons / Martin Kronawitter</div>
                    <div>• <strong>atrophic_glossitis.png</strong> : Wikimedia Commons / Jihoon Kim et al.</div>
                    <div>• <strong>oral_thrush.png</strong> : Wikimedia Commons / Sol Silverman, Jr., D.D.S.</div>
                    <div>• <strong>tonsillar_exudate.png</strong> : Wikimedia Commons / Nick Berman</div>
                    <div>• <strong>mono_tonsils.png</strong> : Wikimedia Commons / Fateagued</div>
                    <div>• <strong>koplik_spots.png</strong> : Wikimedia Commons / Dctrzl</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Os & Articulations (Rhumato/Ortho)</strong>
                    <div>• <strong>colles_fracture_fork.png</strong> : Wikimedia Commons / Sylvain Letuffe</div>
                    <div>• <strong>hip_fracture_rotation.png</strong> : Wikimedia Commons / DocP</div>
                    <div>• <strong>leg_shortening.png</strong> : Wikimedia Commons / Fischer, Louis</div>
                    <div>• <strong>septic_arthritis_knee.png</strong> : Wikimedia Commons / CDC (NIH)</div>
                    <div>• <strong>gout_toe_podagra.png</strong> : Wikimedia Commons / Gonzosft</div>
                    <div>• <strong>dactylitis_toe.png</strong> : Wikimedia Commons / Graham, Edwin Eldon</div>
                    <div>• <strong>rheumatoid_hands.png</strong> : Wikimedia Commons / Dr. G. Narasimhamurthy</div>
                    <div>• <strong>hemarthrosis_knee.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>kyphosis_dowagers_hump.png</strong> : Wikimedia Commons / BruceBlaus</div>
                    <div>• <strong>ankle_sprain_swelling.png</strong> : Wikimedia Commons / James Heilman, MD</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Abdomen & Uro-Gyn</strong>
                    <div>• <strong>abdominal_distension.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>ascites_abdomen.png</strong> : Wikimedia Commons / Thomas Godart</div>
                    <div>• <strong>inguinal_hernia.png</strong> : Wikimedia Commons / IkeTheSloth</div>
                    <div>• <strong>bladder_distension.png</strong> : Wikimedia Commons / Treves & Hutchinson</div>
                    <div>• <strong>testicular_torsion_swelling.png</strong> : Wikimedia Commons / Javier.montero.arredondo</div>
                    <div>• <strong>anal_fistula.png</strong> : Open-i / Liaqat N. et al (2016)</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Liquides Biologiques</strong>
                    <div>• <strong>hematuria_urine.png</strong> : Wikimedia Commons / Own Work</div>
                    <div>• <strong>gross_hematuria.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>melena_stool.png</strong> : Wikimedia Commons / Ahmed Shawky Mohammedin</div>
                    <div>• <strong>bloody_stool.png</strong> : Wikimedia Commons / Togabi</div>
                    <div>• <strong>pitting_edema.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>currant_jelly_stool.png</strong> : EMNote / jackcfchong</div>

                    <strong style="color:var(--accent); display:block; margin-top:10px;"> Imagerie & ECG</strong>
                    <div>• <strong>pneumonia_xray.png</strong> : Wikimedia Commons / Unknown user</div>
                    <div>• <strong>pneumothorax_xray.png</strong> : Open-i / Omar HR et al. (2011)</div>
                    <div>• <strong>afib_ecg.png</strong> : CardioNetworks / Drj</div>
                    <div>• <strong>pericarditis_ecg.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>bowel_obstruction_xray.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>subdural_hematoma_ct.png</strong> : Wikimedia Commons / Lucien Monfils</div>
                    <div>• <strong>epidural_hematoma_ct.png</strong> : Wikimedia Commons / James Heilman, MD</div>
                    <div>• <strong>hip_fracture_xray.png</strong> : Wikimedia Commons / Drvaram</div>
                    <div>• <strong>wrist_fracture_xray.png</strong> : Wikimedia Commons / Lucien Monfils</div>
                    <div>• <strong>vertebral_compression_xray.png</strong> : Wikimedia Commons / Dirk69CS</div>
                    <div>• <strong>osteoarthritis_xray.png</strong> : Wikimedia Commons / Jmarchn</div>
                    <div>• <strong>gout_erosion_xray.png</strong> : Open-i / Perez-Ruiz F et al. (2009)</div>
                    <div>• <strong>herniated_disc_mri.png</strong> : Wikimedia Commons / Miguel Tremblay</div>
                </div>
            `;

            card.innerHTML = `
                <h2 style="color:var(--text-main); margin-bottom:15px;">Mentions Légales</h2>
                <div style="text-align:left; line-height:1.6;">
                    <h3>1. Éditeur du site</h3>
                    <p>Le site Medicome.fr est édité à titre personnel. <br>Contact : via le formulaire de contact du site.</p>
                    <br>
                    <h3>2. Hébergement</h3>
                    <p>Hébergé par GitHub Pages (USA). Données stockées sur Google Firebase (Irlande).</p>
                    <br>
                    <h3>3. Données Personnelles</h3>
                    <p>Email uniquement pour authentification. Aucune revente.</p>
                    ${creditsHtml}
                </div>
            `;
            
            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
            btnBack.style.marginTop = '20px';
            btnBack.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
            card.appendChild(btnBack);
            app.appendChild(card);
        }

        function renderPathoStats(patho) {
            setDocTitle(`Statistiques : ${patho.name}`);
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            const m = (state.progression.mastery || {})[patho.name];
            const wins = (typeof m === 'number') ? m : (m?.success || 0);
            const loss = (m?.failures || 0);
            const mistakes = (m?.missedSigns || {});
            const bestTime = (state.progression.bestTimes || {})[patho.name];

            let rank = 'Verrouillé', icon=`<i class="ph-duotone ph-lock-key icon-lg"></i>`, color='var(--text-muted)';
            if(wins >= 10) { rank='Maître'; icon=`<i class="ph-duotone ph-diamond icon-lg color-ruby"></i>`; color='var(--ruby)'; }
            else if(wins >= 5) { rank='Or'; icon=`<i class="ph-duotone ph-trophy icon-lg color-gold"></i>`; color='var(--gold)'; }
            else if(wins >= 3) { rank='Argent'; icon=`<i class="ph-duotone ph-medal icon-lg color-silver"></i>`; color='var(--silver)'; }
            else if(wins >= 1) { rank='Bronze'; icon=`<i class="ph-duotone ph-medal icon-lg color-bronze"></i>`; color='var(--bronze)'; }

            card.innerHTML = `
            <div style="font-size:40px; margin-bottom:10px; color:${color};">${icon}</div>
            <h3 style="color:${color}; margin-bottom:10px;">Rang : ${rank}</h3>
            ${bestTime ? `<div class="small" style="color:var(--accent); margin-bottom:20px;"><i class="ph-duotone ph-lightning"></i> Record Chrono : ${bestTime.toFixed(1)}s</div>` : ''}
            <h2>${patho.name}</h2>
            
            <div style="margin: 15px 0; max-width: 100%;">
            </div>

            <div class="patho-desc" style="margin-bottom:20px;">${patho.short}</div>
            
            <div style="display:flex; gap:15px; width:100%; margin-bottom:20px; justify-content:center;">
                <div class="stat-box" style="border-color:var(--success); max-width:150px;"><div class="stat-number" style="color:var(--success)">${wins}</div>Réussites</div>
                <div class="stat-box" style="border-color:var(--error); max-width:150px;"><div class="stat-number" style="color:var(--error)">${loss}</div>Erreurs</div>
            </div>`;

            if(Object.keys(mistakes).length > 0) {
                const missedRealSigns = []; 
                const wronglySelectedSigns = []; 

                Object.entries(mistakes).forEach(([sign, count]) => {
                    if(patho.signes[sign] && patho.signes[sign] > 0) {
                        missedRealSigns.push({sign, count, weight: patho.signes[sign]});
                    } else {
                        wronglySelectedSigns.push({sign, count});
                    }
                });

                const sortFn = (a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    return (b.weight || 0) - (a.weight || 0);
                };

                missedRealSigns.sort(sortFn);
                wronglySelectedSigns.sort((a,b) => b.count - a.count);

                let html = '<div style="text-align:left; width:100%; margin-top:15px;">';

                if(missedRealSigns.length > 0) {
                    html += `<h4 style="color:var(--error); margin-bottom:10px; border-bottom:1px solid rgba(255,77,77,0.3); padding-bottom:5px;">
                        <i class="ph-duotone ph-warning-circle"></i> Symptômes manqués (Oublis)
                    </h4>
                    <ul style="color:var(--text-muted); margin-bottom:20px;">`;
                    missedRealSigns.forEach(item => {
                        html += `<li style="margin-bottom:5px;">
                            <strong>${formatSigneName(item.sign)}</strong> 
                            <span style="opacity:0.6; font-size:0.9em;">(Oublié ${item.count} fois)</span>
                        </li>`;
                    });
                    html += '</ul>';
                }

                if(wronglySelectedSigns.length > 0) {
                    html += `<h4 style="color:#ff9f43; margin-bottom:10px; border-bottom:1px solid rgba(255,159,67,0.3); padding-bottom:5px;">
                        <i class="ph-duotone ph-prohibit"></i> Confusions (Signes ajoutés à tort)
                    </h4>
                    <ul style="color:var(--text-muted);">`;
                    wronglySelectedSigns.forEach(item => {
                        html += `<li style="margin-bottom:5px;">
                            <strong>${formatSigneName(item.sign)}</strong> 
                            <span style="opacity:0.6; font-size:0.9em;">(Erreur ${item.count} fois)</span>
                        </li>`;
                    });
                    html += '</ul>';
                }

                html += '</div>';
                card.innerHTML += html;
            }

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour Profil';
            btnBack.style.marginTop = '20px';
            btnBack.onclick=renderProfile;
            card.appendChild(btnBack); app.appendChild(card);
        }

        function renderDemographics() {
    setDocTitle("Paramètres Patient");
    window.scrollTo(0, 0);
    const app = q('#app');
    app.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'card center';

    // --- EN-TÊTE ---
    if (state.dailyTarget) {
        card.innerHTML = `<h3><i class="ph-duotone ph-sun color-gold"></i> Défi du Jour</h3><p class="small" style="margin-bottom:20px; color:var(--gold);">Cible : ${state.dailyTarget.name}</p>`;
    } else {
        card.innerHTML = `<h3 style="text-align:center; margin-bottom:15px;"><i class="ph-duotone ph-user-list"></i> Profil Patient</h3><p class="small" style="margin-bottom:20px">Définissez le terrain et le contexte clinique.</p>`;
    }

    // --- 1. IDENTITÉ (Sexe & Âge) ---
    const genderContainer = document.createElement('div');
    genderContainer.className = 'gender-selector';
    genderContainer.innerHTML = `
        <button class="gender-btn" id="btn-femme" onclick="selectGender('femme')" title="Femme"><i class="ph-duotone ph-gender-female"></i></button>
        <button class="gender-btn" id="btn-homme" onclick="selectGender('homme')" title="Homme"><i class="ph-duotone ph-gender-male"></i></button>
    `;
    card.appendChild(document.createElement('label')).textContent = "Identité";
    card.appendChild(genderContainer);

    let selectedGender = null;
    window.selectGender = (g) => {
        selectedGender = g;
        document.getElementById('btn-femme').className = `gender-btn ${g === 'femme' ? 'active' : ''}`;
        document.getElementById('btn-homme').className = `gender-btn ${g === 'homme' ? 'active' : ''}`;
        toggleGenderSpecificTags(g);
    };

    const sAge = document.createElement('select'); sAge.id = 'demo-age'; sAge.className = 'input';
    const ages = [
        { val: "nourrisson", txt: "Nourrisson (< 2 ans)" },
        { val: "enfant", txt: "Enfant (2 - 12 ans)" },
        { val: "adolescent", txt: "Adolescent (13 - 18 ans)" },
        { val: "jeune", txt: "Jeune Adulte (19 - 35 ans)" },
        { val: "adulte", txt: "Adulte (36 - 65 ans)" },
        { val: "senior", txt: "Senior (> 65 ans)" }
    ];
    ages.forEach(a => {
        const op = document.createElement('option'); op.value = a.val; op.textContent = a.txt;
        if (a.val === 'adulte') op.selected = true; 
        sAge.appendChild(op);
    });
    card.appendChild(sAge);

    // --- 3. TERRAIN & ANTÉCÉDENTS (Chips organisés) ---
    // On regroupe par logique clinique : Toxiques, Métabolique, Contexte aigu...
    
    const chipsDiv = document.createElement('div');
    chipsDiv.className = 'chips-container';

    // Définition des groupes pour l'affichage (Purement visuel)
    const groups = [
        {
            title: "Habitudes & Métabolisme",
            items: [
                { id: 'tabac', label: 'Tabac', icon: 'ph-cigarette' },
                { id: 'alcool', label: 'Alcool', icon: 'ph-beer-bottle' },
                { id: 'surpoids', label: 'Surpoids / Obésité', icon: 'ph-hamburger' },
                { id: 'metabolique', label: 'Diabète / HTA', icon: 'ph-heart-break' } // Regroupement intelligent
            ]
        },
        {
            title: "Contexte Aigu / Déclencheur",
            items: [
                { id: 'trauma', label: 'Chute / Trauma / Effort', icon: 'ph-bone' }, // Couvre Fracture, IDM, Entorse...
                { id: 'chirurgie', label: 'Chirurgie / Alité', icon: 'ph-bed' }, // Couvre Embolie
                { id: 'voyage', label: 'Voyage / Plein Air', icon: 'ph-airplane' }, // Couvre Palu, Lyme, Tétanos
                { id: 'medicaments', label: 'Médicaments / Allergie', icon: 'ph-pill' } // Couvre Choc, AINS, Anticoag...
            ]
        },
        {
            title: "Terrain Fragile",
            items: [
                { id: 'immuno', label: 'Cancer / Immuno.', icon: 'ph-ribbon' }, // Couvre ID, Cancer, Corticoïdes
                { id: 'psy', label: 'Contexte Psy / Stress', icon: 'ph-brain' }, // Couvre Panique, TCA
                { id: 'hiver', label: 'Hiver / Épidémie', icon: 'ph-snowflake' } // Couvre Grippe, Bronchio
            ]
        },
        {
            title: "Gynécologie",
            genderSpecific: 'femme', // Sera caché si Homme
            items: [
                { id: 'grossesse', label: 'Grossesse', icon: 'ph-baby' },
                { id: 'sterilet', label: 'Stérilet', icon: 'ph-anchor' },
                { id: 'menopause', label: 'Ménopause', icon: 'ph-hourglass' }
            ]
        }
    ];

    const selectedFactors = new Set();

    groups.forEach(group => {
        // Création du titre de section (ex: HABITUDES)
        const label = document.createElement('div');
        label.className = 'section-label';
        label.textContent = group.title;
        if(group.genderSpecific) label.id = `label-${group.genderSpecific}`; // Pour le cacher
        chipsDiv.appendChild(label);

        // Création des chips
        group.items.forEach(f => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.id = `chip-${f.id}`;
            chip.innerHTML = `<i class="ph-duotone ${f.icon}"></i> ${f.label}`;
            if (group.genderSpecific) chip.dataset.gender = group.genderSpecific;

            chip.onclick = () => {
                if (selectedFactors.has(f.id)) {
                    selectedFactors.delete(f.id);
                    chip.classList.remove('selected');
                } else {
                    selectedFactors.add(f.id);
                    chip.classList.add('selected');
                }
            };
            chipsDiv.appendChild(chip);
        });
    });
    card.appendChild(chipsDiv);

    // Fonction de gestion d'affichage Homme/Femme
    window.toggleGenderSpecificTags = (g) => {
        // Gérer les titres de sections
        const labelFemme = document.getElementById('label-femme');
        if(labelFemme) labelFemme.style.display = (g === 'femme') ? 'block' : 'none';

        // Gérer les chips
        const chips = document.querySelectorAll('[data-gender="femme"]');
        chips.forEach(c => {
            if (g === 'femme') c.style.display = 'flex';
            else {
                c.style.display = 'none';
                c.classList.remove('selected');
                selectedFactors.delete(c.id.replace('chip-', ''));
            }
        });
    };
    
    // Initialisation
    toggleGenderSpecificTags(null); 

    // --- 4. CHRONO ---
    if (!state.dailyTarget) {
        const chronoDiv = document.createElement('div');
        chronoDiv.style.margin = '10px 0 20px 0'; chronoDiv.style.textAlign = 'center';
        chronoDiv.innerHTML = `<label style="cursor:pointer; color:var(--text-muted); font-size:13px;"><input type="checkbox" id="chronoToggle" style="margin-right:6px; vertical-align:middle;"> <i class="ph-duotone ph-lightning"></i> Mode Chrono</label>`;
        card.appendChild(chronoDiv);
    }

    // --- BOUTONS ---
    const btnGroup = document.createElement('div'); btnGroup.className = 'button-group';
    const btnStart = document.createElement('button'); btnStart.className = 'btn'; btnStart.innerHTML = '<i class="ph-duotone ph-play"></i> Lancer le cas';
    
    btnStart.onclick = () => {
        if (!selectedGender && !state.dailyTarget) { 
             if(Math.random() > 0.5) selectedGender = 'femme'; else selectedGender = 'homme';
        }

        const ageVal = q('#demo-age').value;
        const demoData = {
            homme: selectedGender === 'homme',
            femme: selectedGender === 'femme',
            nourrisson: ageVal === 'nourrisson',
            enfant: ageVal === 'enfant',
            adolescent: ageVal === 'adolescent',
            jeune: ageVal === 'jeune' || ageVal === 'adolescent',
            plus_de_30ans: ageVal === 'adulte' || ageVal === 'senior',
            plus_de_65ans: ageVal === 'senior',
            adulte: ageVal === 'adulte'
        };

        // --- MAPPING INTELLIGENT --- 
        // C'est ici que la magie opère pour traduire les boutons "Cliniques" en facteurs JSON précis
        
        // 1. Bouton "Diabète / HTA"
        if(selectedFactors.has('metabolique')) {
            demoData['diabete'] = true;
            demoData['hta'] = true;
            demoData['dyslipidemie'] = true; // Souvent associé
            // Bonus : HTA est un facteur de risque cardiovasculaire majeur
            demoData['fibrillation_atriale'] = true; 
            demoData['insuffisance_cardiaque'] = true;
        }

        // 2. Bouton "Chute / Trauma / Effort"
        if(selectedFactors.has('trauma')) {
            demoData['chute'] = true; 
            demoData['chute_main'] = true; // Pouteau-Colles
            demoData['traumatisme_cranien'] = true; // Hématomes
            demoData['effort'] = true; // Infarctus, Hernie discal
            demoData['sport'] = true; // Entorse
            demoData['frottement_yeux'] = true; // Orgelet (Trauma mineur)
        }

        // 3. Bouton "Chirurgie / Alité"
        if(selectedFactors.has('chirurgie')) {
            demoData['chirurgie_recente'] = true;
            demoData['chirurgie_abdominale'] = true; // Occlusion
            demoData['alitement'] = true; // Phlébite
            demoData['chirurgie_cataracte'] = true; // Décollement rétine
        }

        // 4. Bouton "Voyage / Plein Air"
        if(selectedFactors.has('voyage')) {
            demoData['voyage_recent'] = true; // Palu
            demoData['foret'] = true; // Lyme
            demoData['jardinage'] = true; // Tétanos
        }

        // 5. Bouton "Médicaments / Allergies"
        if(selectedFactors.has('medicaments')) {
            demoData['medicaments'] = true;
            demoData['allergie_connue'] = true; // Choc
            demoData['allergies'] = true; // Asthme
            demoData['ains'] = true; // Ulcère
            demoData['anticoagulants'] = true; // Saignements
            demoData['antibiotiques_recents'] = true; // Mycose / Muguet
        }

        // 6. Bouton "Cancer / Immuno"
        if(selectedFactors.has('immuno')) {
            demoData['cancer'] = true;
            demoData['immunodepression'] = true; // Pneumopathie, Zona
            demoData['auto_immun'] = true; // Lupus, Biermer
            demoData['corticoides'] = true; // Cushing, Cataracte
        }

        // 7. Bouton "Psy / Stress"
        if(selectedFactors.has('psy')) {
            demoData['stress'] = true;
            demoData['depression'] = true;
            demoData['perfectionnisme'] = true; // Anorexie
        }

        // 8. Bouton "Hiver / Épidémie"
        if(selectedFactors.has('hiver')) {
            demoData['hiver'] = true;
            demoData['epidemie'] = true; // Grippe
            demoData['contage'] = true; // Maladies infantiles
            demoData['collectivite'] = true; // Gastro
            demoData['entourage_malade'] = true; // Méningite
        }

        // Mapping direct des boutons simples
        ['tabac', 'alcool', 'surpoids', 'atcd_famille', 'grossesse', 'sterilet', 'menopause'].forEach(id => {
            if(selectedFactors.has(id)) demoData[id] = true;
        });

        // 9. Facteurs implicites (Jeune = Risque IST souvent)
        if(demoData['jeune'] || demoData['adolescent']) {
            demoData['rapport_risque'] = true;
            demoData['partenaires_multiples'] = true;
        }

        // --- LANCEMENT ---
        state.demo = demoData;
        state.answers = {}; state.asked = []; state.diagnosticShown = false; state.previousDiagnostics = []; state.history = [];
        state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
        state.priorityQueue = [];

        if (state.dailyTarget) state.isChrono = false;
        else state.isChrono = q('#chronoToggle')?.checked || false;

        if (state.isChrono) state.startTime = Date.now();
        else state.startTime = null;

        askNextQuestion();
    };

    const btnCancel = document.createElement('button'); btnCancel.className = 'link'; btnCancel.textContent = 'Annuler'; btnCancel.onclick = renderHome;
    btnGroup.appendChild(btnStart); btnGroup.appendChild(btnCancel); card.appendChild(btnGroup); app.appendChild(card);
}

        function prepareSigns() {
            let allSignsSet = new Set();
            PATHOLOGIES.forEach(p => { Object.keys(p.signes).forEach(s => allSignsSet.add(s)); });
            state.allSigns = Array.from(allSignsSet);
        }

        function rankPathologies() {
            const scores = PATHOLOGIES.map(p => {
                if (state.previousDiagnostics.includes(p.name)) {
                    return { patho: p, score: -1 }; 
                }

                let score = 0;
                for(const facteur in p.facteurs){ if(state.demo[facteur] === true) score += p.facteurs[facteur]; }
                for(const signe in p.signes){
                    const ans = state.answers[signe];
                    if(ans === true) score += p.signes[signe];
                    else if(ans === false) score -= (p.signes[signe] * 0.5);
                }
                return {patho:p, score: Math.max(0, score)};
            });

            const validScores = scores.filter(s => s.score >= 0);
            const totalScore = validScores.reduce((sum, s) => sum + s.score, 0);

            state.ranked = scores.map(s => ({
                ...s,
                prob: (s.score === -1 || totalScore === 0) ? 0 : ((s.score / totalScore) * 100).toFixed(1)
            })).sort((a,b)=>b.prob - a.prob);
        }

        function getNextSmartSign(ranked, remainingSigns) {
            const topPathos = ranked.slice(0, 5).map(r => r.patho);
            
            // Liste des signes à "garder pour la fin" (Examens complémentaires)
            const examSigns = new Set();
            
            // Mots-clés pour identifier les examens si le poids ne suffit pas
            const examKeywords = ['radio', 'scanner', 'irm', 'ecg', 'biologie', 'analyse', 'echographie'];

            topPathos.forEach(p => {
                for (const [s, weight] of Object.entries(p.signes)) {
                    // CRITÈRE : Poids lourd (>=40) ET (a une image OU contient un mot clé d'examen)
                    // Cela laisse passer les signes cliniques forts (ex: poids 30)
                    const isExamKeyword = examKeywords.some(k => s.includes(k));
                    const hasImage = p.images && p.images[s];
                    
                    if (weight >= 40 && (hasImage || isExamKeyword)) {
                        examSigns.add(s);
                    }
                }
            });

            // On crée un pool "Clinique" (tout sauf les examens complémentaires)
            let clinicalPool = remainingSigns.filter(s => !examSigns.has(s));

            // Si on a encore des questions cliniques, on les priorise.
            // Sinon (si on a tout épuisé), on sort les radios/scanners.
            let pool = clinicalPool.length > 0 ? clinicalPool : remainingSigns;

            const signCounts = {};
            topPathos.forEach(p => {
                pool.forEach(s => {
                    if (p.signes[s]) {
                        signCounts[s] = (signCounts[s] || 0) + (p.signes[s] || 1);
                    }
                });
            });

            let bestSign = pool[0];
            let maxVal = -1;

            for (const [s, val] of Object.entries(signCounts)) {
                if (val > maxVal) {
                    maxVal = val;
                    bestSign = s;
                }
            }
            
            if (!bestSign && pool.length > 0) return pool[Math.floor(Math.random() * pool.length)];
            
            return bestSign;
        }

        function canShowDiagnostic() {
            const qNum = state.asked.length;
            
            // --- FIX PLAISANTIN DEBUT ---
            // Si le joueur est en train de tenter l'Easter Egg (moins de 15 questions)
            // On empêche l'IA de conclure, même si elle est sûre d'elle.
            if (qNum < 15 && qNum > 0) {
                // Vérifie si on a que des "Vrai" jusqu'à présent
                const allYes = state.asked.every(s => state.answers[s] === true);
                // Vérifie si on a que des "Faux" jusqu'à présent
                const allNo = state.asked.every(s => state.answers[s] === false);
                
                // Si on est dans une série parfaite, on force le jeu à continuer
                if (allYes || allNo) return false; 
            }
            // --- FIX PLAISANTIN FIN ---

            if(state.ranked.length===0) return false;
            
            const top1 = state.ranked[0];
            const top2 = state.ranked[1];
            
            if(state.previousDiagnostics.includes(top1.patho.name)) return false;

            if (qNum >= 20) return true;

            const score1 = parseFloat(top1.prob);
            if (!top2) return score1 > 40; 

            const score2 = parseFloat(top2.prob);
            const gap = score1 - score2;

            if (qNum >= 5 && score1 >= 50 && gap >= 20) return true;
            if (qNum >= 10 && gap >= 10) return true;
            if (qNum >= 15) return true;

            return false;
        }

        function prepareConfirmationQuestions(topPatho) {
            const pSigns = Object.keys(topPatho.signes);
            const unaskedCorrect = pSigns.filter(s => !state.asked.includes(s));

            // 1. Identifier l'examen complémentaire (La "Preuve" / Boss Final)
            let proofSign = unaskedCorrect.find(s => topPatho.signes[s] >= 40);

            // 2. Préparer le pool de signes CORRECTS restants (sans la preuve)
            let poolCorrect = unaskedCorrect.filter(s => s !== proofSign);
            poolCorrect.sort(() => 0.5 - Math.random());

            // 3. Préparer le pool de signes PIÈGES (Diagnostic Différentiel)
            // On va chercher les signes des pathologies classées 2, 3, 4 et 5
            let differentialSigns = new Set();
            // On limite la recherche aux 5 premiers résultats max
            const maxRank = Math.min(state.ranked.length, 5); 

            for (let i = 1; i < maxRank; i++) {
                if (state.ranked[i]) {
                    const competitorPatho = state.ranked[i].patho;
                    Object.keys(competitorPatho.signes).forEach(s => {
                        // On ajoute le signe SI :
                        // - Il n'appartient PAS à la maladie correcte (sinon ce n'est pas un piège)
                        // - Il n'a pas déjà été posé
                        if (!pSigns.includes(s) && !state.asked.includes(s)) {
                            differentialSigns.add(s);
                        }
                    });
                }
            }

            let poolTraps = Array.from(differentialSigns);
            poolTraps.sort(() => 0.5 - Math.random()); // Mélanger les pièges pertinents

            // FALLBACK : Si pas assez de pièges pertinents (cas rare), on complète avec du hasard
            if (poolTraps.length < 3) {
                const randomTraps = state.allSigns.filter(s => 
                    !pSigns.includes(s) && !state.asked.includes(s) && !poolTraps.includes(s)
                );
                randomTraps.sort(() => 0.5 - Math.random());
                poolTraps = [...poolTraps, ...randomTraps];
            }

            // 4. Construction de la file d'attente avec RATIO ALÉATOIRE
            // On choisit une longueur de séquence entre 3 et 5 questions (hors preuve)
            const sequenceLength = Math.floor(Math.random() * 3) + 3; // 3, 4 ou 5
            let queue = [];

            // Remplissage aléatoire des slots
            for (let i = 0; i < sequenceLength; i++) {
                // 50% de chance de vouloir un signe correct, 50% un piège
                const wantCorrect = Math.random() > 0.5;

                if (wantCorrect && poolCorrect.length > 0) {
                    queue.push(poolCorrect.shift());
                } else if (poolTraps.length > 0) {
                    queue.push(poolTraps.shift());
                } else if (poolCorrect.length > 0) {
                    // Si on voulait un piège mais qu'il n'y en a plus, on met un correct
                    queue.push(poolCorrect.shift());
                } else {
                    // Plus de questions dispo
                    break;
                }
            }

            // 5. Sécurité Anti-Pattern
            // On s'assure qu'il y a au moins 1 vrai et 1 faux dans le lot (si possible)
            // pour ne pas avoir une série de 5 "NON" ou 5 "OUI" trop évidente
            const hasCorrect = queue.some(s => pSigns.includes(s));
            const hasTrap = queue.some(s => !pSigns.includes(s));

            if (!hasCorrect && poolCorrect.length > 0 && queue.length > 0) {
                queue[0] = poolCorrect.shift(); // On force un vrai
            }
            if (!hasTrap && poolTraps.length > 0 && queue.length > 0) {
                queue[queue.length - 1] = poolTraps.shift(); // On force un faux
            }

            // 6. Mélanger la file d'attente finale
            queue.sort(() => 0.5 - Math.random());

            // 7. Ajouter la PREUVE à la toute fin
            if (proofSign) {
                queue.push(proofSign);
            } else if (poolCorrect.length > 0) {
                // Si pas de preuve absolue, on met un dernier signe correct pour valider
                queue.push(poolCorrect.shift());
            }

            return queue;
        }

        // --- FONCTIONS "PLAISANTIN" (Easter Eggs) ---
        function checkPlaisantin() {
            // On ne vérifie qu'exactement à la 15ème question
            if (state.asked.length !== 15) return false;

            // Vérifier si toutes les réponses sont NON
            const allNo = state.asked.every(sign => state.answers[sign] === false);
            if (allNo) {
                renderPlaisantinEnd("healthy");
                return true; // On stoppe le jeu
            }

            // Vérifier si toutes les réponses sont OUI
            const allYes = state.asked.every(sign => state.answers[sign] === true);
            if (allYes) {
                renderPlaisantinEnd("hypochondriac");
                return true; // On stoppe le jeu
            }

            return false; // On continue le jeu normalement
        }

        function renderPlaisantinEnd(type) {
            setDocTitle("Diagnostic Surprise");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className = 'card center';
            
            // On joue un petit son si possible
            playSound(type === "healthy" ? 'success' : 'error');

            if (type === "healthy") {
                // Cas : 15 NON d'affilée
                card.innerHTML = `
                    <div class="icon-lg color-success"><i class="ph-duotone ph-person-simple-walk"></i></div>
                    <h2 style="color:var(--success)">Diagnostic : Touriste !</h2>
                    <p style="margin-top:15px; font-weight:bold;">Ce patient n'a RIEN.</p>
                    <p class="small" style="margin-top:10px; line-height:1.6;">
                        Après 15 questions négatives, il semblerait que ce patient se soit juste perdu dans l'hôpital en cherchant la machine à café.<br>
                        Rentrez chez vous, vous êtes en parfaite santé !
                    </p>
                `;
            } else {
                // Cas : 15 OUI d'affilée
                card.innerHTML = `
                    <div class="icon-lg color-ruby"><i class="ph-duotone ph-mask-happy"></i></div>
                    <h2 style="color:var(--ruby)">Diagnostic : Malade Imaginaire</h2>
                    <p style="margin-top:15px; font-weight:bold;">Syndrome de l'Hypocondriaque Massif</p>
                    <p class="small" style="margin-top:10px; line-height:1.6;">
                        Le patient a TOUS les symptômes. Statistiquement, il devrait avoir explosé il y a 10 minutes.<br>
                        Appelez Dr House, ou un psychiatre, c'est au choix.
                    </p>
                `;
            }

            const btn = document.createElement('button');
            btn.className = 'btn'; 
            btn.innerHTML = '<i class="ph-duotone ph-arrow-counter-clockwise"></i> Recommencer sérieusement';
            btn.style.marginTop = "20px";
            btn.onclick = () => { 
                state.dailyTarget = null; 
                renderDemographics(); 
            };
            
            card.appendChild(btn);
            app.appendChild(card);
        }

        function renderCurrentQuestion() {
            setDocTitle(`Question ${state.asked.length}`);
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            const signe = state.currentSign;
            const questionTitle = state.confirmationMode ? `<span style="color:var(--gold)"><i class="ph-duotone ph-brain"></i> Je pense avoir une piste...</span>` : `QUESTION ${state.asked.length}`;
            
            let prob = 0;
            if(state.ranked.length > 0) prob = parseFloat(state.ranked[0].prob);

            // --- IMAGE DISPLAY LOGIC ---
            const imgUrl = GLOBAL_IMG_MAP[signe];
            const imgHTML = imgUrl ? `<img src="${imgUrl}" style="max-width:100%; height:auto; max-height:300px; border-radius:8px; margin-bottom:15px; border:1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0,0,0,0.3);">` : '';

            card.innerHTML = `
                ${state.isChrono ? '<div style="font-size:12px; color:var(--accent); margin-bottom:5px;"><i class="ph-duotone ph-lightning"></i> Chrono Actif</div>' : ''}
                <div class="ai-progress-container">
                    <div class="ai-progress-bar" style="width:${prob}%"></div>
                </div>
                <div class="ai-progress-label">Confiance IA : ${prob}%</div>
                
                <div class="small" style="margin-bottom:12px; color:var(--accent)">${questionTitle}</div>
                
                ${imgHTML}

                <div class="question-text">Le patient présente-t-il :<br><strong style="font-size:1.2em; color:var(--text-main);">${formatSigneName(signe)}</strong> ?</div>`;
            
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            
            const mkBtn = (txt, cls, val) => {
                const b = document.createElement('button'); b.className=cls; b.innerHTML=txt;
                b.onclick=()=>{ 
                    state.history.push(JSON.stringify({
                        answers: state.answers, asked: state.asked, currentSign: state.currentSign,
                        confirmationMode: state.confirmationMode, confirmationQueue: state.confirmationQueue,
                        confirmedPatho: state.confirmedPatho, priorityQueue: state.priorityQueue,
                        isChrono: state.isChrono, startTime: state.startTime, dailyTarget: state.dailyTarget
                    }));
                    
                    if(state.dailyTarget && val === false && state.dailyTarget.signes[signe]) {
                    }
                    
                    state.answers[signe]=val; askNextQuestion(); 
                };
                btnGroup.appendChild(b);
            };
            mkBtn('<i class="ph-bold ph-check"></i> OUI', 'btn btn-success', true);
            mkBtn('<i class="ph-bold ph-x"></i> NON', 'btn btn-error', false);
            mkBtn('Je ne sais pas', 'link', null);
            card.appendChild(btnGroup);

            const navGroup = document.createElement('div'); navGroup.style.display = 'flex'; navGroup.style.gap = '15px'; navGroup.style.marginTop = '20px';
            if(state.history.length > 0) {
                const btnBack = document.createElement('button'); btnBack.className='btn-back'; btnBack.innerHTML='<i class="ph-duotone ph-caret-left"></i> Retour';
                btnBack.onclick = () => {
                    const prevState = JSON.parse(state.history.pop());
                    Object.assign(state, prevState);
                    renderCurrentQuestion();
                };
                navGroup.appendChild(btnBack);
            }
            const btnAb = document.createElement('button'); btnAb.className='link'; btnAb.innerHTML='Abandonner'; btnAb.onclick=renderAbandonMenu;
            navGroup.appendChild(btnAb); card.appendChild(navGroup);
            app.appendChild(card);
        }

        function askNextQuestion() {
            // --- VERIFICATION PLAISANTIN ---
            if (checkPlaisantin()) return; 
            // -------------------------------

            if (state.asked.length >= 20) { showDiagnostic(); return; }

            if(state.asked.length > 0) {
                const lastSign = state.asked[state.asked.length - 1];
                const lastAnswer = state.answers[lastSign];
                
                if(lastAnswer === true) {
                      for (const [parent, children] of Object.entries(REFINEMENTS)) {
                        if (children.includes(lastSign)) {
                            const siblings = children.filter(c => c !== lastSign);
                            state.priorityQueue = state.priorityQueue.filter(q => !siblings.includes(q));
                        }
                    }
                }
            }

            if(state.priorityQueue.length > 0) {
                const nextPriority = state.priorityQueue.shift();
                if(!state.asked.includes(nextPriority)) {
                    state.currentSign = nextPriority; state.asked.push(nextPriority); renderCurrentQuestion(); return;
                } else { askNextQuestion(); return; }
            }

            if (state.confirmationMode) {
                const lastSign = state.asked[state.asked.length - 1];
                
                const isSignPartOfPatho = Object.keys(state.confirmedPatho.signes).includes(lastSign);
                const userSaidYes = state.answers[lastSign] === true;

                if (!isSignPartOfPatho && userSaidYes) {
                    state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
                    showAlert("Aïe ! Ce symptôme ne collait pas...", "error");
                    askNextQuestion(); return;
                }

                if (isSignPartOfPatho && !userSaidYes) {
                    state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
                    showAlert("Ah, fausse piste. Je continue à chercher...", "info");
                    askNextQuestion(); return;
                }

                if (state.confirmationQueue.length > 0) {
                    const nextC = state.confirmationQueue.shift();
                    state.currentSign = nextC; state.asked.push(nextC); renderCurrentQuestion(); return;
                } else { 
                    showDiagnostic(); return; 
                }
            }

            prepareSigns();
            const remaining = state.allSigns.filter(s => !state.asked.includes(s));
            if(remaining.length === 0) { showDiagnostic(); return; }

            const hasSymptom = Object.keys(state.answers).some(key => state.answers[key] === true);
            if (!hasSymptom) {
                const generalSigns = remaining.filter(s => REFINEMENTS.hasOwnProperty(s));
                const pool = generalSigns.length > 0 ? generalSigns : remaining;
                const randomSign = pool[Math.floor(Math.random() * pool.length)];
                state.currentSign = randomSign; state.asked.push(randomSign); renderCurrentQuestion(); return;
            }

            rankPathologies(); 
            if(canShowDiagnostic()){ 
                const topPatho = state.ranked[0].patho;
                const confirmQuestions = prepareConfirmationQuestions(topPatho);
                if (confirmQuestions.length > 0) {
                    state.confirmationMode = true; state.confirmedPatho = topPatho; state.confirmationQueue = confirmQuestions;
                    const first = state.confirmationQueue.shift();
                    state.currentSign = first; state.asked.push(first); renderCurrentQuestion(); return;
                } else { showDiagnostic(); return; }
            }
            
            const signe = getNextSmartSign(state.ranked, remaining);
            state.currentSign = signe; state.asked.push(signe); renderCurrentQuestion();
        }

        function showDiagnostic() {
            setDocTitle("Analyse...");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML = '';
            const loadingCard = document.createElement('div'); loadingCard.className = 'card center';
            loadingCard.innerHTML = `<h3 style="color:var(--accent)"><i class="ph-duotone ph-magnifying-glass"></i> Analyse IA en cours...</h3><div style="margin: 30px 0; font-size: 50px; animation: spin 0.8s infinite linear;"><i class="ph-duotone ph-gear"></i></div><p class="small">Comparaison base de données...</p>`;
            app.appendChild(loadingCard);

            setTimeout(() => {
                rankPathologies();
                const top = state.ranked[0];
                state.diagnosticShown = true;
                state.previousDiagnostics.push(top.patho.name);
                setDocTitle(`Diagnostic : ${top.patho.name}`);

                app.innerHTML = ''; 
                const card = document.createElement('div'); card.className='card center';
                const title = document.createElement('h2'); title.innerHTML='<i class="ph-duotone ph-lightbulb"></i> Diagnostic Proposé'; card.appendChild(title);
                
                let pdfButton = top.patho.pdf && top.patho.pdf !== '#' ? `<a class="link" style="color:var(--accent); border-color:var(--accent); display:inline-block; margin-top:10px;" href="${top.patho.pdf}" target="_blank"><i class="ph-duotone ph-file-pdf"></i> Voir fiche PDF</a>` : `<span class="small" style="opacity:0.5"><i class="ph-duotone ph-file-x"></i> Pas de fiche PDF</span>`;
                
                const diagDiv = document.createElement('div'); diagDiv.className='diagnostic-result';
                diagDiv.innerHTML = `<div class="diagnostic-name">${top.patho.name}</div>
                <div style="margin: 15px 0; max-width: 100%;">
                </div>
                <div class="patho-desc" style="margin-top:8px">${top.patho.short}</div><br>${pdfButton}`;
                card.appendChild(diagDiv);
                
                const btnGroup = document.createElement('div'); btnGroup.className='button-group';
                
                const btnTrue = document.createElement('button'); btnTrue.className='btn btn-success'; btnTrue.innerHTML='<i class="ph-bold ph-check"></i> Correct';
                btnTrue.onclick = async () => { 
                    triggerConfetti(); playSound('success');
                    state.progression.correct++; state.progression.streak = (state.progression.streak || 0) + 1;
                    
                    if(state.dailyTarget && state.dailyTarget.name === top.patho.name) {
                        const today = new Date().toDateString();
                        if(state.progression.lastDaily !== today) {
                            state.progression.lastDaily = today;
                            state.progression.dailyStreak = (state.progression.dailyStreak || 0) + 1;
                            showAlert(`<i class="ph-duotone ph-party-popper"></i> Défi du jour réussi ! Série : ${state.progression.dailyStreak}`, "success");
                        }
                    }

                    if(!state.progression.mastery) state.progression.mastery = {};
                    const pName = top.patho.name;
                    let m = state.progression.mastery[pName];
                    if(!m) m = { success: 0, failures: 0, missedSigns: {} };
                    if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                    
                    m.success++;
                    
                    if(state.isChrono && state.startTime) {
                        const duration = (Date.now() - state.startTime) / 1000;
                        if(duration < 30) {
                            state.progression.speedWins = (state.progression.speedWins || 0) + 1;
                        }
                        if(!state.progression.bestTimes) state.progression.bestTimes = {};
                        if(!state.progression.bestTimes[pName] || duration < state.progression.bestTimes[pName]) {
                            state.progression.bestTimes[pName] = duration;
                            showAlert(`<i class="ph-duotone ph-lightning"></i> Nouveau Record : ${duration.toFixed(1)}s`, 'info');
                        }
                    }

                    Object.keys(top.patho.signes).forEach(s => {
                        if(state.answers[s] === false || state.answers[s] === null) { 
                            if(!m.missedSigns[s]) m.missedSigns[s] = 0;
                            m.missedSigns[s]++;
                        }
                    });
                    
                    Object.keys(state.answers).forEach(s => {
                        if (state.answers[s] === true && !top.patho.signes[s]) {
                            if(!m.missedSigns[s]) m.missedSigns[s] = 0;
                            m.missedSigns[s]++;
                        }
                    });

                    state.progression.mastery[pName] = m;
                    
                    updateHeader(); await saveProgression(); 
                    showAlert('<i class="ph-duotone ph-check-circle"></i> Diagnostic validé !','success'); showDiagnosticDetails({patho: top.patho});
                };
                
                const btnFalse = document.createElement('button'); btnFalse.className='btn btn-error'; btnFalse.innerHTML='<i class="ph-bold ph-x"></i> Incorrect';
                btnFalse.onclick = async () => { 
                    playSound('error');
                    state.progression.incorrect++; state.progression.streak = 0;
                    
                    if(!state.progression.mastery) state.progression.mastery = {};
                    const pName = top.patho.name;
                    let m = state.progression.mastery[pName];
                    if(!m) m = { success: 0, failures: 0, missedSigns: {} };
                    if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                    m.failures++;
                    state.progression.mastery[pName] = m;

                    if(!state.progression.errorLog) state.progression.errorLog = {};
                    state.progression.errorLog[pName] = { date: Date.now(), count: (state.progression.errorLog[pName]?.count || 0) + 1 };

                    updateHeader(); await saveProgression(); 
                    showAlert('<i class="ph-duotone ph-x-circle"></i> Aïe... Continuons','error'); 
                    state.confirmationMode = false; state.diagnosticShown=false; 
                    setTimeout(()=>askNextQuestion(), 800);
                };
                
                btnGroup.appendChild(btnTrue); btnGroup.appendChild(btnFalse); card.appendChild(btnGroup); app.appendChild(card);
            }, 1500);
        }

        function showDiagnosticDetails(data, wasManualError = false) {
            window.scrollTo(0,0);
            const top = data.patho;
            setDocTitle(top.name);
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card';
            
            if(wasManualError) {
                card.innerHTML = `<h2 style="color:var(--error)"><i class="ph-duotone ph-smiley-sad"></i> C'était : ${top.name}</h2>`;
                
                if(!state.progression.mastery) state.progression.mastery = {};
                let m = state.progression.mastery[top.name];
                if(!m) m = { success: 0, failures: 0, missedSigns: {} };
                if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                
                m.failures++;
                
                Object.keys(top.signes).forEach(s => {
                    if(state.answers[s] === false || state.answers[s] === null) { 
                        if(!m.missedSigns[s]) m.missedSigns[s] = 0;
                        m.missedSigns[s]++;
                    }
                });
                
                Object.keys(state.answers).forEach(s => {
                    if (state.answers[s] === true && !top.signes[s]) {
                        if(!m.missedSigns[s]) m.missedSigns[s] = 0;
                        m.missedSigns[s]++;
                    }
                });

                state.progression.mastery[top.name] = m;
                
                if(!state.progression.errorLog) state.progression.errorLog = {};
                state.progression.errorLog[top.name] = { date: Date.now(), count: (state.progression.errorLog[top.name]?.count || 0) + 1 };
                
                saveProgression();

            } else {
                card.innerHTML = `<h2><i class="ph-duotone ph-check-circle color-success"></i> ${top.name}</h2>`;
            }

            const desc = document.createElement('div'); desc.className='patho-desc'; desc.textContent = top.short; desc.style.marginBottom='20px'; desc.style.textAlign='center'; card.appendChild(desc);
            
            if(top.signes) { 
                const pathoSigns = Object.keys(top.signes);
                const correctSigns = [], missingSigns = [], notAskedSigns = [], erroneousSigns = [];
                pathoSigns.forEach(s => {
                    const val = state.answers[s];
                    if(val === true) correctSigns.push(s); 
                    else if(val === false || val === null) missingSigns.push(s);
                    else notAskedSigns.push(s);
                });
                state.allSigns.forEach(s => { if(state.answers[s] === true && !pathoSigns.includes(s)) erroneousSigns.push(s); });
                
                correctSigns.sort((a, b) => (top.signes[b] || 0) - (top.signes[a] || 0));
                missingSigns.sort((a, b) => (top.signes[b] || 0) - (top.signes[a] || 0));
                
                const resultsDiv = document.createElement('div'); resultsDiv.className='result-list';
                
                const createList = (title, items, type, typeLabel) => {
                    if(items.length > 0) {
                        let icon = '<i class="ph-duotone ph-info"></i>';
                        let badgeClass = 'badge-neutral';
                        
                        if (type === 'correct') { icon = '<i class="ph-duotone ph-check-circle"></i>'; badgeClass = 'badge-correct'; }
                        if (type === 'missing') { icon = '<i class="ph-duotone ph-warning"></i>'; badgeClass = 'badge-missing'; }
                        
                        const h = document.createElement('div'); 
                        h.className = 'result-section-title';
                        h.innerHTML = `${icon} ${title} <span style="opacity:0.6; font-size:0.9em; margin-left:auto;">${items.length}</span>`;
                        resultsDiv.appendChild(h);

                        items.forEach(s => {
                            const r = document.createElement('div'); 
                            r.className = 'result-item'; 
                            r.innerHTML = `
                                <div class="result-label">${formatSigneName(s)}</div>
                                <div class="status-badge ${badgeClass}">${typeLabel}</div>
                            `;
                            resultsDiv.appendChild(r);
                        });
                    }
                };
                
                if(wasManualError) {
                    createList("Signes manqués (Faux Négatifs)", missingSigns, "missing", "Non");
                    createList("Autres signes", notAskedSigns, "neutral", "Inconnu");
                } else {
                    createList("Signes bien identifiés", correctSigns, "correct", "Validé");
                    if(missingSigns.length > 0) {
                        createList("Attention : Signes manqués", missingSigns, "missing", "Erreur");
                    }
                    createList("Autres signes du tableau", notAskedSigns, "neutral", "Non demandé");
                }
                card.appendChild(resultsDiv);
            }

            if(top.pdf && top.pdf !== '#') {
                const pdfBtn = document.createElement('a');
                pdfBtn.href = top.pdf; pdfBtn.target = "_blank"; pdfBtn.className = 'btn'; pdfBtn.innerHTML = '<i class="ph-duotone ph-file-pdf"></i> Voir la fiche PDF complète'; pdfBtn.style.marginTop = '20px'; pdfBtn.style.display = 'block'; pdfBtn.style.textAlign = 'center';
                
                pdfBtn.onclick = trackPdf;

                card.appendChild(pdfBtn);
            }
            
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            
            const btnReplay = document.createElement('button'); btnReplay.className='btn btn-success'; btnReplay.innerHTML = '<i class="ph-duotone ph-arrow-clockwise"></i> Rejouer tout de suite'; 
            btnReplay.onclick = () => {
                 state.dailyTarget = null; 
                 renderDemographics();
            };

            const btnHome = document.createElement('button'); btnHome.className='link'; btnHome.innerHTML = '<i class="ph-duotone ph-house"></i> Accueil'; btnHome.onclick = renderHome;
            btnGroup.appendChild(btnReplay); btnGroup.appendChild(btnHome); card.appendChild(btnGroup); app.appendChild(card);
        }

        function renderGlossary() {
            setDocTitle("Glossaire");
            window.scrollTo(0,0);
            const app = q('#app'); app.innerHTML='';
            const titleCard = document.createElement('div'); titleCard.className='card center'; titleCard.innerHTML='<h2><i class="ph-duotone ph-book-bookmark"></i> Glossaire</h2>'; 
            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.innerHTML='<i class="ph-duotone ph-house"></i> Retour';
            btnBack.style.marginBottom='20px'; btnBack.onclick=renderHome;
            titleCard.appendChild(btnBack); app.appendChild(titleCard);

            const searchContainer = document.createElement('div'); searchContainer.className = 'search-container';
            const searchInput = document.createElement('input'); searchInput.className = 'search-input'; searchInput.placeholder = 'Rechercher une pathologie (ex: Grippe...)'; searchInput.type = 'text';
            
            const searchIcon = document.createElement('div'); 
            searchIcon.innerHTML = `<svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>`;
            
            searchContainer.appendChild(searchIcon);
            searchContainer.appendChild(searchInput); 
            app.appendChild(searchContainer);

            const wrapper = document.createElement('div'); wrapper.className = 'glossary-wrapper';
            const sidebar = document.createElement('div'); sidebar.className = 'alphabet-sidebar';
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            const sortedPathos = [...PATHOLOGIES].sort((a, b) => a.name.localeCompare(b.name));
            const existingLetters = new Set(sortedPathos.map(p => p.name.charAt(0).toUpperCase()));
            
            alphabet.forEach(letter => {
                const link = document.createElement('a'); link.textContent = letter; link.className = 'alpha-link';
                if (existingLetters.has(letter)) {
                    link.href = `#letter-${letter}`;
                    link.onclick = (e) => { e.preventDefault(); const target = document.getElementById(`letter-${letter}`); if(target) target.scrollIntoView({behavior: 'smooth', block: 'start'}); };
                } else { link.classList.add('disabled'); }
                sidebar.appendChild(link);
            });
            wrapper.appendChild(sidebar);

            const content = document.createElement('div'); content.className = 'glossary-content';
            function renderGrid(pathos, showHeaders = true) {
                content.innerHTML = '';
                if(pathos.length === 0) { content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Aucune pathologie trouvée.</div>'; return; }
                if(!showHeaders) {
                    const grid = document.createElement('div'); grid.className = 'letter-grid';
                    pathos.forEach(p => { grid.appendChild(createPathoCard(p)); }); content.appendChild(grid);
                } else {
                    alphabet.forEach(letter => {
                        const letterPathos = pathos.filter(p => p.name.charAt(0).toUpperCase() === letter);
                        if(letterPathos.length > 0) {
                            const letterHeader = document.createElement('div'); letterHeader.className = 'letter-header'; letterHeader.id = `letter-${letter}`; letterHeader.textContent = letter; content.appendChild(letterHeader);
                            const grid = document.createElement('div'); grid.className = 'letter-grid';
                            letterPathos.forEach(p => { grid.appendChild(createPathoCard(p)); }); content.appendChild(grid);
                        }
                    });
                }
            }
            function createPathoCard(p) {
                const card = document.createElement('div');
                card.className = 'patho-card';

                // J'ai supprimé tout le bloc "if (p.images...)" ici

                // J'ai aussi retiré "${imageHTML}" du code ci-dessous
                card.innerHTML = `
                    <div class="patho-name">${p.name}</div>
                    <div class="patho-desc">${p.short}</div>
                `;

                // Gestion du clic pour le PDF (inchangé)
                card.onclick = () => {
                    if(p.pdf && p.pdf !== '#') {
                        trackPdf();
                        window.open(p.pdf,'_blank');
                    } else {
                        showAlert('Fiche PDF non disponible','error');
                    }
                };

                return card;
            }
            renderGrid(sortedPathos, true);
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                if(term.length > 0) { sidebar.style.display = 'none'; const filtered = sortedPathos.filter(p => p.name.toLowerCase().includes(term)); renderGrid(filtered, false); } 
                else { sidebar.style.display = 'flex'; renderGrid(sortedPathos, true); }
            });
            wrapper.appendChild(content); app.appendChild(wrapper);
        }
    </script>
</body>
</html>
