<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="8SyBOdC5YhaXDqfNYGfzP1EZbb0iQWABpkImmZHXG30" />
    <title>Medicome - Entra√Ænement Clinique</title>
    
    <meta name="description" content="Simulateur de cas cliniques pour √©tudiants en m√©decine.">
    <meta property="og:title" content="Medicome">
    <meta property="og:type" content="website">
    <link rel="icon" href="favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
          --bg-dark: #020b16; --bg-light: #1e3c72;
          --glass-bg: rgba(13, 25, 48, 0.85); --glass-border: rgba(100, 200, 255, 0.15);
          --accent: #00d2ff; --accent-glow: rgba(0, 210, 255, 0.4);
          --text-main: #ffffff; --text-muted: #b0c4de;
          --success: #00ff9d; --error: #ff4d4d; --gold: #ffd700; --ruby: #ff0055; --bronze: #cd7f32;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 50% 0%, var(--bg-light), var(--bg-dark) 80%); background-attachment: fixed; color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; padding: 10px 24px; background: rgba(2, 11, 22, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); align-items: center; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .logo-img { height: 60px; width: auto; filter: drop-shadow(0 0 8px var(--accent-glow)); transition: transform 0.3s; }
        .brand:hover .logo-img { transform: scale(1.05); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .top-right { display:flex; gap:12px; align-items:center; }

        /* NOTIFICATIONS */
        .notif-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; margin-right: 5px; }
        .notif-icon { width: 24px; height: 24px; fill: var(--text-muted); transition: fill 0.3s; }
        .notif-btn:hover .notif-icon { fill: var(--accent); }
        .notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--error); border-radius: 50%; display: none; border: 1px solid var(--bg-dark); }
        .notif-modal { position: absolute; top: 60px; right: 20px; width: 300px; background: var(--bg-dark); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: none; max-height: 400px; overflow-y: auto; }
        .notif-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 0; font-size: 13px; text-align: left; }
        .notif-date { font-size: 11px; color: var(--accent); margin-bottom: 4px; }

        .pseudo { color:var(--accent); font-weight:600; padding:6px 12px; background: rgba(0, 210, 255, 0.05); border: 1px solid var(--glass-border); border-radius:20px; cursor:pointer; font-size: 14px; }

        /* MAIN UI */
        main { flex:1; max-width:1000px; width:100%; margin:0 auto; padding:30px 20px; display:flex; flex-direction:column; align-items:center; }
        .card { background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding:32px; border-radius:20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6), inset 0 0 0 1px var(--glass-border); margin-bottom:16px; width:100%; max-width:600px; transition: transform 0.3s ease; animation: fadeIn 0.5s ease-out; position: relative;}
        .card h2 { margin-bottom:20px; font-size:24px; text-align:center; color: white; }
        
        .btn { background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%); border:none; padding:14px 24px; border-radius:12px; color: #000; cursor:pointer; font-weight:700; font-size:15px; transition:all 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4); text-transform: uppercase; width: 100%; margin-top: 10px; }
        .btn:hover { transform:translateY(-2px); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6); }
        .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: #022015; }
        .btn-error { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; }
        .link { background: transparent; border:1px solid rgba(255,255,255,0.2); color: var(--text-muted); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:14px; margin-top: 10px; display: inline-block;}
        .link:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--accent); }
        
        .input, select, textarea { width:100%; padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3); color: white; margin-top:8px; font-family: 'Inter', sans-serif;}
        
        /* MASTERY GRID & BADGES */
        .mastery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; width: 100%; margin-top: 20px; }
        .mastery-item { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; position: relative;}
        .mastery-item:hover { transform: translateY(-3px); background: rgba(255,255,255,0.05); }
        
        .m-locked { border-color: rgba(255,255,255,0.1); opacity: 0.6; filter: grayscale(1); border-style: dashed;}
        .m-bronze { border-color: var(--bronze); background: rgba(205, 127, 50, 0.1); }
        .m-gold { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .m-master { border-color: var(--ruby); background: rgba(255, 0, 85, 0.1); box-shadow: 0 0 15px rgba(255, 0, 85, 0.3); }
        
        .badge-container { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        .badge-group { font-size: 11px; padding: 4px 10px; border-radius: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--text-muted); }
        .badge-unlocked { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; box-shadow: 0 0 10px var(--accent-glow); }

        /* REVIEWS */
        .reviews-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .review-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; font-size: 13px; text-align: left; border: 1px solid rgba(255,255,255,0.1); }
        .star-rating { direction: rtl; display: flex; justify-content: center; gap: 5px; margin: 10px 0; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 24px; cursor: pointer; color: #444; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--gold); }

        /* UTILS */
        .alert { padding:10px; border-radius:8px; margin:10px 0; text-align: center; font-size: 14px;}
        .alert-success { background: rgba(0, 255, 157, 0.15); color: var(--success); border: 1px solid var(--success); }
        .alert-error { background: rgba(255, 77, 77, 0.15); color: var(--error); border: 1px solid var(--error); }
        .stat-box { background: rgba(0,0,0,0.3); padding:15px; border-radius:10px; text-align: center; flex: 1; border: 1px solid rgba(255,255,255,0.1); }
        .stat-num { font-size: 24px; font-weight: bold; display: block; margin-bottom: 5px; }
        
        /* FOOTER */
        footer { text-align:center; padding:30px; background: rgba(0,0,0,0.5); font-size:12px; margin-top: auto; }
        .footer-nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .footer-link { cursor: pointer; color: var(--text-muted); } .footer-link:hover { color: white; text-decoration: underline; }
        .social-links svg { width: 24px; fill: var(--text-muted); margin: 0 10px; transition: 0.3s; }
        .social-links svg:hover { fill: var(--accent); transform: scale(1.1); }

        /* LEGAL MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: var(--bg-dark); padding: 20px; border-radius: 15px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--glass-border); text-align: left; }

        @media(max-width:600px) { .reviews-container, .mastery-grid { grid-template-columns: repeat(2, 1fr); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="brand" id="brandLogo">
            <img src="logo.png" alt="Medicome" class="logo-img">
            <h1 class="sr-only">Medicome : Entra√Ænement au Diagnostic M√©dical et S√©miologie</h1>
        </div>
        
        <div class="top-right">
            <button class="notif-btn" id="notifBtn">
                <svg class="notif-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                <div class="notif-badge" id="notifBadge"></div>
            </button>
            <div class="notif-modal" id="notifModal">
                <h4 style="color:white; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">üîî Actualit√©s</h4>
                <div id="notifContent"><div class="small">Chargement...</div></div>
            </div>

            <button id="homeBtn" class="link" style="display:none;">Accueil</button>
            <div id="pseudoBox" class="pseudo" style="display:none;">Utilisateur</div>
            <button id="logoutBtn" class="link" style="display:none;">D√©connexion</button>
        </div>
    </header>

    <main id="app">
        <div class="center" style="padding: 20px;">
            <div style="font-size: 50px; margin-bottom: 20px;">ü©∫</div>
            <h2 style="font-size: 1.5rem; color: white; margin-bottom: 10px;">Medicome</h2>
            <p style="color: var(--text-muted); max-width: 500px; line-height: 1.5;">
                Pr√©parez vos ECN, EDN et examens de m√©decine (Externat) gr√¢ce √† notre simulateur de cas cliniques interactif.
            </p>
            <div style="margin-top: 40px;">
                <div style="font-size: 30px; animation: spin 1s infinite linear;">‚öôÔ∏è</div>
                <div class="small" style="margin-top: 10px;">Initialisation...</div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="legalModal">
        <div class="modal-content">
            <h2 style="color:white; margin-bottom:10px;">Mentions L√©gales</h2>
            <div id="legalTextContent"></div>
            <button onclick="document.getElementById('legalModal').style.display='none'" class="link" style="margin-top:20px;">Fermer</button>
        </div>
    </div>

    <footer>
        <div class="social-links">
            <a href="https://instagram.com/medicome.fr" target="_blank"><svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg></a>
            <a href="https://x.com/medicome_fr" target="_blank"><svg viewBox="0 0 24 24"><path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10.03 2.38,10.05C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /></svg></a>
        </div>
        <div class="footer-nav">
            <span class="footer-link" onclick="window.scrollTo(0,0)">Haut</span>
            <span class="footer-link" id="reviewsLink">Avis</span>
            <span class="footer-link" id="contactLink">Contact</span>
            <span class="footer-link" onclick="renderLegal()">L√©gal</span>
        </div>
        <div style="opacity:0.5;">Medicome ¬© 2025</div>
    </footer>

    <script type="module">
        if (window.location.hostname.includes("github.io")) window.location.href = "https://medicome.fr";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // MAPPING GROUPES (Pour les badges)
        const PATHO_GROUPS = {
            "Infarctus du myocarde": "Cardio", "Embolie pulmonaire": "Cardio", "OAP": "Cardio", "Dissection Aortique": "Cardio", "P√©ricardite Aigu√´": "Cardio", "Fibrillation Atriale": "Cardio", "Endocardite Infectieuse": "Cardio", "Isch√©mie Aigu√´ Membre": "Cardio", "Rupture An√©vrisme Aorte": "Cardio", "Choc Septique": "Cardio",
            "AVC Isch√©mique": "Neuro", "M√©ningite Aigu√´": "Neuro", "H√©morragie M√©ning√©e": "Neuro", "Crise d'√âpilepsie": "Neuro", "Parkinson": "Neuro", "Scl√©rose en Plaques": "Neuro", "Maladie d'Alzheimer": "Neuro", "Myasth√©nie": "Neuro", "H√©matome Sous-Dural": "Neuro", "H√©matome Extra-Dural": "Neuro", "Guillain-Barr√©": "Neuro",
            "Pneumopathie Franche": "Pneumo", "Pneumothorax": "Pneumo", "Crise d'Asthme": "Pneumo", "Bronchiolite": "Pneumo", "BPCO Exacerbation": "Pneumo", "Cancer Bronchique": "Pneumo", "Tuberculose Pulmonaire": "Pneumo", "Apn√©e du Sommeil": "Pneumo", "Pleur√©sie": "Pneumo",
            "Appendicite Aigu√´": "Digestif", "Chol√©cystite Aigu√´": "Digestif", "Gastro-ent√©rite": "Digestif", "Occlusion Intestinale": "Digestif", "Pancreatite Aigu√´": "Digestif", "H√©morragie Digestive Haute": "Digestif", "Sigmo√Ødite": "Digestif", "Hernie Inguinale √âtrangl√©e": "Digestif", "Reflux Gastro-Oesophagien": "Digestif", "Cirrhose D√©compens√©e": "Digestif", "Cancer Colorectal": "Digestif", "Maladie de Crohn": "Digestif", "Rectocolite H√©morragique": "Digestif", "Ulc√®re Gastroduod√©nal": "Digestif", "H√©patite Aigu√´": "Digestif", "Lithiase Biliaire": "Digestif", "Hernie Hiatale": "Digestif", "P√©ritonite": "Digestif", "Isch√©mie M√©sent√©rique": "Digestif", "St√©nose du Pylore": "Digestif",
            "Colique N√©phr√©tique": "Uro/Nephro", "Py√©lon√©phrite Aigu√´": "Uro/Nephro", "Torsion du Testicule": "Uro/Nephro", "R√©tention Aigu√´ d'Urine": "Uro/Nephro", "Cancer Prostate": "Uro/Nephro", "Tumeur Vessie": "Uro/Nephro", "Insuffisance R√©nale Aigu√´": "Uro/Nephro", "Syndrome N√©phrotique": "Uro/Nephro", "Cystite Aigu√´": "Uro/Nephro", "Cancer du Testicule": "Uro/Nephro", "Insuffisance R√©nale Chronique": "Uro/Nephro", "Diab√®te Insipide": "Endo",
            "Grossesse Extra-Ut√©rine": "Gyn√©co", "Salpingite Aigu√´": "Gyn√©co", "Endom√©triose": "Gyn√©co", "Cancer du Sein": "Gyn√©co", "Pr√©-√©clampsie": "Gyn√©co", "Fibrome Ut√©rin": "Gyn√©co", "Kyste Ovarien": "Gyn√©co", "Mycose Vaginale": "Gyn√©co", "SOPK": "Gyn√©co",
            "√ârysip√®le": "Dermato", "Zona": "Dermato", "Purpura Rhumato√Øde": "Dermato", "Varicelle": "Dermato", "Psoriasis": "Dermato", "M√©lanome": "Dermato", "Carcinome Basocellulaire": "Dermato", "Gale": "Dermato", "Rougeole": "Dermato", "Syndrome de Kawasaki": "Dermato", "Scarlatine": "Dermato", "Imp√©tigo": "Dermato", "Acn√© S√©v√®re": "Dermato", "Ecz√©ma Atopique": "Dermato", "Urticaire Aigu√´": "Dermato",
            "Fracture Col F√©mur": "Rhumato/Ortho", "Arthrite Septique": "Rhumato/Ortho", "Sciatique": "Rhumato/Ortho", "Crise de Goutte": "Rhumato/Ortho", "Fracture Pouteau-Colles": "Rhumato/Ortho", "Polyarthrite Rhumato√Øde": "Rhumato/Ortho", "Spondylarthrite": "Rhumato/Ortho", "Ost√©oporose Fracturaire": "Rhumato/Ortho", "Canal Carpien": "Rhumato/Ortho", "Lumbago": "Rhumato/Ortho", "Entorse de Cheville": "Rhumato/Ortho", "Arthrose": "Rhumato/Ortho", "Lupus √âryth√©mateux": "Rhumato/Ortho", "Hernie Discale": "Rhumato/Ortho",
            "An√©mie Ferriprive": "H√©mato/Endo", "Hypothyro√Ødie": "H√©mato/Endo", "Hyperthyro√Ødie": "H√©mato/Endo", "Diab√®te Type 1": "H√©mato/Endo", "Diab√®te Type 2": "H√©mato/Endo", "Insuffisance Surr√©nalienne": "H√©mato/Endo", "Syndrome de Cushing": "H√©mato/Endo", "Leuc√©mie Aigu√´": "H√©mato/Endo", "Lymphome de Hodgkin": "H√©mato/Endo", "My√©lome Multiple": "H√©mato/Endo", "Dr√©panocytose": "H√©mato/Endo", "Hyperparathyro√Ødie": "H√©mato/Endo", "Acrom√©galie": "H√©mato/Endo", "H√©mophilie": "H√©mato/Endo", "An√©mie de Biermer": "H√©mato/Endo",
            "Attaque de Panique": "Psy", "D√©pression": "Psy", "Schizophr√©nie": "Psy", "Trouble Bipolaire": "Psy", "Anorexie Mentale": "Psy",
            "Glaucome Aigu": "ORL/Ophtalmo", "Otite Moyenne Aigu√´": "ORL/Ophtalmo", "DMLA": "ORL/Ophtalmo", "Cataracte": "ORL/Ophtalmo", "D√©collement de R√©tine": "ORL/Ophtalmo", "VPPB": "ORL/Ophtalmo", "Angine Bact√©rienne": "ORL/Ophtalmo", "Epistaxis": "ORL/Ophtalmo", "Sinusite Aigu√´": "ORL/Ophtalmo", "Laryngite Aigu√´": "ORL/Ophtalmo", "Conjonctivite": "ORL/Ophtalmo", "Orgelet": "ORL/Ophtalmo",
            "Paludisme": "Infectio", "Coqueluche": "Infectio", "Grippe": "Infectio", "Mononucl√©ose Infectieuse": "Infectio", "Primo-Infection VIH": "Infectio", "Maladie de Lyme": "Infectio", "T√©tanos": "Infectio", "Botulisme": "Infectio", "Rub√©ole": "Infectio", "Syphilis": "Infectio", "Oreillons": "Infectio", "Muguet Buccal": "Infectio"
        };

        const REFINEMENTS = {
            "douleur_abdominale": ["douleur_fosse_iliaque_droite", "douleur_hypocondre_droit", "douleur_fosse_iliaque_gauche", "douleur_epigastrique", "douleur_transfixiante_dos", "douleur_bas_ventre", "douleur_pelvienne", "douleur_abdominale_diffuse", "crampes_abdominales", "douleur_abdominale_intermittente", "douleur_sus_pubienne", "troubles_transit"],
            "douleur_thoracique": ["douleur_thoracique_oppressive", "douleur_thoracique_dechirante", "douleur_thoracique_cot√©", "douleur_basithoracique", "douleur_inspiration", "douleur_thoracique_point_cote"],
            "douleur_dos": ["douleur_lombaire_brutale", "douleur_lombaire_unilaterale", "douleur_lombaire", "douleur_bas_dos", "douleur_bas_dos_nuit", "douleur_dos_os", "douleur_dos_brutale"],
            "douleur_membre_traumatisme": ["impossibilite_marcher", "douleur_poignet", "chute_recente", "jambe_froide_pale", "douleur_articulaire_intense", "douleur_gros_orteil", "douleur_jambe_brutale_intense", "douleur_aine_hanche", "douleur_mains", "douleur_talon", "fourmillements_doigts"],
            "dyspnee": ["dyspnee_effort", "orthopnee_dyspnee_couchee", "dyspnee_brutale", "dyspnee_sifflante", "essoufflement_aggrave", "gene_respiratoire"],
            "toux": ["toux_seche", "toux_grasse", "toux_sanglante", "chant_du_coq", "toux_chronique", "toux_nuit"],
            "troubles_visuels": ["vision_floue", "vision_double", "baisse_vision_brutale", "amputation_champ_visuel", "eclairs_lumineux", "mouches_devant_yeux", "vision_centrale_floue", "vision_double_un_oeil", "trouble_vision_flou"],
            "troubles_neuro": ["paralysie_unilaterale", "troubles_parole_aphasie", "asymetrie_visage", "perte_sensibilite", "perte_equilibre", "tremblement_repos", "lenteur_mouvements", "machoire_bloquee", "corps_raide_contracte", "paralysie_descend_tete_vers_pieds", "paralysie_monte_pieds_vers_tete", "perte_connaissance"],
            "cephalees": ["cephalees_intenses", "cephalees_explosives_brutales", "mal_tete_unilateral"],
            "anomalie_peau": ["plaques_rouges", "vesicules_bulles", "demangeaisons", "grain_beaute_suspect", "tache_noire", "jambe_rouge", "purpura", "taches_rouges_jambes", "taches_rouges_peau", "tache_rouge_s_etend_peau", "plaques_rouges_croutes", "perle_translucide_peau", "croute_ne_guerit_pas", "boutons_bulles_corps", "taches_peau_purpura", "eruption_boutons_corps", "eruption_corps", "peau_aspect_granite", "boule_aine_douloureuse_dure"],
            "trouble_psy": ["tristesse_permanente", "delire_paranoiaque", "hallucinations", "perte_memoire", "agitation", "excitation_euphorie", "maigreur_extreme", "ne_se_lave_plus", "oubli_faits_recents", "cherches_ses_mots"],
            "genes_urinaires": ["sang_urines", "brulures_urinaires", "impossibilite_uriner", "regles_tres_abondantes", "douleur_testicule_brutale", "pertes_vaginales_anormales", "sang_urines_rouge", "difficulte_uriner", "urines_abondantes", "urines_mousseuses"]
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        const firebaseConfig = { apiKey: "AIzaSyCig9G4gYHU5h642YV1IZxthYm_IXp6vZU", authDomain: "medicome-paco.firebaseapp.com", projectId: "medicome-paco", storageBucket: "medicome-paco.firebasestorage.app", messagingSenderId: "332171806096", appId: "1:332171806096:web:36889325196a7a718b5f15", measurementId: "G-81HJ9DWBMX" };
        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (error) { console.error("Firebase Error:", error); }

        let PATHOLOGIES = [];
        const ACCESS_CODES = [ { code: "SuperCode1", pseudo:"Admin" } ];
        let state = {
            currentUser: null, pseudo: null, 
            progression: { correct: 0, incorrect: 0, streak: 0, mastery: {} },
            isGuest: false, demo:{}, currentSign:null, answers:{}, asked:[], allSigns:[], ranked: [], diagnosticShown:false, previousDiagnostics:[],
            history: [], confirmationMode: false, confirmationQueue: [], confirmedPatho: null, priorityQueue: []
        };

        async function initApp() {
            try {
                const response = await fetch('./pathologies.json');
                if (!response.ok) throw new Error("Erreur chargement pathologies");
                PATHOLOGIES = await response.json();
                
                const urlParams = new URLSearchParams(window.location.search);
                const ficheDemandee = urlParams.get('fiche');
                if (ficheDemandee) {
                    const pathoTrouvee = PATHOLOGIES.find(p => p.name.toLowerCase() === ficheDemandee.toLowerCase());
                    if (pathoTrouvee) { q('#app').innerHTML = ''; showDiagnosticDetails({patho: pathoTrouvee}); return; }
                }

                startAuthListener();
                fetchNotifications();
                
                q('#contactLink').onclick = renderContact;
                q('#reviewsLink').onclick = renderReviews;
                const notifBtn = q('#notifBtn');
                const notifModal = q('#notifModal');
                if(notifBtn) {
                    notifBtn.onclick = (e) => {
                        e.stopPropagation();
                        const isVisible = notifModal.style.display === 'block';
                        notifModal.style.display = isVisible ? 'none' : 'block';
                        if(!isVisible) q('#notifBadge').style.display = 'none';
                    };
                }
                window.onclick = () => { if(notifModal) notifModal.style.display = 'none'; };
                const brandLogo = document.getElementById('brandLogo');
                if(brandLogo) brandLogo.onclick = () => { if (state.currentUser || state.isGuest) renderHome(); };
                window.renderLegal = renderLegal;

            } catch (err) { q('#app').innerHTML = `<div class="card center"><h2 style="color:var(--error)">Erreur Technique</h2><p>${err.message}</p></div>`; }
        }
        initApp();

        async function fetchNotifications() {
            try {
                const qRef = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
                const snapshot = await getDocs(qRef);
                const container = q('#notifContent');
                if (snapshot.empty) { container.innerHTML = '<div class="small">Aucune nouveaut√©.</div>'; return; }
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    const dateStr = n.date && n.date.seconds ? new Date(n.date.seconds * 1000).toLocaleDateString() : 'R√©cemment';
                    container.innerHTML += `<div class="notif-item"><div class="notif-date">${dateStr}</div><div style="color:white;">${n.message}</div></div>`;
                });
                q('#notifBadge').style.display = 'block';
            } catch (e) { console.log("Erreur notifs", e); }
        }

        function startAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user; state.isGuest = false;
                    state.pseudo = user.displayName || user.email.split('@')[0]; updateHeader(); 
                    const docRef = doc(db, "users", user.uid);
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.pseudo) state.pseudo = data.pseudo;
                            state.progression = data.progression || { correct: 0, incorrect: 0, streak: 0, mastery: {} };
                        } else { saveProgression(); }
                        updateHeader(); renderHome();
                    } catch(e) { renderHome(); }
                } else {
                    const savedGuest = localStorage.getItem('medicome_guest_progression');
                    if(savedGuest) {
                        state.isGuest = true; state.pseudo = localStorage.getItem('medicome_guest_pseudo');
                        state.progression = JSON.parse(savedGuest);
                        updateHeader(); renderHome();
                        setTimeout(() => showAlert(`Bon retour, ${state.pseudo} !`, 'success'), 500);
                    } else { renderLogin(); updateHeader(); }
                }
            });
        }

        function q(sel){ return document.querySelector(sel); }
        function formatSigneName(sign){ return sign.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }
        function showAlert(message,type){
            const d = document.createElement('div'); d.className = 'alert alert-' + type; d.textContent = message;
            q('#app').insertBefore(d, q('#app').firstChild); setTimeout(()=>d.remove(),3000);
        }
        function triggerConfetti() { if(window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }

        async function saveProgression() {
            if (!state.isGuest && state.currentUser) {
                await setDoc(doc(db, "users", state.currentUser.uid), { progression: state.progression, pseudo: state.pseudo, lastUpdate: new Date() }, { merge: true });
            } else if (state.isGuest) {
                localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
            }
        }

        function updateHeader(){
            const pseudoBox = q("#pseudoBox"); const homeBtn = q("#homeBtn"); const logoutBtn = q("#logoutBtn");
            const streak = state.progression.streak || 0;
            const streakDisplay = streak > 0 ? ` <span style="color:#ff9f43; margin-left:8px;">üî• ${streak}</span>` : '';
            if(state.pseudo){ 
                pseudoBox.innerHTML = state.pseudo + (state.isGuest ? " (Local)" : "") + streakDisplay; 
                pseudoBox.style.display='inline-block'; pseudoBox.onclick=renderProfile;
                homeBtn.style.display='inline-block'; logoutBtn.style.display='inline-block';
            } else { pseudoBox.style.display='none'; homeBtn.style.display='none'; logoutBtn.style.display='none'; }
            homeBtn.onclick=renderHome;
            logoutBtn.onclick = () => { localStorage.clear(); location.reload(); signOut(auth); };
        }

        function renderLogin() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center'; card.innerHTML='<h2>‚òÅÔ∏è Connexion</h2>';
            const email = document.createElement('input'); email.className='input'; email.placeholder='Email';
            const pass = document.createElement('input'); pass.className='input'; pass.type='password'; pass.placeholder='Mot de passe';
            const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Se connecter';
            btn.onclick = async () => { try { await signInWithEmailAndPassword(auth, email.value, pass.value); } catch(e) { showAlert(e.message, 'error'); } };
            
            const btnGuest = document.createElement('button'); btnGuest.className='link'; btnGuest.textContent='Mode Invit√© (Pas de compte)';
            btnGuest.onclick = () => { state.isGuest=true; state.pseudo="Invit√©"; state.progression={correct:0,incorrect:0,streak:0,mastery:{}}; saveProgression(); renderHome(); };
            
            card.append(email, pass, btn, btnGuest); app.appendChild(card);
        }

        function renderHome() {
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const card = document.createElement('div'); card.className='card center';
            
            const tutorialHTML = `
                <div style="background: rgba(0, 210, 255, 0.05); border: 1px solid var(--accent); border-radius: 12px; padding: 20px; margin: 20px 0; text-align: left; width: 100%;">
                    <h3 style="color:var(--accent); font-size: 1.1em; margin-bottom: 10px;">üéì Mode D√©fie l'IA</h3>
                    <p style="font-size: 0.95em; color: #e0e7ff;">1. Choisis une pathologie dans ta t√™te.<br>2. R√©ponds aux questions de l'IA.<br>3. Elle devine ton diagnostic.</p>
                </div>`;

            card.innerHTML = `<h2>üëã Bonjour ${state.pseudo || ''}</h2>${tutorialHTML}
                            <div class="stat-box" style="width:100%"><div class="stat-num">${prog.correct + prog.incorrect}</div><div class="stat-label">Cas jou√©s</div></div>
                            <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
                                <div class="stat-box" style="border-color:var(--success)"><div class="stat-num" style="color:var(--success)">${prog.correct}</div>IA a trouv√©</div>
                                <div class="stat-box" style="border-color:var(--error)"><div class="stat-num" style="color:var(--error)">${prog.incorrect}</div>√âchecs</div>
                            </div>`;
            
            const btnDiag = document.createElement('button'); btnDiag.className='btn'; btnDiag.textContent='ü©∫ Lancer le d√©fi'; 
            btnDiag.onclick= () => { if(audioCtx.state === 'suspended') audioCtx.resume(); renderDemographics(); };
            const btnGloss = document.createElement('button'); btnGloss.className='link'; btnGloss.textContent='üìö Glossaire'; btnGloss.onclick=renderGlossary;
            const btnProf = document.createElement('button'); btnProf.className='link'; btnProf.textContent='üë§ Mon Profil'; btnProf.onclick=renderProfile;
            
            card.append(btnDiag, btnGloss, btnProf); app.appendChild(card);
        }

        // --- ABANDON MENU ---
        function renderAbandonMenu() {
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>Abandonner ?</h2><p class="small">Vous arr√™tez le cas clinique en cours.</p>`;
            
            const btnHome = document.createElement('button'); btnHome.className='btn'; btnHome.textContent='üè† Juste arr√™ter (Retour Accueil)';
            btnHome.onclick = renderHome;

            const divSearch = document.createElement('div');
            divSearch.style.marginTop = '20px'; divSearch.style.width = '100%';
            divSearch.innerHTML = `<p style="margin-bottom:10px; color:var(--accent);">Je pensais √† une pathologie pr√©cise (C'√©tait une erreur de l'IA) :</p>`;
            const select = document.createElement('select'); select.className = 'input';
            select.innerHTML = '<option value="">-- Choisir la pathologie --</option>';
            PATHOLOGIES.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
                select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
            select.onchange = () => {
                if(!select.value) return;
                const patho = PATHOLOGIES.find(p=>p.name === select.value);
                // On compte √ßa comme une erreur car l'IA n'a pas trouv√© avant l'abandon
                state.progression.incorrect++;
                saveProgression();
                showDiagnosticDetails({patho: patho}, true); // true = mode correction d'erreur
            };
            divSearch.appendChild(select);

            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='Annuler, reprendre';
            btnBack.onclick = renderCurrentQuestion;

            card.append(btnHome, divSearch, btnBack);
            app.appendChild(card);
        }

        // --- PROFILE & BADGES ---
        function renderProfile() {
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const card = document.createElement('div'); card.className='card center'; card.style.maxWidth = '800px';
            card.innerHTML = `<h2>üë§ Profil</h2>`;
            
            // Calc Badges
            const groupScores = {};
            Object.keys(prog.mastery || {}).forEach(pName => {
                const data = prog.mastery[pName];
                const count = (typeof data === 'number') ? data : (data.success || 0);
                if(count > 0) {
                    const group = PATHO_GROUPS[pName] || "Autre";
                    if(!groupScores[group]) groupScores[group] = 0;
                    groupScores[group]++;
                }
            });
            const badgesDiv = document.createElement('div'); badgesDiv.className='badge-container';
            const allGroups = [...new Set(Object.values(PATHO_GROUPS))].sort();
            allGroups.forEach(g => {
                const score = groupScores[g] || 0;
                const unlocked = score >= 3; // Seuil pour avoir le badge
                badgesDiv.innerHTML += `<div class="badge-group ${unlocked?'badge-unlocked':''}">${unlocked?'üèÜ':''} ${g} (${score})</div>`;
            });
            card.appendChild(badgesDiv);

            const masteryTitle = document.createElement('h3'); masteryTitle.innerHTML = 'Maitrise Clinique'; 
            card.appendChild(masteryTitle);

            const masteryGrid = document.createElement('div'); masteryGrid.className = 'mastery-grid';
            const sortedPathos = [...PATHOLOGIES].sort((a, b) => a.name.localeCompare(b.name));
            const masteryData = prog.mastery || {};

            sortedPathos.forEach(p => {
                const m = masteryData[p.name];
                const successCount = (typeof m === 'number') ? m : (m?.success || 0);
                
                const mItem = document.createElement('div');
                let sClass = 'm-locked', icon = 'üîí';
                if (successCount >= 10) { sClass = 'm-master'; icon = 'üíé'; }
                else if (successCount >= 5) { sClass = 'm-gold'; icon = 'ü•á'; }
                else if (successCount >= 1) { sClass = 'm-bronze'; icon = 'ü•â'; }

                mItem.className = `mastery-item ${sClass}`;
                mItem.innerHTML = `<div class="mastery-icon">${icon}</div><div class="mastery-name">${p.name}</div><div class="mastery-count">${successCount}</div>`;
                mItem.onclick = () => renderPathoStats(p);
                masteryGrid.appendChild(mItem);
            });
            card.appendChild(masteryGrid);

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
            btnBack.style.marginTop='20px'; btnBack.onclick=renderHome;
            card.appendChild(btnBack); app.appendChild(card);
        }

        function renderPathoStats(patho) {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            const m = state.progression.mastery[patho.name];
            const wins = (typeof m === 'number') ? m : (m?.success || 0);
            const loss = (typeof m === 'object' && m.failures) ? m.failures : 0;
            const mistakes = (typeof m === 'object' && m.missedSigns) ? m.missedSigns : {};

            card.innerHTML = `<h2>${patho.name}</h2>
            <div class="patho-desc">${patho.short}</div>
            <div style="display:flex; gap:10px; width:100%; margin:20px 0;">
                <div class="stat-box" style="border-color:var(--success)"><div class="stat-num" style="color:var(--success)">${wins}</div>R√©ussites</div>
                <div class="stat-box" style="border-color:var(--error)"><div class="stat-num" style="color:var(--error)">${loss}</div>Erreurs</div>
            </div>`;

            if(Object.keys(mistakes).length > 0) {
                card.innerHTML += `<h4 style="color:var(--error); margin-top:20px;">Signes souvent manqu√©s :</h4>`;
                let html = '<ul style="text-align:left; color:var(--text-muted); margin-top:10px;">';
                Object.entries(mistakes).sort((a,b)=>b[1]-a[1]).forEach(([sign, count]) => {
                    html += `<li>${formatSigneName(sign)} (x${count})</li>`;
                });
                html += '</ul>';
                card.innerHTML += html;
            }

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour Profil';
            btnBack.onclick=renderProfile;
            card.appendChild(btnBack); app.appendChild(card);
        }

        // --- GAME LOGIC ---
        function renderDemographics() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card';
            card.innerHTML=`<h3>üìã Patient Virtuel</h3><p class="small" style="margin-bottom:20px">Configuration du cas</p>`;
            const createSel = (lbl, id, opts) => {
                const l = document.createElement('label'); l.textContent=lbl; l.style.color='var(--accent)';
                const s = document.createElement('select'); s.id=id; s.className='input';
                opts.forEach(o=> { const op=document.createElement('option'); op.value=o[0]; op.textContent=o[1]; s.appendChild(op); });
                card.appendChild(l); card.appendChild(s);
            };
            createSel("Sexe", "demo-sexe", [["rien","Al√©atoire"],["femme","Femme"],["homme","Homme"]]);
            createSel("√Çge > 30 ans", "demo-30", [["rien","?"],["oui","Oui"],["non","Non"]]);
            createSel("√Çge > 65 ans", "demo-65", [["rien","?"],["oui","Oui"],["non","Non"]]);
            createSel("Ant√©c√©dents famille", "demo-atcd", [["rien","?"],["oui","Oui"],["non","Non"]]);
            createSel("Tabac", "demo-tabac", [["rien","?"],["oui","Oui"],["non","Non"]]);
            
            const btnStart = document.createElement('button'); btnStart.className='btn'; btnStart.textContent='‚ñ∂Ô∏è Commencer';
            btnStart.onclick=()=>{ 
                state.demo = {
                    femme: q('#demo-sexe').value === 'femme', homme: q('#demo-sexe').value === 'homme',
                    plus_de_30ans: q('#demo-30').value === 'oui', plus_de_65ans: q('#demo-65').value === 'oui',
                    atcd_famille: q('#demo-atcd').value === 'oui', tabac: q('#demo-tabac').value === 'oui'
                };
                state.answers={}; state.asked=[]; state.diagnosticShown=false; state.previousDiagnostics=[]; state.history=[];
                state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null; state.priorityQueue = [];
                askNextQuestion();
            };
            const btnCancel = document.createElement('button'); btnCancel.className='link'; btnCancel.textContent='Annuler'; btnCancel.onclick=renderHome;
            card.append(btnStart, btnCancel); app.appendChild(card);
        }

        function prepareSigns() {
            let allSignsSet = new Set();
            PATHOLOGIES.forEach(p => { Object.keys(p.signes).forEach(s => allSignsSet.add(s)); });
            state.allSigns = Array.from(allSignsSet);
        }

        function rankPathologies() {
            const scores = PATHOLOGIES.map(p => {
                let score = 0;
                for(const facteur in p.facteurs){ if(state.demo[facteur] === true) score += p.facteurs[facteur]; }
                for(const signe in p.signes){
                    const ans = state.answers[signe];
                    if(ans === true) score += p.signes[signe];
                    else if(ans === false) score -= (p.signes[signe] * 0.5);
                }
                return {patho:p, score: Math.max(0, score)};
            });
            const totalScore = scores.reduce((sum, s) => sum + s.score, 0);
            state.ranked = scores.map(s => ({ ...s, prob: totalScore > 0 ? ((s.score / totalScore) * 100).toFixed(1) : 0 })).sort((a,b)=>b.prob - a.prob);
        }

        function getNextSmartSign(rankedPathos, remainingSigns) {
            if (rankedPathos.length < 2) return remainingSigns[Math.floor(Math.random() * remainingSigns.length)];
            const top1 = rankedPathos[0].patho; const top2 = rankedPathos[1].patho;
            let candidates = remainingSigns.map(s => {
                const w1 = top1.signes[s] || 0; const w2 = top2.signes[s] || 0;
                return { sign: s, score: Math.abs(w1 - w2) + (Math.random() * 0.1) };
            });
            candidates.sort((a, b) => b.score - a.score);
            let useful = candidates.filter(c => c.score > 0.1);
            if (useful.length === 0) useful = candidates;
            const topPool = useful.slice(0, Math.min(useful.length, 5));
            return topPool[Math.floor(Math.random() * topPool.length)].sign;
        }

        function canShowDiagnostic() {
            const qNum = state.asked.length;
            if(state.ranked.length===0) return false;
            const top1 = state.ranked[0];
            if(state.previousDiagnostics.includes(top1.patho.name)) return false;
            const score1 = parseFloat(top1.prob);
            if (!state.ranked[1]) return score1 > 50;
            const gap = score1 - parseFloat(state.ranked[1].prob);
            if (qNum >= 4 && score1 >= 75 && gap >= 30) return true;
            if (qNum >= 9 && score1 >= 70 && gap >= 15) return true;
            if (qNum >= 15 && score1 >= 60) return true;
            return false;
        }

        function prepareConfirmationQuestions(topPatho) {
            const pSigns = Object.entries(topPatho.signes).sort((a, b) => b[1] - a[1]).map(entry => entry[0]);
            return pSigns.filter(s => !state.asked.includes(s)).slice(0, 2);
        }

        function renderCurrentQuestion() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            const signe = state.currentSign;
            const questionTitle = state.confirmationMode ? `<span style="color:var(--gold)">ü§î Une piste se dessine...</span>` : `QUESTION ${state.asked.length}`;

            card.innerHTML=`<div class="small" style="margin-bottom:12px; color:var(--accent)">${questionTitle}</div>
                            <div class="question-text">Le patient pr√©sente-t-il :<br><strong style="font-size:1.2em; color:white;">${formatSigneName(signe)}</strong> ?</div>`;
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            
            const mkBtn = (txt, cls, val) => {
                const b = document.createElement('button'); b.className=cls; b.textContent=txt;
                b.onclick=()=>{ 
                    state.history.push(JSON.stringify({ answers: state.answers, asked: state.asked, currentSign: state.currentSign, confirmationMode: state.confirmationMode, confirmationQueue: state.confirmationQueue, confirmedPatho: state.confirmedPatho, priorityQueue: state.priorityQueue }));
                    state.answers[signe]=val; askNextQuestion(); 
                };
                btnGroup.appendChild(b);
            };
            mkBtn('OUI', 'btn btn-success', true); mkBtn('NON', 'btn btn-error', false); mkBtn('Je ne sais pas', 'link', null);
            card.appendChild(btnGroup);

            const navGroup = document.createElement('div'); navGroup.style.display = 'flex'; navGroup.style.gap = '15px'; navGroup.style.marginTop = '20px';
            if(state.history.length > 0) {
                const btnBack = document.createElement('button'); btnBack.className='btn-back'; btnBack.textContent='‚¨ÖÔ∏è';
                btnBack.onclick = () => { Object.assign(state, JSON.parse(state.history.pop())); renderCurrentQuestion(); };
                navGroup.appendChild(btnBack);
            }
            const btnAb = document.createElement('button'); btnAb.className='link'; btnAb.textContent='Abandonner'; btnAb.onclick=renderAbandonMenu;
            navGroup.appendChild(btnAb); card.appendChild(navGroup);
            app.appendChild(card);
        }

        function askNextQuestion() {
            // Entonnoir logic
            if(state.asked.length > 0) {
                const lastSign = state.asked[state.asked.length - 1];
                if(state.answers[lastSign] === true) {
                    if(REFINEMENTS[lastSign]) {
                        state.priorityQueue.push(...REFINEMENTS[lastSign].filter(s => state.allSigns.includes(s) && !state.asked.includes(s)));
                    } else {
                        // Sibling killer logic
                        for (const [parent, children] of Object.entries(REFINEMENTS)) {
                            if (children.includes(lastSign)) {
                                const siblings = children.filter(c => c !== lastSign);
                                state.priorityQueue = state.priorityQueue.filter(q => !siblings.includes(q));
                                state.asked.push(...siblings.filter(s => !state.asked.includes(s)));
                            }
                        }
                    }
                }
            }
            // Priority Queue
            if(state.priorityQueue.length > 0) {
                const nextPriority = state.priorityQueue.shift();
                if(!state.asked.includes(nextPriority)) { state.currentSign = nextPriority; state.asked.push(nextPriority); renderCurrentQuestion(); return; }
                else { askNextQuestion(); return; }
            }
            // Confirmation Mode
            if (state.confirmationMode) {
                const lastSign = state.asked[state.asked.length - 1];
                if (state.answers[lastSign] === false) {
                    state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
                    showAlert("Fausse piste, je continue...", "info");
                } else if (state.confirmationQueue.length > 0) {
                    const nextC = state.confirmationQueue.shift();
                    state.currentSign = nextC; state.asked.push(nextC); renderCurrentQuestion(); return;
                } else { showDiagnostic(); return; }
            }
            // Standard Logic
            prepareSigns();
            const remaining = state.allSigns.filter(s => !state.asked.includes(s));
            if(remaining.length === 0) { showDiagnostic(); return; }
            const hasSymptom = Object.keys(state.answers).some(key => state.answers[key] === true);
            if (!hasSymptom) { // Chasseur
                const generalSigns = remaining.filter(s => REFINEMENTS.hasOwnProperty(s));
                const pool = generalSigns.length > 0 ? generalSigns : remaining;
                const randomSign = pool[Math.floor(Math.random() * pool.length)];
                state.currentSign = randomSign; state.asked.push(randomSign); renderCurrentQuestion(); return;
            }
            rankPathologies(); 
            if(canShowDiagnostic()){ // Sniper
                const topPatho = state.ranked[0].patho;
                const confirmQuestions = prepareConfirmationQuestions(topPatho);
                if (confirmQuestions.length > 0) {
                    state.confirmationMode = true; state.confirmedPatho = topPatho; state.confirmationQueue = confirmQuestions;
                    const first = state.confirmationQueue.shift(); state.currentSign = first; state.asked.push(first); renderCurrentQuestion(); return;
                } else { showDiagnostic(); return; }
            }
            const signe = getNextSmartSign(state.ranked, remaining);
            state.currentSign = signe; state.asked.push(signe); renderCurrentQuestion();
        }

        function showDiagnostic() {
            const app = q('#app'); app.innerHTML = '';
            app.innerHTML = `<div class="card center"><h3 style="color:var(--accent)">Analyse IA...</h3><div style="margin: 30px 0; font-size: 50px; animation: spin 0.8s infinite linear;">‚öôÔ∏è</div></div>`;
            
            setTimeout(async () => {
                rankPathologies();
                const top = state.ranked[0];
                state.diagnosticShown = true;
                state.previousDiagnostics.push(top.patho.name);

                app.innerHTML = ''; 
                const card = document.createElement('div'); card.className='card center';
                card.innerHTML = `<h2>üí° Diagnostic : ${top.patho.name}</h2><div class="patho-desc">${top.patho.short}</div>`;
                if(top.patho.pdf && top.patho.pdf !== '#') card.innerHTML += `<a href="${top.patho.pdf}" target="_blank" class="link">üìÑ Fiche PDF</a><br><br>`;
                
                const btnTrue = document.createElement('button'); btnTrue.className='btn btn-success'; btnTrue.textContent='‚úÖ Correct';
                btnTrue.onclick = async () => { 
                    triggerConfetti(); playSound('success');
                    state.progression.correct++; state.progression.streak = (state.progression.streak || 0) + 1;
                    
                    // SAVE MASTERY
                    if(!state.progression.mastery) state.progression.mastery = {};
                    const pName = top.patho.name;
                    if(!state.progression.mastery[pName]) state.progression.mastery[pName] = 0;
                    
                    // Handle Object Migration
                    let m = state.progression.mastery[pName];
                    if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                    m.success++;
                    state.progression.mastery[pName] = m;

                    await saveProgression(); showAlert('Valid√© !','success'); showDiagnosticDetails({patho: top.patho});
                };
                
                const btnFalse = document.createElement('button'); btnFalse.className='btn btn-error'; btnFalse.textContent='‚ùå Incorrect';
                btnFalse.onclick = async () => { 
                    playSound('error');
                    state.progression.incorrect++; state.progression.streak = 0;
                    
                    // SAVE FAILURE
                    if(!state.progression.mastery) state.progression.mastery = {};
                    const pName = top.patho.name;
                    let m = state.progression.mastery[pName] || { success: 0, failures: 0, missedSigns: {} };
                    if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                    m.failures++;
                    state.progression.mastery[pName] = m;

                    await saveProgression(); showAlert('A√Øe... on continue','error'); 
                    state.confirmationMode = false; setTimeout(()=>askNextQuestion(), 800);
                };
                
                card.append(btnTrue, btnFalse); app.appendChild(card);
            }, 1000);
        }

        function showDiagnosticDetails(data, wasManualError = false) {
            const top = data.patho;
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card';
            
            // Si c'est une erreur manuelle (via abandon), on enregistre les stats d'erreur
            if(wasManualError) {
                // On d√©tecte les signes manqu√©s (ceux que l'utilisateur a dit NON alors que OUI)
                if(!state.progression.mastery) state.progression.mastery = {};
                let m = state.progression.mastery[top.name] || { success: 0, failures: 0, missedSigns: {} };
                if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
                m.failures++;
                
                Object.keys(top.signes).forEach(s => {
                    if(state.answers[s] === false) { // C'√©tait un signe de la maladie, mais l'user a dit non
                        if(!m.missedSigns[s]) m.missedSigns[s] = 0;
                        m.missedSigns[s]++;
                    }
                });
                state.progression.mastery[top.name] = m;
                saveProgression();
                card.innerHTML = `<h2 style="color:var(--error)">‚ùå C'√©tait : ${top.name}</h2>`;
            } else {
                card.innerHTML = `<h2>‚úÖ ${top.name}</h2>`;
            }

            card.innerHTML += `<div class="patho-desc" style="text-align:center; margin-bottom:20px;">${top.short}</div>`;
            
            // ANALYSE DES REPONSES
            if(top.signes) {
                const resultsDiv = document.createElement('div'); resultsDiv.className='result-list';
                const pathoSigns = Object.keys(top.signes);
                const correct = [], missing = [], neutral = [], errors = [];
                pathoSigns.forEach(s => {
                    const v = state.answers[s];
                    if(v === true) correct.push(s); else if(v === false) missing.push(s); else neutral.push(s);
                });
                state.allSigns.forEach(s => { if(state.answers[s]===true && !pathoSigns.includes(s)) errors.push(s); });

                const addList = (t, l, c) => {
                    if(l.length){ 
                        let h = document.createElement('h4'); h.textContent=t; h.style.marginTop='10px'; resultsDiv.append(h);
                        l.forEach(s=> { let d=document.createElement('div'); d.className=`result-item result-${c}`; d.innerHTML=`${formatSigneName(s)}`; resultsDiv.append(d); });
                    }
                };
                addList("‚úÖ Bien vu", correct, "correct");
                addList("‚ùå Manqu√©s (Faux N√©gatifs)", missing, "missing");
                addList("‚ö†Ô∏è Trop coch√© (Faux Positifs)", errors, "error");
                addList("‚ÑπÔ∏è Non demand√©", neutral, "neutral");
                card.appendChild(resultsDiv);
            }

            if(top.pdf && top.pdf !== '#') card.innerHTML += `<a href="${top.pdf}" target="_blank" class="btn" style="margin-top:20px; display:block; text-align:center;">üìÑ Fiche PDF</a>`;
            const btnHome = document.createElement('button'); btnHome.className='btn'; btnHome.textContent='üè† Accueil'; btnHome.onclick=renderHome;
            card.appendChild(btnHome); app.appendChild(card);
        }

        function renderReviews() { /* Identique pr√©cedemment (Avis) */
            const app = q('#app'); app.innerHTML=''; const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>‚≠ê Avis</h2>`;
            // Form ajout
            const f = document.createElement('div'); f.style.background='rgba(255,255,255,0.05)'; f.style.padding='10px'; f.style.borderRadius='10px';
            f.innerHTML = `<div class="star-rating"><input type="radio" name="r" value="5" id="r5"><label for="r5">‚òÖ</label><input type="radio" name="r" value="4" id="r4"><label for="r4">‚òÖ</label><input type="radio" name="r" value="3" id="r3"><label for="r3">‚òÖ</label></div><textarea id="rvTxt" class="input" placeholder="Avis..."></textarea><button id="sendRev" class="btn">Publier</button>`;
            card.append(f);
            const c = document.createElement('div'); c.className='reviews-container';
            // Load reviews
            getDocs(query(collection(db, "reviews"), orderBy("date", "desc"), limit(10))).then(s => {
                s.forEach(d => { const r=d.data(); c.innerHTML+=`<div class="review-card"><strong>${r.pseudo}</strong> <span style="color:gold">${"‚òÖ".repeat(r.rating)}</span><br>${r.text}</div>`; });
            });
            card.append(c);
            const b=document.createElement('button'); b.className='btn'; b.textContent='Retour'; b.onclick=renderHome; card.append(b); app.append(card);
            setTimeout(()=>{
                const btn = document.getElementById('sendRev');
                if(btn) btn.onclick = async () => {
                    const txt = document.getElementById('rvTxt').value; const rt = document.querySelector('input[name="r"]:checked');
                    if(txt && rt) { await addDoc(collection(db,"reviews"),{pseudo:state.pseudo||"Anonyme", text:txt, rating:parseInt(rt.value), date:new Date()}); renderReviews(); }
                }
            }, 500);
        }

        function renderContact() { /* Identique */ 
            const app = q('#app'); app.innerHTML=''; const card = document.createElement('div'); card.className='card center';
            card.innerHTML=`<h2>Contact</h2><textarea id="cMsg" class="input" placeholder="Message..."></textarea><button id="cBtn" class="btn">Envoyer</button><button id="cBk" class="link">Retour</button>`;
            app.append(card);
            q('#cBtn').onclick = async ()=>{ await addDoc(collection(db,"messages"),{msg:q('#cMsg').value, date:new Date()}); showAlert("Envoy√©","success"); renderHome(); };
            q('#cBk').onclick = renderHome;
        }

        function renderGlossary() { /* Identique Glossaire */
            const app = q('#app'); app.innerHTML='';
            const t = document.createElement('div'); t.className='card center'; t.innerHTML='<h2>Glossaire</h2>';
            const b = document.createElement('button'); b.className='link'; b.textContent='Retour'; b.onclick=renderHome; t.append(b); app.append(t);
            const w = document.createElement('div'); w.className='glossary-wrapper';
            const s = document.createElement('div'); s.className='alphabet-sidebar';
            const c = document.createElement('div'); c.className='glossary-content';
            const grid = document.createElement('div'); grid.className='letter-grid';
            PATHOLOGIES.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
                const d=document.createElement('div'); d.className='patho-card'; d.innerHTML=`<div class="patho-name">${p.name}</div>`;
                d.onclick=()=>{if(p.pdf!=='#')window.open(p.pdf);}; grid.append(d);
            });
            c.append(grid); w.append(s,c); app.append(w);
        }

        function renderLegal() { q('#legalModal').style.display='flex'; q('#legalTextContent').innerHTML='<p>H√©berg√© par GitHub. Donn√©es Firebase. Contact via formulaire.</p>'; }
    </script>
</body>
</html>
