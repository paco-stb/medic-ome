<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â Â 
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#1a1a2e">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <link rel="apple-touch-icon" href="favicon.png">
Â  Â Â 
Â  Â  <title>Medicome - EntraÃ®nement pour les Ã©tudiants en MÃ©decine</title>
Â  Â  <meta name="description" content="Testez vos connaissances sur les signes typiques de diffÃ©rentes pathologies. TÃ©lÃ©chargez des fiches de rÃ©vision concises adaptÃ©es au programme des EDN.">
Â  Â  <link rel="icon" href="favicon.png">

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-dark: #020b16; --bg-light: #1e3c72;
Â  Â  Â  Â  Â  Â  --glass-bg: rgba(13, 25, 48, 0.95); --glass-border: rgba(100, 200, 255, 0.15);
Â  Â  Â  Â  Â  Â  --accent: #00d2ff; --accent-glow: rgba(0, 210, 255, 0.4);
Â  Â  Â  Â  Â  Â  --text-main: #ffffff; --text-muted: #b0c4de;
Â  Â  Â  Â  Â  Â  --success: #00ff9d; --error: #ff4d4d;
Â  Â  Â  Â  Â  Â  --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --ruby: #e01e37;
Â  Â  Â  Â  Â  Â  --card-shadow: 0 15px 35px rgba(0,0,0,0.6);
Â  Â  Â  Â  }
Â  Â  Â  Â  [data-theme="light"] {
Â  Â  Â  Â  Â  Â  --bg-dark: #e0f2fe; --bg-light: #f0f9ff;
Â  Â  Â  Â  Â  Â  --glass-bg: rgba(255, 255, 255, 0.95); --glass-border: rgba(0, 114, 255, 0.2);
Â  Â  Â  Â  Â  Â  --accent: #0072ff; --accent-glow: rgba(0, 114, 255, 0.2);
Â  Â  Â  Â  Â  Â  --text-main: #0f172a; --text-muted: #475569;
Â  Â  Â  Â  Â  Â  --success: #059669; --error: #dc2626;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
Â  Â  Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 50% 0%, var(--bg-light), var(--bg-dark) 80%); background-attachment: fixed; color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* HEADER */
Â  Â  Â  Â  header { display: flex; justify-content: space-between; padding: 10px 24px; background: var(--glass-bg); backdrop-filter: blur(15px); align-items: center; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; }
Â  Â  Â  Â  .logo-img { height: 60px; width: auto; filter: drop-shadow(0 0 8px var(--accent-glow)); transition: transform 0.3s; }
Â  Â  Â  Â  .brand:hover .logo-img { transform: scale(1.05); }
Â  Â  Â  Â  .top-right { display:flex; gap:12px; align-items:center; }
Â  Â  Â  Â  .pseudo { color:var(--accent); font-weight:600; padding:6px 12px; background: rgba(0, 210, 255, 0.05); border: 1px solid var(--glass-border); border-radius:20px; cursor:pointer; font-size: 14px; }

Â  Â  Â  Â  /* UI ELEMENTS */
Â  Â  Â  Â  .link { background: rgba(125,125,125,0.1); border:1px solid var(--glass-border); color: var(--text-muted); padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:14px; }
Â  Â  Â  Â  .link:hover { background: rgba(125,125,125,0.2); color: var(--text-main); border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
Â  Â  Â  Â  main { flex:1; max-width:1000px; width:100%; margin:0 auto; padding:30px 20px; display:flex; flex-direction:column; align-items:center; }
Â  Â  Â  Â  .card { background: var(--glass-bg); backdrop-filter: blur(12px); padding:32px; border-radius:20px; box-shadow: var(--card-shadow), inset 0 0 0 1px var(--glass-border); margin-bottom:16px; width:100%; max-width:600px; animation: fadeIn 0.5s ease-out; position: relative;}
Â  Â  Â  Â  .input, select, textarea { width:100%; padding:14px; border-radius:10px; border:1px solid var(--glass-border); background: rgba(125,125,125,0.1); color: var(--text-main); margin-top:8px; margin-bottom:12px; font-size:14px; font-family: 'Inter', sans-serif; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  select option { background-color: #020b16; color: #ffffff; }
Â  Â  Â  Â  [data-theme="light"] select option { background-color: #ffffff; color: #000000; }

Â  Â  Â  Â  .btn { background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%); border:none; padding:14px 24px; border-radius:12px; color: #fff; cursor:pointer; font-weight:700; font-size:15px; transition:all 0.3s; width: 100%; margin-top: 10px; }
Â  Â  Â  Â  .btn:hover { transform:translateY(-2px); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6); }
Â  Â  Â  Â  .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: #fff; }
Â  Â  Â  Â  .btn-error { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; }
Â  Â  Â  Â  .btn-back { background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 10px; width: auto; }
Â  Â  Â  Â  .btn-back:hover { background: rgba(0, 210, 255, 0.1); color: var(--text-main); }
Â  Â  Â  Â  .center { text-align:center; display:flex; flex-direction:column; align-items:center; }
Â  Â  Â  Â  .button-group { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:12px; width: 100%; }
Â  Â  Â  Â  .small { opacity:0.6; font-size:13px; color:var(--text-muted); margin-top:12px; text-align:center; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* SPECIFICS */
Â  Â  Â  Â  .ai-progress-container { width: 100%; height: 6px; background: rgba(125,125,125,0.1); border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
Â  Â  Â  Â  .ai-progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.5s ease-out; }
Â  Â  Â  Â  .daily-card { border: 1px solid var(--gold); background: rgba(255, 215, 0, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; width: 100%; }
Â  Â  Â  Â  .daily-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* CSS EMOJIS & IMAGES */
Â  Â  Â  Â  .emoji-img { width: 1.3em; height: 1.3em; vertical-align: middle; margin-bottom: 2px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
Â  Â  Â  Â  .large-emoji { width: 50px; height: 50px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .achievements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 20px; }
Â  Â  Â  Â  .achievement-row { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 15px; background: rgba(125,125,125,0.1); border-radius: 12px; border: 1px solid transparent; text-align: center; height: 100%; }
Â  Â  Â  Â  .achievement-row.unlocked { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
Â  Â  Â  Â  .ach-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
Â  Â  Â  Â  .ach-icon img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2)); }
Â  Â  Â  Â  .locked-icon { font-size: 24px; opacity: 0.5; }
Â  Â  Â  Â  .ach-info { width: 100%; }
Â  Â  Â  Â  .ach-title { font-weight: bold; font-size: 13px; color: var(--text-main); margin-bottom: 4px; }
Â  Â  Â  Â  .ach-desc { font-size: 11px; color: var(--text-muted); line-height: 1.3; }

Â  Â  Â  Â  @media (max-width: 700px) {
Â  Â  Â  Â  Â  Â  .achievements-grid { grid-template-columns: repeat(1, 1fr); }
Â  Â  Â  Â  Â  Â  .achievement-row { flex-direction: row; text-align: left; }
Â  Â  Â  Â  Â  Â  .ach-icon { width: 40px; height: 40px; margin-bottom: 0; margin-right: 10px; }
Â  Â  Â  Â  }

Â  Â  Â  Â  .reviews-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%; }
Â  Â  Â  Â  .review-card { background: rgba(125,125,125,0.1); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; text-align: left; }
Â  Â  Â  Â  .star-rating { display: flex; gap: 5px; justify-content: center; margin: 10px 0; direction: rtl; }
Â  Â  Â  Â  .star-rating input { display: none; }
Â  Â  Â  Â  .star-rating label { font-size: 25px; color: #888; cursor: pointer; transition: color 0.2s; }
Â  Â  Â  Â  .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--gold); }

Â  Â  Â  Â  .mastery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; width: 100%; margin-top: 20px; }
Â  Â  Â  Â  .mastery-item { background: rgba(125,125,125,0.1); border-radius: 10px; padding: 15px 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
Â  Â  Â  Â  .mastery-icon img { width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
Â  Â  Â  Â  .m-locked { border-color: var(--glass-border); opacity: 0.5; filter: grayscale(1); border-style: dashed;}
Â  Â  Â  Â  .m-bronze { border-color: var(--bronze); background: rgba(205, 127, 50, 0.1); }
Â  Â  Â  Â  .m-silver { border-color: var(--silver); background: rgba(192, 192, 192, 0.1); }
Â  Â  Â  Â  .m-gold { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
Â  Â  Â  Â  .m-master { border-color: var(--ruby); background: rgba(224, 30, 55, 0.15); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .specialty-badge { font-size: 16px; font-weight: bold; color: var(--text-main); background: linear-gradient(90deg, rgba(0,210,255,0.2) 0%, rgba(0,210,255,0) 100%); padding: 10px 20px; border-radius: 30px; border-left: 4px solid var(--accent); display: inline-block; margin-bottom: 20px; }
Â  Â  Â  Â  .error-tracker { margin-top: 20px; width: 100%; border-top: 1px solid var(--glass-border); padding-top: 15px; }
Â  Â  Â  Â  .error-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 77, 77, 0.1); border-left: 3px solid var(--error); margin-bottom: 5px; border-radius: 4px; font-size: 13px; color: var(--text-main); }

Â  Â  Â  Â  /* RESULT LIST */
Â  Â  Â  Â  .result-list { background: rgba(0, 0, 0, 0.2); border-radius: 16px; padding: 10px; margin-top: 15px; border: 1px solid var(--glass-border); }
Â  Â  Â  Â  .result-section-title { font-size: 14px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 5px; display: flex; align-items: center; gap: 8px; }
Â  Â  Â  Â  .result-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); transition: all 0.2s ease; }
Â  Â  Â  Â  .result-item:first-of-type { border-top-left-radius: 12px; border-top-right-radius: 12px; }
Â  Â  Â  Â  .result-item:last-of-type { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
Â  Â  Â  Â  .result-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(5px); }
Â  Â  Â  Â  .result-label { font-weight: 500; color: var(--text-main); font-size: 15px; }
Â  Â  Â  Â  .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
Â  Â  Â  Â  .badge-correct { background: rgba(0, 255, 157, 0.15); color: var(--success); border: 1px solid rgba(0, 255, 157, 0.3); }
Â  Â  Â  Â  .badge-missing { background: rgba(255, 77, 77, 0.15); color: var(--error); border: 1px solid rgba(255, 77, 77, 0.3); }
Â  Â  Â  Â  .badge-neutral { background: rgba(176, 196, 222, 0.15); color: var(--text-muted); border: 1px solid rgba(176, 196, 222, 0.3); }

Â  Â  Â  Â  .glossary-wrapper { display: flex; align-items: flex-start; gap: 30px; width: 100%; }
Â  Â  Â  Â  .search-container { width: 100%; max-width: 600px; margin: 0 auto 30px auto; position: relative; }
Â  Â  Â  Â  .search-input { width: 100%; padding: 16px 20px 16px 55px; border-radius: 50px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-main); font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
Â  Â  Â  Â  .search-input:focus { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); outline: none; transform: translateY(-2px); }
Â  Â  Â  Â  .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; fill: var(--text-muted); pointer-events: none; transition: fill 0.3s; }
Â  Â  Â  Â  .search-input:focus ~ .search-icon { fill: var(--accent); }
Â  Â  Â  Â  .alphabet-sidebar { position: sticky; top: 90px; display: flex; flex-direction: column; gap: 8px; background: var(--glass-bg); padding: 15px 8px; border-radius: 30px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--glass-border); min-width: 50px; align-items: center; box-shadow: var(--card-shadow); scrollbar-width: none; }
Â  Â  Â  Â  .alphabet-sidebar::-webkit-scrollbar { display: none; }
Â  Â  Â  Â  .alpha-link { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 700; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; background: rgba(125,125,125,0.05); }
Â  Â  Â  Â  .alpha-link:hover:not(.disabled) { color: #fff; background: var(--accent); transform: scale(1.1); box-shadow: 0 0 10px var(--accent-glow); }
Â  Â  Â  Â  .alpha-link.disabled { opacity: 0.3; cursor: default; background: transparent; }
Â  Â  Â  Â  .glossary-content { flex: 1; width: 100%; }
Â  Â  Â  Â  .letter-header { font-size: 2rem; font-weight: 800; color: var(--accent); margin: 30px 0 15px; border-bottom: 2px solid var(--glass-border); padding-bottom: 10px; width: 100%; }
Â  Â  Â  Â  .letter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
Â  Â  Â  Â  .patho-card { background: var(--glass-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border); transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; border-left: 4px solid var(--glass-border); }
Â  Â  Â  Â  .patho-card:hover { transform: translateY(-5px); border-left-color: var(--accent); background: rgba(125,125,125,0.1); box-shadow: var(--card-shadow); }
Â  Â  Â  Â  .patho-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; color: var(--text-main); }
Â  Â  Â  Â  .patho-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .stat-box { background: rgba(125,125,125,0.1); padding:20px; border-radius:12px; margin:10px 0; border: 1px solid var(--glass-border); text-align:center; }
Â  Â  Â  Â  .stat-number { font-size:36px; font-weight:700; color:var(--text-main); }
Â  Â  Â  Â  .notif-btn, .theme-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; margin-right: 5px; }
Â  Â  Â  Â  .notif-icon, .theme-icon { width: 24px; height: 24px; fill: var(--text-muted); transition: fill 0.3s; }
Â  Â  Â  Â  .notif-btn:hover .notif-icon, .theme-btn:hover .theme-icon { fill: var(--accent); }
Â  Â  Â  Â  .notif-modal { position: absolute; top: 60px; right: 20px; width: 300px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; max-height: 400px; overflow-y: auto; color: var(--text-main); }
Â  Â  Â  Â  .notif-item { border-bottom: 1px solid var(--glass-border); padding: 10px 0; font-size: 13px; text-align: left; }
Â  Â  Â  Â  .notif-date { font-size: 11px; color: var(--accent); margin-bottom: 4px; }
Â  Â  Â  Â  footer { text-align:center; padding:30px 20px; background: rgba(0,0,0,0.5); font-size:13px; border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; align-items: center; gap: 15px; }
Â  Â  Â  Â  .footer-nav { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;}
Â  Â  Â  Â  .footer-link { color: var(--text-muted); text-decoration: none; cursor: pointer; } .footer-link:hover { color: var(--accent); }
Â  Â  Â  Â  .social-links { display: flex; gap: 20px; margin-bottom: 10px; }
Â  Â  Â  Â  .social-link { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(125,125,125,0.1); border-radius: 50%; transition: all 0.3s; text-decoration: none; cursor: pointer; }
Â  Â  Â  Â  .social-link:hover { background: rgba(0, 210, 255, 0.1); transform: scale(1.1); }
Â  Â  Â  Â  .social-icon { width: 20px; height: 20px; fill: var(--text-muted); transition: fill 0.3s; }
Â  Â  Â  Â  .social-link:hover .social-icon { fill: var(--accent); }
Â  Â  Â  Â  .alert { padding:14px; border-radius:10px; margin:12px 0; font-size:14px; width: 100%; text-align: center; }
Â  Â  Â  Â  .alert-success { background: rgba(0, 255, 157, 0.1); border:1px solid var(--success); color:var(--success); }
Â  Â  Â  Â  .alert-error { background: rgba(255, 77, 77, 0.1); border:1px solid var(--error); color:var(--error); }
Â  Â  Â  Â  @keyframes spin { 100% { transform: rotate(360deg); } }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
Â  Â  </style>
</head>
<body>

Â  Â  <header>
Â  Â  Â  Â  <div class="brand" id="brandLogo">
Â  Â  Â  Â  Â  Â  <img src="logo.png" alt="Medicome Logo" class="logo-img">
Â  Â  Â  Â  Â  Â  <h1 class="sr-only">Medicome</h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="top-right">
Â  Â  Â  Â  Â  Â  <button class="theme-btn" id="themeBtn" title="Changer le thÃ¨me">
Â  Â  Â  Â  Â  Â  Â  Â  <svg class="theme-icon" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 4a8 8 0 0 0 0 16z"/></svg>
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <button class="notif-btn" id="notifBtn" title="NouveautÃ©s">
Â  Â  Â  Â  Â  Â  Â  Â  <svg class="notif-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="notif-badge" id="notifBadge"></div>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <div class="notif-modal" id="notifModal">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color:var(--text-main); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:10px;">ğŸ”” ActualitÃ©s</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="notifContent"><div class="small">Chargement...</div></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button id="homeBtn" class="link" style="display:none;">Accueil</button>
Â  Â  Â  Â  Â  Â  <div id="pseudoBox" class="pseudo" style="display:none;">Utilisateur</div>
Â  Â  Â  Â  Â  Â  <button id="logoutBtn" class="link" style="display:none;">DÃ©connexion</button>
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <main id="app">
Â  Â  Â  Â  <div class="center" id="landing-content" style="padding: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Stethoscope.png" alt="Stethoscope" style="width:80px; height:80px; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-main);">Medicome</h1>
Â  Â  Â  Â  Â  Â  <h2 style="font-size: 1.2rem; color: var(--accent); margin-bottom: 20px; font-weight: normal;">
Â  Â  Â  Â  Â  Â  Â  Â  L'IA d'entraÃ®nement au diagnostic mÃ©dical
Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  <div style="max-width: 600px; margin: 0 auto; color: var(--text-muted); line-height: 1.5;">
Â  Â  Â  Â  Â  Â  Â  Â  <p>PrÃ©parez vos ECN, EDN et examens de mÃ©decine grÃ¢ce Ã  notre simulateur de cas cliniques interactif. PÃ©dagogie inversÃ©e, mode survie et glossaire complet.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="margin-top: 40px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 30px; animation: spin 1s infinite linear;">âš™ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small" style="margin-top: 10px;">Chargement du noyau mÃ©dical...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </main>

Â  Â  <footer>
Â  Â  Â  Â  <div class="social-links">
Â  Â  Â  Â  Â  Â  <a id="linkInsta" href="https://instagram.com/medicome.fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg></a>
Â  Â  Â  Â  Â  Â  <a id="linkTiktok" href="https://www.tiktok.com/@medicome.fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M12.5 3.5v10.55c0 1.9-1.55 3.45-3.45 3.45S5.6 15.95 5.6 14.05c0-1.9 1.55-3.45 3.45-3.45 0.3 0 0.6 0.05 0.85 0.15V7.4c-0.25-0.1-0.55-0.15-0.85-0.15-3.8 0-6.9 3.1-6.9 6.9s3.1 6.9 6.9 6.9c3.8 0 6.9-3.1 6.9-6.9V7.6c1.7 1.2 3.8 1.9 6.05 1.9v-3.75c-2.15 0-4.05-0.9-5.3-2.3H12.5z"/></svg></a>
Â  Â  Â  Â  Â  Â  <a id="linkX" href="https://x.com/medicome_fr" target="_blank" class="social-link"><svg class="social-icon" viewBox="0 0 24 24"><path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10.03 2.38,10.05C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /></svg></a>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="footer-nav">
Â  Â  Â  Â  Â  Â  <span class="footer-link" onclick="window.scrollTo(0,0)">Haut de page</span>
Â  Â  Â  Â  Â  Â  <span class="footer-link" id="reviewsLink">Avis Utilisateurs</span>
Â  Â  Â  Â  Â  Â  <span class="footer-link" id="contactLink">Nous Contacter</span>
Â  Â  Â  Â  Â  Â  <span class="footer-link" id="legalLink">Mentions LÃ©gales & ConfidentialitÃ©</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top:10px; opacity:0.6;">Medicome Â© 2025 - Outil pÃ©dagogique</div>
Â  Â  </footer>

Â  Â  <script type="module">
Â  Â  Â  Â  if (window.location.hostname.includes("github.io")) { window.location.href = "https://medicome.fr"; }

Â  Â  Â  Â  import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, collection, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

Â  Â  Â  Â  const REFINEMENTS = {
Â  Â  Â  Â  Â  Â  "douleur_thoracique": ["douleur_thoracique_oppressive", "douleur_thoracique_dechirante", "douleur_thoracique_cotÃ©", "irradiation_bras_machoire", "irradiation_dos", "douleur_effort", "soulage_penche_avant", "oppression_thoracique"],
Â  Â  Â  Â  Â  Â  "douleur_abdominale": ["douleur_fosse_iliaque_droite", "douleur_fosse_iliaque_gauche", "douleur_hypocondre_droit", "douleur_epigastrique", "douleur_transfixiante_dos", "douleur_abdominale_brutale", "defense_abdominale", "ventre_dur_bois", "douleur_migration_ombilic"],
Â  Â  Â  Â  Â  Â  "toux": ["toux_seche", "toux_grasse", "toux_sanglante", "toux_chronique", "toux_seche_aboyante", "quintes_toux_violentes", "reprise_inspiratoire_bruyante"],
Â  Â  Â  Â  Â  Â  "dyspnee": ["dyspnee_effort", "dyspnee_brutale", "orthopnee_dyspnee_couchee", "dyspnee_expiratoire", "dyspnee_inspiratoire", "sifflements_respiratoires"],
Â  Â  Â  Â  Â  Â  "fievre": ["fievre_elevee", "frissons_intenses", "sueurs_nocturnes", "convulsions_generalisees"],
Â  Â  Â  Â  Â  Â  "cephalees": ["cephalees_intenses", "cephalees_explosives_brutales", "pulsatile_coeur_cogne", "mal_tete_unilateral", "raideur_nuque", "gene_lumiere"],
Â  Â  Â  Â  Â  Â  "troubles_visuels": ["vision_double", "vision_floue", "baisse_vision_brutale", "eclairs_lumineux", "pluie_de_suie", "halo_autour_phares", "vision_centrale_floue", "lignes_droites_ondulees"],
Â  Â  Â  Â  Â  Â  "troubles_neuro": ["paralysie_unilaterale", "troubles_parole_aphasie", "perte_connaissance", "convulsions", "confusion", "tremblement_repos", "rigidite_musculaire"],
Â  Â  Â  Â  Â  Â  "anomalie_peau": ["ictere_jaunisse", "purpura", "taches_rouges_peau", "eruption_vesicules_bulles", "plaques_rouges", "grain_beaute_asymetrique", "croutes_jaunes_miel"],
Â  Â  Â  Â  Â  Â  "genes_urinaires": ["brulures_urinaires", "sang_urines", "urines_troubles_odorantes", "envie_frequente_uriner", "difficulte_uriner", "absence_urine"],
Â  Â  Â  Â  Â  Â  "douleur_membre_traumatisme": ["impossibilite_marcher", "raccourcissement_jambe", "rotation_externe_pied", "poignet_dos_fourchette", "douleur_jambe_brutale_intense", "absence_pouls"],
Â  Â  Â  Â  Â  Â  "douleur_dos": ["douleur_lombaire_brutale", "irradiation_vers_pubis", "douleur_bas_dos_nuit", "raideur_matin", "irradiation_fesse_jambe"],
Â  Â  Â  Â  Â  Â  "trouble_psy": ["tristesse_permanente", "idees_noires", "delire_paranoiaque", "excitation_euphorie", "peur_mourir_devenir_fou", "maigreur_extreme"]
Â  Â  Â  Â  };

Â  Â  Â  Â  const PATHO_GROUPS = {
Â  Â  Â  Â  Â  Â  "Infarctus du myocarde": "Cardio", "Embolie pulmonaire": "Cardio", "OAP": "Cardio", "Dissection Aortique": "Cardio", "PÃ©ricardite AiguÃ«": "Cardio", "Fibrillation Atriale": "Cardio", "Endocardite Infectieuse": "Cardio", "IschÃ©mie AiguÃ« Membre": "Cardio", "Rupture AnÃ©vrisme Aorte": "Cardio", "Choc Septique": "Cardio",
Â  Â  Â  Â  Â  Â  "AVC IschÃ©mique": "Neuro", "MÃ©ningite AiguÃ«": "Neuro", "HÃ©morragie MÃ©ningÃ©e": "Neuro", "Crise d'Ã‰pilepsie": "Neuro", "Parkinson": "Neuro", "SclÃ©rose en Plaques": "Neuro", "Maladie d'Alzheimer": "Neuro", "MyasthÃ©nie": "Neuro", "HÃ©matome Sous-Dural": "Neuro", "HÃ©matome Extra-Dural": "Neuro", "Guillain-BarrÃ©": "Neuro",
Â  Â  Â  Â  Â  Â  "Pneumopathie Franche": "Pneumo", "Pneumothorax": "Pneumo", "Crise d'Asthme": "Pneumo", "Bronchiolite": "Pneumo", "BPCO Exacerbation": "Pneumo", "Cancer Bronchique": "Pneumo", "Tuberculose Pulmonaire": "Pneumo", "ApnÃ©e du Sommeil": "Pneumo", "PleurÃ©sie": "Pneumo",
Â  Â  Â  Â  Â  Â  "Appendicite AiguÃ«": "Digestif", "CholÃ©cystite AiguÃ«": "Digestif", "Gastro-entÃ©rite": "Digestif", "Occlusion Intestinale": "Digestif", "Pancreatite AiguÃ«": "Digestif", "HÃ©morragie Digestive Haute": "Digestif", "SigmoÃ¯dite": "Digestif", "Hernie Inguinale Ã‰tranglÃ©e": "Digestif", "Reflux Gastro-Oesophagien": "Digestif", "Cirrhose DÃ©compensÃ©e": "Digestif", "Cancer Colorectal": "Digestif", "Maladie de Crohn": "Digestif", "Rectocolite HÃ©morragique": "Digestif", "UlcÃ¨re GastroduodÃ©nal": "Digestif", "HÃ©patite AiguÃ«": "Digestif", "Lithiase Biliaire": "Digestif", "Hernie Hiatale": "Digestif", "PÃ©ritonite": "Digestif", "IschÃ©mie MÃ©sentÃ©rique": "Digestif", "StÃ©nose du Pylore": "Digestif",
Â  Â  Â  Â  Â  Â  "Colique NÃ©phrÃ©tique": "Uro/Nephro", "PyÃ©lonÃ©phrite AiguÃ«": "Uro/Nephro", "Torsion du Testicule": "Uro/Nephro", "RÃ©tention AiguÃ« d'Urine": "Uro/Nephro", "Cancer Prostate": "Uro/Nephro", "Tumeur Vessie": "Uro/Nephro", "Insuffisance RÃ©nale AiguÃ«": "Uro/Nephro", "Syndrome NÃ©phrotique": "Uro/Nephro", "Cystite AiguÃ«": "Uro/Nephro", "Cancer du Testicule": "Uro/Nephro", "Insuffisance RÃ©nale Chronique": "Uro/Nephro", "DiabÃ¨te Insipide": "Endo",
Â  Â  Â  Â  Â  Â  "Grossesse Extra-UtÃ©rine": "GynÃ©co", "Salpingite AiguÃ«": "GynÃ©co", "EndomÃ©triose": "GynÃ©co", "Cancer du Sein": "GynÃ©co", "PrÃ©-Ã©clampsie": "GynÃ©co", "Fibrome UtÃ©rin": "GynÃ©co", "Kyste Ovarien": "GynÃ©co", "Mycose Vaginale": "GynÃ©co", "SOPK": "GynÃ©co",
Â  Â  Â  Â  Â  Â  "Ã‰rysipÃ¨le": "Dermato", "Zona": "Dermato", "Purpura RhumatoÃ¯de": "Dermato", "Varicelle": "Dermato", "Psoriasis": "Dermato", "MÃ©lanome": "Dermato", "Carcinome Basocellulaire": "Dermato", "Gale": "Dermato", "Rougeole": "Dermato", "Syndrome de Kawasaki": "Dermato", "Scarlatine": "Dermato", "ImpÃ©tigo": "Dermato", "AcnÃ© SÃ©vÃ¨re": "Dermato", "EczÃ©ma Atopique": "Dermato", "Urticaire AiguÃ«": "Dermato",
Â  Â  Â  Â  Â  Â  "Fracture Col FÃ©mur": "Rhumato/Ortho", "Arthrite Septique": "Rhumato/Ortho", "Sciatique": "Rhumato/Ortho", "Crise de Goutte": "Rhumato/Ortho", "Fracture Pouteau-Colles": "Rhumato/Ortho", "Polyarthrite RhumatoÃ¯de": "Rhumato/Ortho", "Spondylarthrite": "Rhumato/Ortho", "OstÃ©oporose Fracturaire": "Rhumato/Ortho", "Canal Carpien": "Rhumato/Ortho", "Lumbago": "Rhumato/Ortho", "Entorse de Cheville": "Rhumato/Ortho", "Arthrose": "Rhumato/Ortho", "Lupus Ã‰rythÃ©mateux": "Rhumato/Ortho", "Hernie Discale": "Rhumato/Ortho",
Â  Â  Â  Â  Â  Â  "AnÃ©mie Ferriprive": "HÃ©mato/Endo", "HypothyroÃ¯die": "HÃ©mato/Endo", "HyperthyroÃ¯die": "HÃ©mato/Endo", "DiabÃ¨te Type 1": "HÃ©mato/Endo", "DiabÃ¨te Type 2": "HÃ©mato/Endo", "Insuffisance SurrÃ©nalienne": "HÃ©mato/Endo", "Syndrome de Cushing": "HÃ©mato/Endo", "LeucÃ©mie AiguÃ«": "HÃ©mato/Endo", "Lymphome de Hodgkin": "HÃ©mato/Endo", "MyÃ©lome Multiple": "HÃ©mato/Endo", "DrÃ©panocytose": "HÃ©mato/Endo", "HyperparathyroÃ¯die": "HÃ©mato/Endo", "AcromÃ©galie": "HÃ©mato/Endo", "HÃ©mophilie": "HÃ©mato/Endo", "AnÃ©mie de Biermer": "HÃ©mato/Endo",
Â  Â  Â  Â  Â  Â  "Attaque de Panique": "Psy", "DÃ©pression": "Psy", "SchizophrÃ©nie": "Psy", "Trouble Bipolaire": "Psy", "Anorexie Mentale": "Psy",
Â  Â  Â  Â  Â  Â  "Glaucome Aigu": "ORL/Ophtalmo", "Otite Moyenne AiguÃ«": "ORL/Ophtalmo", "DMLA": "ORL/Ophtalmo", "Cataracte": "ORL/Ophtalmo", "DÃ©collement de RÃ©tine": "ORL/Ophtalmo", "VPPB": "ORL/Ophtalmo", "Angine BactÃ©rienne": "ORL/Ophtalmo", "Epistaxis": "ORL/Ophtalmo", "Sinusite AiguÃ«": "ORL/Ophtalmo", "Laryngite AiguÃ«": "ORL/Ophtalmo", "Conjonctivite": "ORL/Ophtalmo", "Orgelet": "ORL/Ophtalmo",
Â  Â  Â  Â  Â  Â  "Paludisme": "Infectio", "Coqueluche": "Infectio", "Grippe": "Infectio", "MononuclÃ©ose Infectieuse": "Infectio", "Primo-Infection VIH": "Infectio", "Maladie de Lyme": "Infectio", "TÃ©tanos": "Infectio", "Botulisme": "Infectio", "RubÃ©ole": "Infectio", "Syphilis": "Infectio", "Oreillons": "Infectio", "Muguet Buccal": "Infectio"
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const ACHIEVEMENTS = [
Â  Â  Â  Â  Â  Â  { id: "played_10_days", title: "AssiduitÃ©", desc: "Jouer 10 jours d'affilÃ©e", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Calendar.png" },
Â  Â  Â  Â  Â  Â  { id: "baby_doc", title: "P1 validÃ©e", desc: "Identifier 1 pathologie", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Food/Baby%20Bottle.png" },
Â  Â  Â  Â  Â  Â  { id: "med_student", title: "Externe", desc: "Identifier 25 pathologies", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Graduation%20Cap.png" },
Â  Â  Â  Â  Â  Â  { id: "intern", title: "Interne", desc: "Identifier 50 pathologies", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Stethoscope.png" },
Â  Â  Â  Â  Â  Â  { id: "chief", title: "Chef de Clinique", desc: "Identifier 100 pathologies", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Hospital.png" },
Â  Â  Â  Â  Â  Â  { id: "critic", title: "Critique MÃ©dical", desc: "Publier un avis", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Memo.png" },
Â  Â  Â  Â  Â  Â  { id: "fan", title: "Fan Club", desc: "Suivre sur les rÃ©seaux", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Red%20Heart.png" },
Â  Â  Â  Â  Â  Â  { id: "bookworm_1", title: "Rat de BibliothÃ¨que", desc: "TÃ©lÃ©charger 1 fiche PDF", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Books.png" },
Â  Â  Â  Â  Â  Â  { id: "bookworm_25", title: "Archiviste", desc: "TÃ©lÃ©charger 25 fiches PDF", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Card%20File%20Box.png" },
Â  Â  Â  Â  Â  Â  { id: "bookworm_50", title: "BibliothÃ©caire", desc: "TÃ©lÃ©charger 50 fiches PDF", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Classical%20Building.png" },
Â  Â  Â  Â  Â  Â  { id: "bookworm_100", title: "Savoir Absolu", desc: "TÃ©lÃ©charger 100 fiches PDF", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Brain.png" },
Â  Â  Â  Â  Â  Â  { id: "master_5", title: "Major de Promo", desc: "5 pathologies au rang MaÃ®tre", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/1st%20Place%20Medal.png" },
Â  Â  Â  Â  Â  Â  { id: "master_30", title: "Professeur", desc: "30 pathologies au rang MaÃ®tre", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Crown.png" },
Â  Â  Â  Â  Â  Â  { id: "master_100", title: "LÃ©gende", desc: "100 pathologies au rang MaÃ®tre", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Woman%20Genie.png" },
Â  Â  Â  Â  Â  Â  { id: "encyclopedia", title: "EncyclopÃ©die Vivante", desc: "DÃ©bloquer toutes les pathologies", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Globe%20Showing%20Europe-Africa.png" },
Â  Â  Â  Â  Â  Â  { id: "god_mode", title: "Dieu de la MÃ©decine", desc: "Toutes pathologies en MaÃ®tre", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Nature/High%20Voltage.png" },
Â  Â  Â  Â  Â  Â  { id: "speed_demon", title: "Flash", desc: "10 diagnostics en moins de 30s", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Rocket.png" },Â 
Â  Â  Â  Â  Â  Â  { id: "speed_50", title: "Vitesse LumiÃ¨re", desc: "50 diagnostics en moins de 30s", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Nature/Shooting%20Star.png" },
Â  Â  Â  Â  Â  Â  { id: "speed_100", title: "Voyageur Temporel", desc: "100 diagnostics en moins de 30s", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Hourglass%20Not%20Done.png" },
Â  Â  Â  Â  Â  Â  { id: "daily_10", title: "Expert du Quotidien", desc: "RÃ©ussir 10 dÃ©fis du jour", icon: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Sun%20with%20Face.png" }
Â  Â  Â  Â  ];

Â  Â  Â  Â  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  Â  Â  function playSound(type) {
Â  Â  Â  Â  Â  Â  if(audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  Â  Â  const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
Â  Â  Â  Â  Â  Â  osc.connect(gainNode); gainNode.connect(audioCtx.destination);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (type === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
Â  Â  Â  Â  Â  Â  Â  Â  osc.start(); osc.stop(audioCtx.currentTime + 0.4);
Â  Â  Â  Â  Â  Â  } else if (type === 'error') {
Â  Â  Â  Â  Â  Â  Â  Â  osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
Â  Â  Â  Â  Â  Â  Â  Â  osc.start(); osc.stop(audioCtx.currentTime + 0.3);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyCig9G4gYHU5h642YV1IZxthYm_IXp6vZU",
Â  Â  Â  Â  Â  Â  authDomain: "medicome-paco.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "medicome-paco",
Â  Â  Â  Â  Â  Â  storageBucket: "medicome-paco.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "332171806096",
Â  Â  Â  Â  Â  Â  appId: "1:332171806096:web:36889325196a7a718b5f15",
Â  Â  Â  Â  Â  Â  measurementId: "G-81HJ9DWBMX"
Â  Â  Â  Â  };

Â  Â  Â  Â  let app, auth, db;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erreur Firebase:", error);
Â  Â  Â  Â  Â  Â  document.querySelector('#app').innerHTML = `<div class="alert alert-error">Erreur de configuration : ${error.message}</div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  let PATHOLOGIES = [];
Â  Â  Â  Â  const ACCESS_CODES = [ { code: "SuperCode1", pseudo:"Admin" } ];

Â  Â  Â  Â  let state = {
Â  Â  Â  Â  Â  Â  currentUser: null, pseudo: null,Â 
Â  Â  Â  Â  Â  Â  progression: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {},
Â  Â  Â  Â  Â  Â  Â  Â  pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  isGuest: false, demo:{}, currentSign:null, answers:{}, asked:[], allSigns:[], ranked: [], diagnosticShown:false, previousDiagnostics:[],
Â  Â  Â  Â  Â  Â  history: [],
Â  Â  Â  Â  Â  Â  confirmationMode: false, confirmationQueue: [], confirmedPatho: null,
Â  Â  Â  Â  Â  Â  priorityQueue: [],
Â  Â  Â  Â  Â  Â  isChrono: false, startTime: null, dailyTarget: null
Â  Â  Â  Â  };

Â  Â  Â  Â  function toggleTheme() {
Â  Â  Â  Â  Â  Â  const body = document.body;
Â  Â  Â  Â  Â  Â  const current = body.getAttribute('data-theme');
Â  Â  Â  Â  Â  Â  const newTheme = current === 'light' ? 'dark' : 'light';
Â  Â  Â  Â  Â  Â  body.setAttribute('data-theme', newTheme);
Â  Â  Â  Â  Â  Â  localStorage.setItem('medicome_theme', newTheme);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function loadTheme() {
Â  Â  Â  Â  Â  Â  const saved = localStorage.getItem('medicome_theme');
Â  Â  Â  Â  Â  Â  if(saved) document.body.setAttribute('data-theme', saved);
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('themeBtn');
Â  Â  Â  Â  Â  Â  if(btn) btn.onclick = toggleTheme;
Â  Â  Â  Â  }

Â  Â  Â  Â  function getDailyPatho() {
Â  Â  Â  Â  Â  Â  if(PATHOLOGIES.length === 0) return null;
Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();Â 
Â  Â  Â  Â  Â  Â  let hash = 0;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < today.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  hash = today.charCodeAt(i) + ((hash << 5) - hash);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const index = Math.abs(hash) % PATHOLOGIES.length;
Â  Â  Â  Â  Â  Â  return PATHOLOGIES[index];
Â  Â  Â  Â  }

Â  Â  Â  Â  async function initApp() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('./pathologies.json');
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error("Impossible de lire le fichier de donnÃ©es pathologies.json");
Â  Â  Â  Â  Â  Â  Â  Â  PATHOLOGIES = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  Â  Â  const ficheDemandee = urlParams.get('fiche');
Â  Â  Â  Â  Â  Â  Â  Â  if (ficheDemandee) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pathoTrouvee = PATHOLOGIES.find(p => p.name.toLowerCase() === ficheDemandee.toLowerCase());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pathoTrouvee) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  q('#app').innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDiagnosticDetails({patho: pathoTrouvee});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadTheme();
Â  Â  Â  Â  Â  Â  Â  Â  startAuthListener();
Â  Â  Â  Â  Â  Â  Â  Â  fetchNotifications();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const btnLegal = q('#legalLink');
Â  Â  Â  Â  Â  Â  Â  Â  if(btnLegal) btnLegal.onclick = renderLegalPage;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cLink = q('#contactLink');
Â  Â  Â  Â  Â  Â  Â  Â  if(cLink) cLink.onclick = renderContact;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const rLink = q('#reviewsLink');
Â  Â  Â  Â  Â  Â  Â  Â  if(rLink) rLink.onclick = renderReviews;

Â  Â  Â  Â  Â  Â  Â  Â  ['linkInsta', 'linkTiktok', 'linkX'].forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(el) el.addEventListener('click', trackSocial);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const notifBtn = q('#notifBtn');
Â  Â  Â  Â  Â  Â  Â  Â  const notifModal = q('#notifModal');
Â  Â  Â  Â  Â  Â  Â  Â  if(notifBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notifBtn.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isVisible = notifModal.style.display === 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notifModal.style.display = isVisible ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!isVisible) { const badge = q('#notifBadge'); if(badge) badge.style.display = 'none'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  window.onclick = () => { if(notifModal) notifModal.style.display = 'none'; };

Â  Â  Â  Â  Â  Â  Â  Â  const brandLogo = document.getElementById('brandLogo');
Â  Â  Â  Â  Â  Â  Â  Â  if(brandLogo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  brandLogo.onclick = () => { if (state.currentUser || state.isGuest) { renderHome(); } };
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('keydown', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (q('.question-text')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'ArrowRight' || e.key === 'y' || e.key === 'o') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.querySelector('.btn-success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(btn) btn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (e.key === 'ArrowLeft' || e.key === 'n') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.querySelector('.btn-error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(btn) btn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (e.key === 'ArrowUp' || e.key === 'i' || e.key === ' ') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btns = document.querySelectorAll('.button-group .link');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(btns.length > 0) btns[0].click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.querySelector('.btn-success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(btn) btn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const primaryBtn = q('.btn');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(primaryBtn && primaryBtn.offsetParent !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primaryBtn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Escape') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const notifModal = q('#notifModal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(notifModal && notifModal.style.display === 'block') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notifModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (!q('.question-text')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderHome();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#app').innerHTML = `<div class="card center"><h2 style="color:var(--error)">Erreur de chargement</h2><div class="small" style="color:orange">${err.message}</div></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  initApp();

Â  Â  Â  Â  async function fetchNotifications() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const qRef = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await getDocs(qRef);
Â  Â  Â  Â  Â  Â  Â  Â  const container = q('#notifContent');
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) { container.innerHTML = '<div class="small">Aucune nouveautÃ© pour le moment.</div>'; return; }
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const n = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'notif-item';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = n.date && n.date.seconds ? new Date(n.date.seconds * 1000).toLocaleDateString() : 'RÃ©cemment';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `<div class="notif-date">${dateStr}</div><div style="color:var(--text-main);">${n.message}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const badge = q('#notifBadge');
Â  Â  Â  Â  Â  Â  Â  Â  if(badge) badge.style.display = 'block';
Â  Â  Â  Â  Â  Â  } catch (e) { console.log("Erreur notifs", e); }
Â  Â  Â  Â  }

Â  Â  Â  Â  function startAuthListener() {
Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentUser = user; state.isGuest = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let displayPseudo = user.displayName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!displayPseudo && user.email) displayPseudo = user.email.split('@')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.pseudo = displayPseudo; updateHeader();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, "users", user.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(docRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.pseudo) state.pseudo = data.pseudo;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression = { ...state.progression, ...data.progression };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { saveProgression(); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeader(); renderHome();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { renderHome(); }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedGuest = localStorage.getItem('medicome_guest_progression');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedPseudo = localStorage.getItem('medicome_guest_pseudo');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.isGuest && savedGuest && savedPseudo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.isGuest = true; state.pseudo = savedPseudo;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parsed = JSON.parse(savedGuest);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression = { ...state.progression, ...parsed };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.progression.streak === undefined) state.progression.streak = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.mastery) state.progression.mastery = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeader(); renderHome();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => showAlert(`Bon retour, ${state.pseudo} !`, 'success'), 500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentUser = null; state.pseudo = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderLogin(); updateHeader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function q(sel){ return document.querySelector(sel); }
Â  Â  Â  Â  function formatSigneName(sign){ return sign.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }
Â  Â  Â  Â  function showAlert(message,type){
Â  Â  Â  Â  Â  Â  const alertDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  alertDiv.className = 'alert alert-' + type;
Â  Â  Â  Â  Â  Â  alertDiv.textContent = message;
Â  Â  Â  Â  Â  Â  const app = q('#app');
Â  Â  Â  Â  Â  Â  if(app){ app.insertBefore(alertDiv,app.firstChild); setTimeout(()=>{ if(alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv); },3000); }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function triggerConfetti() {
Â  Â  Â  Â  Â  Â  if(window.confetti) { window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveProgression() {
Â  Â  Â  Â  Â  Â  checkAchievements();
Â  Â  Â  Â  Â  Â  if (!state.isGuest && state.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userRef = doc(db, "users", state.currentUser.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(userRef, { progression: state.progression, pseudo: state.pseudo, lastUpdate: new Date() }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) { console.error("Erreur sauvegarde Cloud", e); }
Â  Â  Â  Â  Â  Â  } else if (state.isGuest) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('medicome_guest_pseudo', state.pseudo);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function checkAchievements() {
Â  Â  Â  Â  Â  Â  if(!state.progression.achievements) state.progression.achievements = [];
Â  Â  Â  Â  Â  Â  const unlock = (id) => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.achievements.includes(id)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.achievements.push(id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`ğŸ† SuccÃ¨s dÃ©bloquÃ© !`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  triggerConfetti();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const p = state.progression;
Â  Â  Â  Â  Â  Â  if(p.correct >= 1) unlock('baby_doc');
Â  Â  Â  Â  Â  Â  if(p.correct >= 25) unlock('med_student');
Â  Â  Â  Â  Â  Â  if(p.correct >= 50) unlock('intern');
Â  Â  Â  Â  Â  Â  if(p.correct >= 100) unlock('chief');
Â  Â  Â  Â  Â  Â  if(p.reviewDone) unlock('critic');
Â  Â  Â  Â  Â  Â  if(p.socialDone) unlock('fan');
Â  Â  Â  Â  Â  Â  if(p.pdfDownloads >= 1) unlock('bookworm_1');
Â  Â  Â  Â  Â  Â  if(p.pdfDownloads >= 25) unlock('bookworm_25');
Â  Â  Â  Â  Â  Â  if(p.pdfDownloads >= 50) unlock('bookworm_50');
Â  Â  Â  Â  Â  Â  if(p.pdfDownloads >= 100) unlock('bookworm_100');
Â  Â  Â  Â  Â  Â  if((p.dailyStreak || 0) >= 10) unlock('daily_10');
Â  Â  Â  Â  Â  Â  if(p.speedWins >= 10) unlock('speed_demon');Â 
Â  Â  Â  Â  Â  Â  if(p.speedWins >= 50) unlock('speed_50');
Â  Â  Â  Â  Â  Â  if(p.speedWins >= 100) unlock('speed_100');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const unlockedCount = Object.keys(p.mastery || {}).filter(k => p.mastery[k].success > 0).length;
Â  Â  Â  Â  Â  Â  const masterCount = Object.keys(p.mastery || {}).filter(k => p.mastery[k].success >= 10).length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(masterCount >= 5) unlock('master_5');
Â  Â  Â  Â  Â  Â  if(masterCount >= 30) unlock('master_30');
Â  Â  Â  Â  Â  Â  if(masterCount >= 100) unlock('master_100');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(unlockedCount >= PATHOLOGIES.length && PATHOLOGIES.length > 0) unlock('encyclopedia');
Â  Â  Â  Â  Â  Â  if(masterCount >= PATHOLOGIES.length && PATHOLOGIES.length > 0) unlock('god_mode');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function trackPdf() {
Â  Â  Â  Â  Â  Â  state.progression.pdfDownloads = (state.progression.pdfDownloads || 0) + 1;
Â  Â  Â  Â  Â  Â  saveProgression();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function trackSocial() {
Â  Â  Â  Â  Â  Â  if(!state.progression.socialDone) {
Â  Â  Â  Â  Â  Â  Â  Â  state.progression.socialDone = true;
Â  Â  Â  Â  Â  Â  Â  Â  saveProgression();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateHeader(){
Â  Â  Â  Â  Â  Â  const pseudoBox = q("#pseudoBox"); const homeBtn = q("#homeBtn"); const logoutBtn = q("#logoutBtn");
Â  Â  Â  Â  Â  Â  const currentStreak = state.progression.streak || 0;
Â  Â  Â  Â  Â  Â  const streakDisplay = currentStreak > 0 ? ` <span style="color:#ff9f43; margin-left:8px;"><img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Fire.png" style="width:1.2em;height:1.2em;vertical-align:middle;"> ${currentStreak}</span>` : '';

Â  Â  Â  Â  Â  Â  if(state.pseudo){Â 
Â  Â  Â  Â  Â  Â  Â  Â  pseudoBox.innerHTML = state.pseudo + (state.isGuest ? " (Local)" : "") + streakDisplay;Â 
Â  Â  Â  Â  Â  Â  Â  Â  pseudoBox.style.display='inline-block'; pseudoBox.onclick=renderProfile;
Â  Â  Â  Â  Â  Â  Â  Â  homeBtn.style.display='inline-block'; logoutBtn.style.display='inline-block';
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  pseudoBox.style.display='none'; homeBtn.style.display='none'; logoutBtn.style.display='none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  homeBtn.onclick=renderHome;
Â  Â  Â  Â  Â  Â  logoutBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('medicome_guest_progression'); localStorage.removeItem('medicome_guest_pseudo');
Â  Â  Â  Â  Â  Â  Â  Â  state.isGuest = false; state.pseudo = null; state.currentUser = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  state.progression = { correct: 0, incorrect: 0, streak: 0, mastery: {}, dailyStreak: 0, lastDaily: null, achievements: [], bestTimes: {}, errorLog: {}, pdfDownloads: 0, speedWins: 0, socialDone: false, reviewDone: false };Â 
Â  Â  Â  Â  Â  Â  Â  Â  signOut(auth).then(() => { renderLogin(); updateHeader(); showAlert("DÃ©connectÃ©", "success"); }).catch(() => { renderLogin(); updateHeader(); });
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderLogin() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center'; card.innerHTML='<h2>â˜ï¸ Connexion Cloud</h2>';
Â  Â  Â  Â  Â  Â  const inputUser = document.createElement('input'); inputUser.placeholder='Email'; inputUser.className='input';
Â  Â  Â  Â  Â  Â  const inputPass = document.createElement('input'); inputPass.placeholder='Mot de passe'; inputPass.className='input'; inputPass.type='password';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnLogin = document.createElement('button'); btnLogin.className='btn'; btnLogin.textContent='Se connecter';
Â  Â  Â  Â  Â  Â  btnLogin.onclick = async () => { try { await signInWithEmailAndPassword(auth, inputUser.value, inputPass.value); showAlert("Connexion rÃ©ussie !", "success"); } catch (error) { showAlert("Erreur: " + error.message, "error"); } };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnForgot = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  btnForgot.className='small link'; btnForgot.style.border='none'; btnForgot.textContent='Mot de passe oubliÃ© ?';
Â  Â  Â  Â  Â  Â  btnForgot.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!inputUser.value) return showAlert("Veuillez entrer votre email d'abord", "error");
Â  Â  Â  Â  Â  Â  Â  Â  try { await sendPasswordResetEmail(auth, inputUser.value); showAlert("Email de rÃ©initialisation envoyÃ© !", "success"); } catch(e) { showAlert("Erreur: " + e.message, "error"); }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  card.appendChild(inputUser); card.appendChild(inputPass); card.appendChild(btnLogin); card.appendChild(btnForgot);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const sep = document.createElement('div'); sep.textContent='â€” Pas encore de compte ? â€”'; sep.className='small'; sep.style.margin='16px 0'; card.appendChild(sep);
Â  Â  Â  Â  Â  Â  const inRegEmail = document.createElement('input'); inRegEmail.placeholder='Nouvel Email'; inRegEmail.className='input';
Â  Â  Â  Â  Â  Â  const inRegPass = document.createElement('input'); inRegPass.placeholder='Nouveau Mot de passe'; inRegPass.className='input'; inRegPass.type='password';
Â  Â  Â  Â  Â  Â  const inPseudo = document.createElement('input'); inPseudo.placeholder='Votre Pseudo'; inPseudo.className='input';
Â  Â  Â  Â  Â  Â  const btnReg = document.createElement('button'); btnReg.className='link'; btnReg.textContent='CrÃ©er un compte Cloud';
Â  Â  Â  Â  Â  Â  btnReg.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!inRegEmail.value || !inRegPass.value || !inPseudo.value) return showAlert('Remplissez tout','error');
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await createUserWithEmailAndPassword(auth, inRegEmail.value, inRegPass.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const user = userCredential.user; await updateProfile(user, { displayName: inPseudo.value });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, "users", user.uid), { pseudo: inPseudo.value, email: inRegEmail.value, progression: { correct: 0, incorrect: 0, streak: 0, mastery: {} }, createdAt: new Date() }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.pseudo = inPseudo.value; showAlert("Compte crÃ©Ã© !", "success"); updateHeader(); renderHome();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { showAlert("Erreur crÃ©ation: " + error.message, "error"); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  card.appendChild(inRegEmail); card.appendChild(inRegPass); card.appendChild(inPseudo); card.appendChild(btnReg);
Â  Â  Â  Â  Â  Â  const sepCode = document.createElement('div'); sepCode.textContent='â€” ou AccÃ¨s Rapide (Local) â€”'; sepCode.className='small'; sepCode.style.margin='16px 0'; card.appendChild(sepCode);
Â  Â  Â  Â  Â  Â  const inputCode = document.createElement('input'); inputCode.placeholder='ClÃ© d\'accÃ¨s'; inputCode.className='input';
Â  Â  Â  Â  Â  Â  const btnCode = document.createElement('button'); btnCode.className='btn btn-code'; btnCode.textContent='Utiliser une clÃ©';
Â  Â  Â  Â  Â  Â  btnCode.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const codeFound = ACCESS_CODES.find(ac => ac.code === inputCode.value);
Â  Â  Â  Â  Â  Â  Â  Â  if(codeFound) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.isGuest = true; state.pseudo = codeFound.pseudo; state.progression = {correct:0, incorrect:0, streak:0, mastery:{}};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveProgression(); updateHeader(); renderHome(); showAlert(`Mode InvitÃ©: ${codeFound.pseudo}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } else { showAlert('ClÃ© invalide', 'error'); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  card.appendChild(inputCode); card.appendChild(btnCode); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderHome() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const prog = state.progression;
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  let cloudBadge = state.isGuest ? '<span style="color:orange; font-size:0.8em; margin-bottom:10px">ğŸ’¾ Mode Local (Navigateur)</span>' : '<span style="color:var(--success); font-size:0.8em; margin-bottom:10px">â˜ï¸ Sauvegarde Active</span>';
Â  Â  Â  Â  Â  Â  const displayName = state.pseudo || '...';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CAS DU JOUR
Â  Â  Â  Â  Â  Â  const dailyPatho = getDailyPatho();
Â  Â  Â  Â  Â  Â  const todayStr = new Date().toDateString();
Â  Â  Â  Â  Â  Â  const isDailyDone = prog.lastDaily === todayStr;
Â  Â  Â  Â  Â  Â  const dailyClass = isDailyDone ? "daily-title" : "daily-title";Â 
Â  Â  Â  Â  Â  Â  const dailyText = isDailyDone ? "âœ… DÃ©fi du jour validÃ© !" : `â˜€ï¸ DÃ©fi du ${new Date().toLocaleDateString()}`;
Â  Â  Â  Â  Â  Â  const dailyContent = isDailyDone ? "Revenez demain pour une nouvelle streak !" : `Faire identifier : <strong>${dailyPatho ? dailyPatho.name : 'Chargement...'}</strong>`;

Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2 style="display:flex;align-items:center;gap:10px;"><img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Hand%20gestures/Waving%20Hand.png" style="width:1.2em;height:1.2em;"> Bonjour ${displayName}</h2>${cloudBadge}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="daily-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="${dailyClass}">${dailyText}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.9em; color:var(--text-main); margin-bottom:5px;">${dailyContent}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!isDailyDone ? `<button id="btnDaily" class="btn" style="background:var(--gold); color:#000; font-size:12px; padding:8px 15px; margin-top:5px;">Relever le dÃ©fi</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-box" style="width:100%"><div class="stat-number">${prog.correct + prog.incorrect}</div><div class="stat-label">Cas jouÃ©s</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-top:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-box" style="text-align:center; background:rgba(0, 255, 157, 0.1); border-color:var(--success)"><div class="stat-number" style="color:var(--success);">${prog.correct}</div><div class="stat-label">SuccÃ¨s</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-box" style="text-align:center; background:rgba(255, 77, 77, 0.1); border-color:var(--error)"><div class="stat-number" style="color:var(--error);">${prog.incorrect}</div><div class="stat-label">Ã‰checs</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnDiag = document.createElement('button'); btnDiag.className='btn'; btnDiag.textContent='ğŸ©º EntraÃ®nement Libre'; btnDiag.style.marginTop='24px'; btnDiag.style.width='100%';Â 
Â  Â  Â  Â  Â  Â  btnDiag.onclick= () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  Â  Â  Â  Â  state.dailyTarget = null;
Â  Â  Â  Â  Â  Â  Â  Â  renderDemographics();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const btnGloss = document.createElement('button'); btnGloss.className='link'; btnGloss.textContent='ğŸ“š Glossaire des pathologies'; btnGloss.style.marginTop='12px'; btnGloss.onclick=renderGlossary;
Â  Â  Â  Â  Â  Â  const btnProf = document.createElement('button'); btnProf.className='link'; btnProf.textContent='ğŸ‘¤ Mon Profil & SuccÃ¨s'; btnProf.style.marginTop='6px'; btnProf.onclick=renderProfile;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.appendChild(btnDiag); card.appendChild(btnGloss); card.appendChild(btnProf);Â 
Â  Â  Â  Â  Â  Â  app.appendChild(card);

Â  Â  Â  Â  Â  Â  // Handler Daily
Â  Â  Â  Â  Â  Â  const btnDaily = q('#btnDaily');
Â  Â  Â  Â  Â  Â  if(btnDaily) {
Â  Â  Â  Â  Â  Â  Â  Â  btnDaily.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.dailyTarget = dailyPatho;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.isChrono = false; // Pas de chrono forcÃ© en daily
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDemographics();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NEW REVIEWS SYSTEM ---
Â  Â  Â  Â  async function renderReviews() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2>â­ Avis Utilisateurs</h2><p class="small" style="margin-bottom:20px">Ce qu'ils pensent de Medicome.</p>`;

Â  Â  Â  Â  Â  Â  const formDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  formDiv.style.background = 'rgba(125,125,125,0.1)'; formDiv.style.padding='15px'; formDiv.style.borderRadius='10px'; formDiv.style.width='100%'; formDiv.style.marginBottom='20px';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  formDiv.innerHTML = `<h4 style="margin-bottom:10px; color:var(--accent);">Laisser un avis</h4>
Â  Â  Â  Â  Â  Â  <div class="star-rating">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">â˜…</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">â˜…</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">â˜…</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">â˜…</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">â˜…</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <textarea id="reviewText" class="input" placeholder="Votre commentaire..." style="min-height:60px;"></textarea>
Â  Â  Â  Â  Â  Â  <button id="submitReviewBtn" class="btn" style="width:100%; font-size:13px;">Envoyer (Soumis Ã  modÃ©ration)</button>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.appendChild(formDiv);

Â  Â  Â  Â  Â  Â  const reviewsContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  reviewsContainer.className = 'reviews-container';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Charger avis Firebase
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const qRev = query(collection(db, "reviews"), where("approved", "==", true), orderBy("date", "desc"), limit(10));
Â  Â  Â  Â  Â  Â  Â  Â  const snap = await getDocs(qRev);
Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const stars = "â˜…".repeat(r.rating) + "â˜†".repeat(5-r.rating);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'review-card';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="review-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><div class="review-name">${r.pseudo}</div><div class="review-stars" style="color:var(--gold)">${stars}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="review-text">${r.text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reviewsContainer.insertBefore(div, reviewsContainer.firstChild);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } catch(e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Erreur avis", e);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(e.code === 'failed-precondition') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const qRevBackup = query(collection(db, "reviews"), where("approved", "==", true), limit(10));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const snap = await getDocs(qRevBackup);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â snap.forEach(doc => { /* Affichage simplifiÃ© backup */ });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  card.appendChild(reviewsContainer);
Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
Â  Â  Â  Â  Â  Â  btnBack.style.marginTop = '20px'; btnBack.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
Â  Â  Â  Â  Â  Â  card.appendChild(btnBack); app.appendChild(card);

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const submitBtn = q('#submitReviewBtn');
Â  Â  Â  Â  Â  Â  Â  Â  if(submitBtn){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const text = q('#reviewText').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ratingEl = document.querySelector('input[name="rating"]:checked');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!text || !ratingEl) return showAlert("Note et message requis", "error");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, "reviews"), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pseudo: state.pseudo || "Anonyme",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rating: parseInt(ratingEl.value),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: new Date(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  approved: falseÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert("Avis envoyÃ© ! Il sera visible aprÃ¨s validation.", "success");Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // UNLOCK ACHIEVEMENT REVIEW
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.reviewDone) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.reviewDone = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveProgression();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  q('#reviewText').value = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { showAlert("Erreur d'envoi", "error"); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ABANDON MENU ---
Â  Â  Â  Â  function renderAbandonMenu() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML = '';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2>Abandonner ?</h2><p class="small">Vous arrÃªtez le cas clinique en cours.</p>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnHome = document.createElement('button'); btnHome.className='btn'; btnHome.textContent='ğŸ  Juste arrÃªter (Retour Accueil)';
Â  Â  Â  Â  Â  Â  btnHome.onclick = renderHome;

Â  Â  Â  Â  Â  Â  const divSearch = document.createElement('div');
Â  Â  Â  Â  Â  Â  divSearch.style.marginTop = '20px'; divSearch.style.width = '100%';
Â  Â  Â  Â  Â  Â  divSearch.innerHTML = `<p style="margin-bottom:10px; color:var(--accent);">Je pensais Ã  une pathologie prÃ©cise (C'Ã©tait une erreur de l'IA) :</p>`;
Â  Â  Â  Â  Â  Â  const select = document.createElement('select'); select.className = 'input';
Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">-- Choisir la pathologie --</option>';
Â  Â  Â  Â  Â  Â  PATHOLOGIES.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  select.onchange = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!select.value) return;
Â  Â  Â  Â  Â  Â  Â  Â  const patho = PATHOLOGIES.find(p=>p.name === select.value);
Â  Â  Â  Â  Â  Â  Â  Â  state.progression.incorrect++;
Â  Â  Â  Â  Â  Â  Â  Â  saveProgression();
Â  Â  Â  Â  Â  Â  Â  Â  showDiagnosticDetails({patho: patho}, true);Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  divSearch.appendChild(select);

Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='Annuler, reprendre';
Â  Â  Â  Â  Â  Â  btnBack.onclick = renderCurrentQuestion;

Â  Â  Â  Â  Â  Â  card.append(btnHome, divSearch, btnBack);
Â  Â  Â  Â  Â  Â  app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PROFILE & BADGES ---
Â  Â  Â  Â  function renderProfile() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const prog = state.progression;
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center'; card.style.maxWidth = '800px';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Prepare HTML Content first
Â  Â  Â  Â  Â  Â  let contentHTML = `<h2>ğŸ‘¤ Profil de ${state.pseudo}</h2>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const groupScores = {};
Â  Â  Â  Â  Â  Â  let maxScore = 0; let bestGroup = null;
Â  Â  Â  Â  Â  Â  Object.keys(prog.mastery || {}).forEach(pName => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = prog.mastery[pName];
Â  Â  Â  Â  Â  Â  Â  Â  const count = (typeof data === 'number') ? data : (data.success || 0);
Â  Â  Â  Â  Â  Â  Â  Â  if(count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const group = PATHO_GROUPS[pName] || "Autre";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!groupScores[group]) groupScores[group] = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupScores[group] += count;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(groupScores[group] > maxScore) { maxScore = groupScores[group]; bestGroup = group; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if(bestGroup && maxScore >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="specialty-badge">ğŸ–ï¸ SpÃ©cialiste ${bestGroup}</div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const totalPathos = PATHOLOGIES.length;
Â  Â  Â  Â  Â  Â  const unlockedPathos = Object.keys(prog.mastery || {}).filter(k => {
Â  Â  Â  Â  Â  Â  Â  Â  const d = prog.mastery[k];
Â  Â  Â  Â  Â  Â  Â  Â  const s = (typeof d === 'number') ? d : d.success;
Â  Â  Â  Â  Â  Â  Â  Â  return s > 0;
Â  Â  Â  Â  Â  Â  }).length;
Â  Â  Â  Â  Â  Â  const percentage = totalPathos > 0 ? Math.round((unlockedPathos / totalPathos) * 100) : 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  contentHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="width:100%; background:rgba(125,125,125,0.1); border-radius:10px; height:10px; margin-bottom:5px; overflow:hidden;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="width:${percentage}%; background:var(--accent); height:100%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small" style="margin-bottom:30px;">Progression globale : ${percentage}% (${unlockedPathos}/${totalPathos})</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Set InnerHTML
Â  Â  Â  Â  Â  Â  card.innerHTML = contentHTML;

Â  Â  Â  Â  Â  Â  // 3. Create Button Element and insert it into DOM (Correcting the bug where onclick was lost)
Â  Â  Â  Â  Â  Â  const btnAch = document.createElement('button');Â 
Â  Â  Â  Â  Â  Â  btnAch.className='btn';Â 
Â  Â  Â  Â  Â  Â  btnAch.style.background = 'var(--gold)';Â 
Â  Â  Â  Â  Â  Â  btnAch.style.color = 'black';Â 
Â  Â  Â  Â  Â  Â  btnAch.style.marginBottom = '20px';
Â  Â  Â  Â  Â  Â  btnAch.textContent = 'ğŸ† Voir mes SuccÃ¨s';
Â  Â  Â  Â  Â  Â  btnAch.onclick = renderAchievementsPage;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Insert after the title (child 0 is h2, so insert before child 1)
Â  Â  Â  Â  Â  Â  if(card.children.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  card.insertBefore(btnAch, card.children[1]);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(btnAch);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 4. Create and append other DOM elements
Â  Â  Â  Â  Â  Â  // ERROR TRACKER
Â  Â  Â  Â  Â  Â  const errorTracker = document.createElement('div');
Â  Â  Â  Â  Â  Â  errorTracker.className = 'error-tracker';
Â  Â  Â  Â  Â  Â  errorTracker.innerHTML = `<h3 style="color:var(--error); font-size:16px;">âš ï¸ BoÃ®te Ã  Erreurs (Suivi)</h3>`;
Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  let hasErrors = false;
Â  Â  Â  Â  Â  Â  Object.entries(prog.errorLog || {}).forEach(([pName, data]) => {
Â  Â  Â  Â  Â  Â  Â  Â  if(now - data.date > 7 * 24 * 60 * 60 * 1000) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasErrors = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.className = 'error-item';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.innerHTML = `<span>${pName}</span> <span style="opacity:0.7">Ã€ revoir !</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorTracker.appendChild(item);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(!hasErrors) errorTracker.innerHTML += `<div class="small">Aucune pathologie oubliÃ©e depuis 1 semaine. Bien jouÃ© !</div>`;
Â  Â  Â  Â  Â  Â  card.appendChild(errorTracker);

Â  Â  Â  Â  Â  Â  // MASTERY GRID
Â  Â  Â  Â  Â  Â  const masteryTitle = document.createElement('h3'); masteryTitle.innerHTML = 'Maitrise Clinique';Â 
Â  Â  Â  Â  Â  Â  masteryTitle.style.marginTop = "30px";
Â  Â  Â  Â  Â  Â  card.appendChild(masteryTitle);

Â  Â  Â  Â  Â  Â  const masteryGrid = document.createElement('div'); masteryGrid.className = 'mastery-grid';
Â  Â  Â  Â  Â  Â  const sortedPathos = [...PATHOLOGIES].sort((a, b) => a.name.localeCompare(b.name));
Â  Â  Â  Â  Â  Â  const masteryData = prog.mastery || {};

Â  Â  Â  Â  Â  Â  sortedPathos.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const m = masteryData[p.name];
Â  Â  Â  Â  Â  Â  Â  Â  const successCount = (typeof m === 'number') ? m : (m?.success || 0);
Â  Â  Â  Â  Â  Â  Â  Â  const mItem = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  let sClass = 'm-locked', icon = '<div class="locked-icon">ğŸ”’</div>';
Â  Â  Â  Â  Â  Â  Â  Â  if (successCount >= 10) { sClass = 'm-master'; icon = '<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Gem%20Stone.png">'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (successCount >= 5) { sClass = 'm-gold'; icon = '<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/1st%20Place%20Medal.png">'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (successCount >= 3) { sClass = 'm-silver'; icon = '<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/2nd%20Place%20Medal.png">'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (successCount >= 1) { sClass = 'm-bronze'; icon = '<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/3rd%20Place%20Medal.png">'; }

Â  Â  Â  Â  Â  Â  Â  Â  mItem.className = `mastery-item ${sClass}`;
Â  Â  Â  Â  Â  Â  Â  Â  mItem.innerHTML = `<div class="mastery-icon">${icon}</div><div class="mastery-name">${p.name}</div><div class="mastery-count">${successCount} rÃ©ussite(s)</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  mItem.onclick = () => renderPathoStats(p); // Click to see stats
Â  Â  Â  Â  Â  Â  Â  Â  masteryGrid.appendChild(mItem);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  card.appendChild(masteryGrid);

Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
Â  Â  Â  Â  Â  Â  btnBack.style.marginTop='20px'; btnBack.onclick=renderHome;
Â  Â  Â  Â  Â  Â  card.appendChild(btnBack); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NOUVELLE PAGE: SUCCÃˆS (MISE A JOUR EN GRILLE AVEC IMAGES) ---
Â  Â  Â  Â  function renderAchievementsPage() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML = '';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center'; card.style.maxWidth = '800px';
Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2 style="color:var(--gold)">ğŸ† Mes SuccÃ¨s</h2>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const prog = state.progression;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CrÃ©ation du conteneur grille
Â  Â  Â  Â  Â  Â  const grid = document.createElement('div');
Â  Â  Â  Â  Â  Â  grid.className = 'achievements-grid';

Â  Â  Â  Â  Â  Â  ACHIEVEMENTS.forEach(ach => {
Â  Â  Â  Â  Â  Â  Â  Â  const unlocked = (prog.achievements || []).includes(ach.id);
Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  row.className = `achievement-row ${unlocked ? 'unlocked' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- MODIFICATION: GESTION IMAGE VS CADENAS ---
Â  Â  Â  Â  Â  Â  Â  Â  let iconHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (unlocked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  iconHTML = `<img src="${ach.icon}" class="ach-img" alt="${ach.title}">`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  iconHTML = `<div class="locked-icon">ğŸ”’</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ach-icon">${iconHTML}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ach-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ach-title" style="color:${unlocked ? 'var(--text-main)' : 'var(--text-muted)'}">${ach.title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ach-desc">${ach.desc}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(row);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.appendChild(grid);

Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour au Profil';
Â  Â  Â  Â  Â  Â  btnBack.style.marginTop = '20px';
Â  Â  Â  Â  Â  Â  btnBack.onclick = renderProfile; // RETOURNE AU PROFIL
Â  Â  Â  Â  Â  Â  card.appendChild(btnBack);
Â  Â  Â  Â  Â  Â  app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NOUVELLE PAGE: MENTIONS LÃ‰GALES (REMPLACE LA MODALE) ---
Â  Â  Â  Â  function renderLegalPage() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML = '';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--text-main); margin-bottom:15px;">Mentions LÃ©gales</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:left; line-height:1.6;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>1. Ã‰diteur du site</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Le site Medicome.fr est Ã©ditÃ© Ã  titre personnel. <br>Contact : via le formulaire de contact du site.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>2. HÃ©bergement</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>HÃ©bergÃ© par GitHub Pages (USA). DonnÃ©es stockÃ©es sur Google Firebase (Irlande).</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>3. DonnÃ©es Personnelles</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Email uniquement pour authentification. Aucune revente.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
Â  Â  Â  Â  Â  Â  btnBack.style.marginTop = '20px';
Â  Â  Â  Â  Â  Â  // CORRECTION ICI: VÃ©rification de l'Ã©tat de connexion
Â  Â  Â  Â  Â  Â  btnBack.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
Â  Â  Â  Â  Â  Â  card.appendChild(btnBack);
Â  Â  Â  Â  Â  Â  app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderPathoStats(patho) {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  const m = (state.progression.mastery || {})[patho.name];
Â  Â  Â  Â  Â  Â  const wins = (typeof m === 'number') ? m : (m?.success || 0);
Â  Â  Â  Â  Â  Â  const loss = (m?.failures || 0);
Â  Â  Â  Â  Â  Â  const mistakes = (m?.missedSigns || {});
Â  Â  Â  Â  Â  Â  const bestTime = (state.progression.bestTimes || {})[patho.name];

Â  Â  Â  Â  Â  Â  let rank = 'VerrouillÃ©', icon='<div class="locked-icon">ğŸ”’</div>', color='var(--text-muted)';
Â  Â  Â  Â  Â  Â  if(wins >= 10) { rank='MaÃ®tre'; icon='<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Gem%20Stone.png" class="large-emoji">'; color='var(--ruby)'; }
Â  Â  Â  Â  Â  Â  else if(wins >= 5) { rank='Or'; icon='<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/1st%20Place%20Medal.png" class="large-emoji">'; color='var(--gold)'; }
Â  Â  Â  Â  Â  Â  else if(wins >= 3) { rank='Argent'; icon='<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/2nd%20Place%20Medal.png" class="large-emoji">'; color='var(--silver)'; }
Â  Â  Â  Â  Â  Â  else if(wins >= 1) { rank='Bronze'; icon='<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Activities/3rd%20Place%20Medal.png" class="large-emoji">'; color='var(--bronze)'; }

Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div>${icon}</div>
Â  Â  Â  Â  Â  Â  <h3 style="color:${color}; margin-bottom:10px;">Rang : ${rank}</h3>
Â  Â  Â  Â  Â  Â  ${bestTime ? `<div class="small" style="color:var(--accent); margin-bottom:20px;">âš¡ Record Chrono : ${bestTime.toFixed(1)}s</div>` : ''}
Â  Â  Â  Â  Â  Â  <h2>${patho.name}</h2>
Â  Â  Â  Â  Â  Â  <div class="patho-desc" style="margin-bottom:20px;">${patho.short}</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:15px; width:100%; margin-bottom:20px; justify-content:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-box" style="border-color:var(--success); max-width:150px;"><div class="stat-number" style="color:var(--success)">${wins}</div>RÃ©ussites</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-box" style="border-color:var(--error); max-width:150px;"><div class="stat-number" style="color:var(--error)">${loss}</div>Erreurs</div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  if(Object.keys(mistakes).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML += `<h3 style="color:var(--error); margin-top:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; width:100%;">âš ï¸ Vos oublis frÃ©quents</h3>`;
Â  Â  Â  Â  Â  Â  Â  Â  let html = '<ul style="text-align:left; color:var(--text-muted); margin-top:15px; width:100%;">';
Â  Â  Â  Â  Â  Â  Â  Â  Object.entries(mistakes).sort((a,b)=>b[1]-a[1]).forEach(([sign, count]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<li style="margin-bottom:5px;"><strong>${formatSigneName(sign)}</strong> <span style="opacity:0.6; font-size:0.9em;">(OubliÃ© ${count} fois)</span></li>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML += html;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour Profil';
Â  Â  Â  Â  Â  Â  btnBack.style.marginTop = '20px';
Â  Â  Â  Â  Â  Â  btnBack.onclick=renderProfile;
Â  Â  Â  Â  Â  Â  card.appendChild(btnBack); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderContact() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2>âœ‰ï¸ Nous Contacter</h2>`;
Â  Â  Â  Â  Â  Â  const inputName = document.createElement('input'); inputName.className='input'; inputName.placeholder='Votre Nom';
Â  Â  Â  Â  Â  Â  if(state.pseudo) inputName.value = state.pseudo;
Â  Â  Â  Â  Â  Â  const inputEmail = document.createElement('input'); inputEmail.className='input'; inputEmail.placeholder='Votre Email';
Â  Â  Â  Â  Â  Â  if(state.currentUser) inputEmail.value = state.currentUser.email;
Â  Â  Â  Â  Â  Â  const inputText = document.createElement('textarea'); inputText.className='input'; inputText.placeholder='Votre message...';
Â  Â  Â  Â  Â  Â  const btnSend = document.createElement('button'); btnSend.className='btn'; btnSend.textContent='Envoyer';
Â  Â  Â  Â  Â  Â  btnSend.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!inputText.value) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, "messages"), { name: inputName.value, email: inputEmail.value, message: inputText.value, date: new Date(), uid: state.currentUser ? state.currentUser.uid : 'guest' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert("EnvoyÃ© !", "success"); setTimeout(() => { if(state.pseudo) renderHome(); else renderLogin(); }, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { showAlert("Erreur", "error"); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const btnCancel = document.createElement('button'); btnCancel.className='link'; btnCancel.textContent='Annuler';
Â  Â  Â  Â  Â  Â  btnCancel.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
Â  Â  Â  Â  Â  Â  card.append(inputName, inputEmail, inputText, btnSend, btnCancel); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderDemographics() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card';
Â  Â  Â  Â  Â  Â  card.innerHTML=`<h3>ğŸ“‹ DonnÃ©es dÃ©mographiques</h3><p class="small" style="margin-bottom:20px">ParamÃ©trez le patient virtuel.</p>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Si c'est le dÃ©fi du jour, on affiche un message spÃ©cial
Â  Â  Â  Â  Â  Â  if(state.dailyTarget) {
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `<h3>â˜€ï¸ DÃ©fi du Jour</h3><p class="small" style="margin-bottom:20px; color:var(--gold);">Cible : ${state.dailyTarget.name}</p>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const createSel = (lbl, id, opts) => {
Â  Â  Â  Â  Â  Â  Â  Â  const l = document.createElement('label'); l.textContent=lbl; l.style.color='var(--accent)';
Â  Â  Â  Â  Â  Â  Â  Â  const s = document.createElement('select'); s.id=id; s.className='input';
Â  Â  Â  Â  Â  Â  Â  Â  opts.forEach(o=> { const op=document.createElement('option'); op.value=o[0]; op.textContent=o[1]; s.appendChild(op); });
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(l); card.appendChild(s);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  createSel("Sexe", "demo-sexe", [["rien","AlÃ©atoire / Inconnu"],["femme","Femme"],["homme","Homme"]]);
Â  Â  Â  Â  Â  Â  createSel("Plus de 30 ans ?", "demo-30", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
Â  Â  Â  Â  Â  Â  createSel("Plus de 65 ans ?", "demo-65", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
Â  Â  Â  Â  Â  Â  createSel("AntÃ©cÃ©dents familiaux ?", "demo-atcd", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
Â  Â  Â  Â  Â  Â  createSel("Fumeur ?", "demo-tabac", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CHRONO TOGGLE
Â  Â  Â  Â  Â  Â  if(!state.dailyTarget) { // Pas de chrono optionnel en daily (on peut l'imposer si on veut)
Â  Â  Â  Â  Â  Â  Â  Â  const chronoDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  chronoDiv.style.margin = '20px 0'; chronoDiv.style.textAlign='center';
Â  Â  Â  Â  Â  Â  Â  Â  const chronoLabel = document.createElement('label');Â 
Â  Â  Â  Â  Â  Â  Â  Â  chronoLabel.innerHTML = `<input type="checkbox" id="chronoToggle" style="margin-right:8px;"> âš¡ Mode Chrono (Facultatif)`;
Â  Â  Â  Â  Â  Â  Â  Â  chronoLabel.style.color = 'var(--text-main)'; chronoLabel.style.cursor='pointer';
Â  Â  Â  Â  Â  Â  Â  Â  chronoDiv.appendChild(chronoLabel);
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(chronoDiv);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const btnGroup = document.createElement('div'); btnGroup.className='button-group';
Â  Â  Â  Â  Â  Â  const btnStart = document.createElement('button'); btnStart.className='btn'; btnStart.textContent='â–¶ï¸ DÃ©marrer';
Â  Â  Â  Â  Â  Â  btnStart.onclick=()=>{Â 
Â  Â  Â  Â  Â  Â  Â  Â  state.demo = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  femme: q('#demo-sexe').value === 'femme', homme: q('#demo-sexe').value === 'homme',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plus_de_30ans: q('#demo-30').value === 'oui', plus_de_65ans: q('#demo-65').value === 'oui',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atcd_famille: q('#demo-atcd').value === 'oui', tabac: q('#demo-tabac').value === 'oui'
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  state.answers={}; state.asked=[]; state.diagnosticShown=false; state.previousDiagnostics=[]; state.history=[];
Â  Â  Â  Â  Â  Â  Â  Â  state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
Â  Â  Â  Â  Â  Â  Â  Â  state.priorityQueue = [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Chrono logic
Â  Â  Â  Â  Â  Â  Â  Â  if(state.dailyTarget) state.isChrono = false; // ou true si on veut timer le daily
Â  Â  Â  Â  Â  Â  Â  Â  else state.isChrono = q('#chronoToggle')?.checked || false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(state.isChrono) state.startTime = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  else state.startTime = null;

Â  Â  Â  Â  Â  Â  Â  Â  askNextQuestion();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const btnCancel = document.createElement('button'); btnCancel.className='link'; btnCancel.textContent='Annuler'; btnCancel.onclick=renderHome;
Â  Â  Â  Â  Â  Â  btnGroup.appendChild(btnStart); btnGroup.appendChild(btnCancel); card.appendChild(btnGroup); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function prepareSigns() {
Â  Â  Â  Â  Â  Â  let allSignsSet = new Set();
Â  Â  Â  Â  Â  Â  PATHOLOGIES.forEach(p => { Object.keys(p.signes).forEach(s => allSignsSet.add(s)); });
Â  Â  Â  Â  Â  Â  state.allSigns = Array.from(allSignsSet);
Â  Â  Â  Â  }

Â  Â  Â  Â  function rankPathologies() {
Â  Â  Â  Â  Â  Â  const scores = PATHOLOGIES.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Check if previously rejected
Â  Â  Â  Â  Â  Â  Â  Â  if (state.previousDiagnostics.includes(p.name)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { patho: p, score: -1 };Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  Â  Â  Â  Â  for(const facteur in p.facteurs){ if(state.demo[facteur] === true) score += p.facteurs[facteur]; }
Â  Â  Â  Â  Â  Â  Â  Â  for(const signe in p.signes){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ans = state.answers[signe];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(ans === true) score += p.signes[signe];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(ans === false) score -= (p.signes[signe] * 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return {patho:p, score: Math.max(0, score)};
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Filter out negative scores for probability calculation
Â  Â  Â  Â  Â  Â  const validScores = scores.filter(s => s.score >= 0);
Â  Â  Â  Â  Â  Â  const totalScore = validScores.reduce((sum, s) => sum + s.score, 0);

Â  Â  Â  Â  Â  Â  state.ranked = scores.map(s => ({
Â  Â  Â  Â  Â  Â  Â  Â  ...s,
Â  Â  Â  Â  Â  Â  Â  Â  // If score is -1, prob is 0. Otherwise calculate normally.
Â  Â  Â  Â  Â  Â  Â  Â  prob: (s.score === -1 || totalScore === 0) ? 0 : ((s.score / totalScore) * 100).toFixed(1)
Â  Â  Â  Â  Â  Â  })).sort((a,b)=>b.prob - a.prob);
Â  Â  Â  Â  }

Â  Â  Â  Â  function getNextSmartSign(rankedPathos, remainingSigns) {
Â  Â  Â  Â  Â  Â  if (rankedPathos.length < 2) return remainingSigns[Math.floor(Math.random() * remainingSigns.length)];
Â  Â  Â  Â  Â  Â  const top1 = rankedPathos[0].patho; const top2 = rankedPathos[1].patho;
Â  Â  Â  Â  Â  Â  let candidates = remainingSigns.map(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const w1 = top1.signes[s] || 0; const w2 = top2.signes[s] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  return { sign: s, score: Math.abs(w1 - w2) + (Math.random() * 0.1) };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  candidates.sort((a, b) => b.score - a.score);
Â  Â  Â  Â  Â  Â  let usefulCandidates = candidates.filter(c => c.score > 0.1);
Â  Â  Â  Â  Â  Â  if (usefulCandidates.length === 0) usefulCandidates = candidates;
Â  Â  Â  Â  Â  Â  const poolSize = Math.min(usefulCandidates.length, 5);
Â  Â  Â  Â  Â  Â  const topPool = usefulCandidates.slice(0, poolSize);
Â  Â  Â  Â  Â  Â  return topPool[Math.floor(Math.random() * topPool.length)].sign;
Â  Â  Â  Â  }

Â  Â  Â  Â  function canShowDiagnostic() {
Â  Â  Â  Â  Â  Â  const qNum = state.asked.length;
Â  Â  Â  Â  Â  Â  if(state.ranked.length===0) return false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const top1 = state.ranked[0];
Â  Â  Â  Â  Â  Â  const top2 = state.ranked[1];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(state.previousDiagnostics.includes(top1.patho.name)) return false;

Â  Â  Â  Â  Â  Â  // RÃˆGLE 1 : FILET DE SÃ‰CURITÃ‰ (Max 20 questions)
Â  Â  Â  Â  Â  Â  if (qNum >= 20) return true;

Â  Â  Â  Â  Â  Â  const score1 = parseFloat(top1.prob);
Â  Â  Â  Â  Â  Â  if (!top2) return score1 > 40;Â 

Â  Â  Â  Â  Â  Â  const score2 = parseFloat(top2.prob);
Â  Â  Â  Â  Â  Â  const gap = score1 - score2;

Â  Â  Â  Â  Â  Â  // RÃˆGLE 2 : AUDACE PROGRESSIVE
Â  Â  Â  Â  Â  Â  if (qNum >= 5 && score1 >= 50 && gap >= 20) return true;
Â  Â  Â  Â  Â  Â  if (qNum >= 10 && gap >= 10) return true;
Â  Â  Â  Â  Â  Â  if (qNum >= 15) return true;

Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }

Â  Â  Â  Â  function prepareConfirmationQuestions(topPatho) {
Â  Â  Â  Â  Â  Â  // 1. RÃ©cupÃ©rer les vrais signes restants (La Checklist)
Â  Â  Â  Â  Â  Â  const pSigns = Object.entries(topPatho.signes)
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b[1] - a[1]) // On trie par importance
Â  Â  Â  Â  Â  Â  Â  Â  .map(entry => entry[0]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let questions = pSigns.filter(s => !state.asked.includes(s));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Ajouter un "LEURRE" (Question PiÃ¨ge) pour vÃ©rifier que l'Ã©lÃ¨ve ne triche pas
Â  Â  Â  Â  Â  Â  const trapCandidates = state.allSigns.filter(s => !pSigns.includes(s) && !state.asked.includes(s));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trapCandidates.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const trap = trapCandidates[Math.floor(Math.random() * trapCandidates.length)];
Â  Â  Â  Â  Â  Â  Â  Â  questions.splice(1, 0, trap);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // On limite quand mÃªme Ã  5 questions max pour ne pas Ãªtre trop long
Â  Â  Â  Â  Â  Â  return questions.slice(0, 5);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderCurrentQuestion() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  const signe = state.currentSign;
Â  Â  Â  Â  Â  Â  const questionTitle = state.confirmationMode ? `<span style="color:var(--gold)">ğŸ¤” Je pense avoir une piste...</span>` : `QUESTION ${state.asked.length}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calcul proba pour barre
Â  Â  Â  Â  Â  Â  let prob = 0;
Â  Â  Â  Â  Â  Â  if(state.ranked.length > 0) prob = parseFloat(state.ranked[0].prob);

Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  ${state.isChrono ? '<div style="font-size:12px; color:var(--accent); margin-bottom:5px;">âš¡ Chrono Actif</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-progress-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-progress-bar" style="width:${prob}%"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-progress-label">Confiance IA : ${prob}%</div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small" style="margin-bottom:12px; color:var(--accent)">${questionTitle}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-text">Le patient prÃ©sente-t-il :<br><strong style="font-size:1.2em; color:var(--text-main);">${formatSigneName(signe)}</strong> ?</div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnGroup = document.createElement('div'); btnGroup.className='button-group';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const mkBtn = (txt, cls, val) => {
Â  Â  Â  Â  Â  Â  Â  Â  const b = document.createElement('button'); b.className=cls; b.textContent=txt;
Â  Â  Â  Â  Â  Â  Â  Â  b.onclick=()=>{Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.history.push(JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  answers: state.answers, asked: state.asked, currentSign: state.currentSign,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmationMode: state.confirmationMode, confirmationQueue: state.confirmationQueue,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmedPatho: state.confirmedPatho, priorityQueue: state.priorityQueue,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isChrono: state.isChrono, startTime: state.startTime, dailyTarget: state.dailyTarget
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si clic NON sur un vrai signe (erreur anticipÃ©e pour feedback visuel futur, ou log)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.dailyTarget && val === false && state.dailyTarget.signes[signe]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // On pourrait stocker ici que l'utilisateur a fait une erreur en direct
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.answers[signe]=val; askNextQuestion();Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  btnGroup.appendChild(b);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  mkBtn('OUI', 'btn btn-success', true);
Â  Â  Â  Â  Â  Â  mkBtn('NON', 'btn btn-error', false);
Â  Â  Â  Â  Â  Â  mkBtn('Je ne sais pas', 'link', null);
Â  Â  Â  Â  Â  Â  card.appendChild(btnGroup);

Â  Â  Â  Â  Â  Â  const navGroup = document.createElement('div'); navGroup.style.display = 'flex'; navGroup.style.gap = '15px'; navGroup.style.marginTop = '20px';
Â  Â  Â  Â  Â  Â  if(state.history.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='btn-back'; btnBack.textContent='â¬…ï¸ Retour';
Â  Â  Â  Â  Â  Â  Â  Â  btnBack.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prevState = JSON.parse(state.history.pop());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(state, prevState);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCurrentQuestion();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  navGroup.appendChild(btnBack);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const btnAb = document.createElement('button'); btnAb.className='link'; btnAb.textContent='Abandonner'; btnAb.onclick=renderAbandonMenu;
Â  Â  Â  Â  Â  Â  navGroup.appendChild(btnAb); card.appendChild(navGroup);
Â  Â  Â  Â  Â  Â  app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function askNextQuestion() {
Â  Â  Â  Â  Â  Â  // SÃ‰CURITÃ‰ MORT SUBITE
Â  Â  Â  Â  Â  Â  if (state.asked.length >= 20) { showDiagnostic(); return; }

Â  Â  Â  Â  Â  Â  // --- CORRECTION TUNNEL VISION (Nettoyage de la file si une prÃ©cision est donnÃ©e) ---
Â  Â  Â  Â  Â  Â  if(state.asked.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const lastSign = state.asked[state.asked.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  const lastAnswer = state.answers[lastSign];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(lastAnswer === true) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â for (const [parent, children] of Object.entries(REFINEMENTS)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (children.includes(lastSign)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const siblings = children.filter(c => c !== lastSign);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // On retire les frÃ¨res/sÅ“urs de la liste prioritaire pour ne pas Ãªtre lourd
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.priorityQueue = state.priorityQueue.filter(q => !siblings.includes(q));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(state.priorityQueue.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const nextPriority = state.priorityQueue.shift();
Â  Â  Â  Â  Â  Â  Â  Â  if(!state.asked.includes(nextPriority)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentSign = nextPriority; state.asked.push(nextPriority); renderCurrentQuestion(); return;
Â  Â  Â  Â  Â  Â  Â  Â  } else { askNextQuestion(); return; }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (state.confirmationMode) {
Â  Â  Â  Â  Â  Â  Â  Â  const lastSign = state.asked[state.asked.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- LOGIQUE ANTI-TRICHE ---
Â  Â  Â  Â  Â  Â  Â  Â  const isSignPartOfPatho = Object.keys(state.confirmedPatho.signes).includes(lastSign);
Â  Â  Â  Â  Â  Â  Â  Â  const userSaidYes = state.answers[lastSign] === true;

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Si c'Ã©tait un piÃ¨ge (le signe n'est pas dans la maladie) ET que l'utilisateur a dit OUI -> ECHEC
Â  Â  Â  Â  Â  Â  Â  Â  if (!isSignPartOfPatho && userSaidYes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LOG ERROR VISUELLE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert("AÃ¯e ! Ce symptÃ´me ne collait pas...", "error");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  askNextQuestion(); return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Si c'Ã©tait un vrai signe ET que l'utilisateur a dit NON -> ECHEC (Piste abandonnÃ©e)
Â  Â  Â  Â  Â  Â  Â  Â  if (isSignPartOfPatho && !userSaidYes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.confirmationMode = false; state.confirmationQueue = []; state.confirmedPatho = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert("Ah, fausse piste. Je continue Ã  chercher...", "info");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  askNextQuestion(); return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (state.confirmationQueue.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextC = state.confirmationQueue.shift();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentSign = nextC; state.asked.push(nextC); renderCurrentQuestion(); return;
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDiagnostic(); return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  prepareSigns();
Â  Â  Â  Â  Â  Â  const remaining = state.allSigns.filter(s => !state.asked.includes(s));
Â  Â  Â  Â  Â  Â  if(remaining.length === 0) { showDiagnostic(); return; }

Â  Â  Â  Â  Â  Â  const hasSymptom = Object.keys(state.answers).some(key => state.answers[key] === true);
Â  Â  Â  Â  Â  Â  if (!hasSymptom) {
Â  Â  Â  Â  Â  Â  Â  Â  const generalSigns = remaining.filter(s => REFINEMENTS.hasOwnProperty(s));
Â  Â  Â  Â  Â  Â  Â  Â  const pool = generalSigns.length > 0 ? generalSigns : remaining;
Â  Â  Â  Â  Â  Â  Â  Â  const randomSign = pool[Math.floor(Math.random() * pool.length)];
Â  Â  Â  Â  Â  Â  Â  Â  state.currentSign = randomSign; state.asked.push(randomSign); renderCurrentQuestion(); return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  rankPathologies();Â 
Â  Â  Â  Â  Â  Â  if(canShowDiagnostic()){Â 
Â  Â  Â  Â  Â  Â  Â  Â  const topPatho = state.ranked[0].patho;
Â  Â  Â  Â  Â  Â  Â  Â  const confirmQuestions = prepareConfirmationQuestions(topPatho);
Â  Â  Â  Â  Â  Â  Â  Â  if (confirmQuestions.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.confirmationMode = true; state.confirmedPatho = topPatho; state.confirmationQueue = confirmQuestions;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const first = state.confirmationQueue.shift();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentSign = first; state.asked.push(first); renderCurrentQuestion(); return;
Â  Â  Â  Â  Â  Â  Â  Â  } else { showDiagnostic(); return; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // C'est ici que la magie opÃ¨re maintenant : getNextSmartSign va choisir LA meilleure question
Â  Â  Â  Â  Â  Â  const signe = getNextSmartSign(state.ranked, remaining);
Â  Â  Â  Â  Â  Â  state.currentSign = signe; state.asked.push(signe); renderCurrentQuestion();
Â  Â  Â  Â  }

Â  Â  Â  Â  function showDiagnostic() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML = '';
Â  Â  Â  Â  Â  Â  const loadingCard = document.createElement('div'); loadingCard.className = 'card center';
Â  Â  Â  Â  Â  Â  loadingCard.innerHTML = `<h3 style="color:var(--accent)">ğŸ” Analyse IA en cours...</h3><div style="margin: 30px 0; font-size: 50px; animation: spin 0.8s infinite linear;">âš™ï¸</div><p class="small">Comparaison base de donnÃ©es...</p>`;
Â  Â  Â  Â  Â  Â  app.appendChild(loadingCard);

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  rankPathologies();
Â  Â  Â  Â  Â  Â  Â  Â  const top = state.ranked[0];
Â  Â  Â  Â  Â  Â  Â  Â  state.diagnosticShown = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.previousDiagnostics.push(top.patho.name);

Â  Â  Â  Â  Â  Â  Â  Â  app.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card center';
Â  Â  Â  Â  Â  Â  Â  Â  const title = document.createElement('h2'); title.textContent='ğŸ’¡ Diagnostic ProposÃ©'; card.appendChild(title);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let pdfButton = top.patho.pdf && top.patho.pdf !== '#' ? `<a class="link" style="color:var(--accent); border-color:var(--accent); display:inline-block; margin-top:10px;" href="${top.patho.pdf}" target="_blank">ğŸ“„ Voir fiche PDF</a>` : `<span class="small" style="opacity:0.5">ğŸ“„ Pas de fiche PDF</span>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const diagDiv = document.createElement('div'); diagDiv.className='diagnostic-result';
Â  Â  Â  Â  Â  Â  Â  Â  diagDiv.innerHTML = `<div class="diagnostic-name">${top.patho.name}</div><div class="patho-desc" style="margin-top:8px">${top.patho.short}</div><br>${pdfButton}`;
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(diagDiv);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const btnGroup = document.createElement('div'); btnGroup.className='button-group';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const btnTrue = document.createElement('button'); btnTrue.className='btn btn-success'; btnTrue.textContent='âœ… Correct';
Â  Â  Â  Â  Â  Â  Â  Â  btnTrue.onclick = async () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  triggerConfetti(); playSound('success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.correct++; state.progression.streak = (state.progression.streak || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // GESTION DU DAILY
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.dailyTarget && state.dailyTarget.name === top.patho.name) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.progression.lastDaily !== today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.lastDaily = today;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.dailyStreak = (state.progression.dailyStreak || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`ğŸ‰ DÃ©fi du jour rÃ©ussi ! SÃ©rie : ${state.progression.dailyStreak}`, "success");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.mastery) state.progression.mastery = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pName = top.patho.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let m = state.progression.mastery[pName];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!m) m = { success: 0, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  m.success++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CHRONO SAVE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.isChrono && state.startTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const duration = (Date.now() - state.startTime) / 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(duration < 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Increment speed counter for achievements
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.speedWins = (state.progression.speedWins || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.bestTimes) state.progression.bestTimes = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.bestTimes[pName] || duration < state.progression.bestTimes[pName]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.bestTimes[pName] = duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`âš¡ Nouveau Record : ${duration.toFixed(1)}s`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CHECK FOR MISSED SIGNS EVEN ON SUCCESS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(top.patho.signes).forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.answers[s] === false) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!m.missedSigns[s]) m.missedSigns[s] = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  m.missedSigns[s]++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.mastery[pName] = m;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeader(); await saveProgression();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('Diagnostic validÃ© !','success'); showDiagnosticDetails({patho: top.patho});
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const btnFalse = document.createElement('button'); btnFalse.className='btn btn-error'; btnFalse.textContent='âŒ Incorrect';
Â  Â  Â  Â  Â  Â  Â  Â  btnFalse.onclick = async () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.incorrect++; state.progression.streak = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.mastery) state.progression.mastery = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pName = top.patho.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let m = state.progression.mastery[pName];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!m) m = { success: 0, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  m.failures++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.mastery[pName] = m;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ERROR LOGGING
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.errorLog) state.progression.errorLog = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.progression.errorLog[pName] = { date: Date.now(), count: (state.progression.errorLog[pName]?.count || 0) + 1 };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeader(); await saveProgression();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('AÃ¯e... Continuons','error');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.confirmationMode = false; state.diagnosticShown=false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(()=>askNextQuestion(), 800);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  btnGroup.appendChild(btnTrue); btnGroup.appendChild(btnFalse); card.appendChild(btnGroup); app.appendChild(card);
Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  }

Â  Â  Â  Â  function showDiagnosticDetails(data, wasManualError = false) {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const top = data.patho;
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML = '';
Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='card';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(wasManualError) {
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2 style="color:var(--error)">âŒ C'Ã©tait : ${top.name}</h2>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.mastery) state.progression.mastery = {};
Â  Â  Â  Â  Â  Â  Â  Â  let m = state.progression.mastery[top.name];
Â  Â  Â  Â  Â  Â  Â  Â  if(!m) m = { success: 0, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â  if(typeof m === 'number') m = { success: m, failures: 0, missedSigns: {} };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  m.failures++;
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(top.signes).forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(state.answers[s] === false) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!m.missedSigns[s]) m.missedSigns[s] = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  m.missedSigns[s]++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  state.progression.mastery[top.name] = m;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ERROR LOGGING
Â  Â  Â  Â  Â  Â  Â  Â  if(!state.progression.errorLog) state.progression.errorLog = {};
Â  Â  Â  Â  Â  Â  Â  Â  state.progression.errorLog[top.name] = { date: Date.now(), count: (state.progression.errorLog[top.name]?.count || 0) + 1 };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  saveProgression();

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `<h2>âœ… ${top.name}</h2>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const desc = document.createElement('div'); desc.className='patho-desc'; desc.textContent = top.short; desc.style.marginBottom='20px'; desc.style.textAlign='center'; card.appendChild(desc);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(top.signes) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const pathoSigns = Object.keys(top.signes);
Â  Â  Â  Â  Â  Â  Â  Â  const correctSigns = [], missingSigns = [], notAskedSigns = [], erroneousSigns = [];
Â  Â  Â  Â  Â  Â  Â  Â  pathoSigns.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = state.answers[s];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(val === true) correctSigns.push(s);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(val === false) missingSigns.push(s);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else notAskedSigns.push(s);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  state.allSigns.forEach(s => { if(state.answers[s] === true && !pathoSigns.includes(s)) erroneousSigns.push(s); });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- TRI PAR POIDS DIAGNOSTIC ---
Â  Â  Â  Â  Â  Â  Â  Â  correctSigns.sort((a, b) => (top.signes[b] || 0) - (top.signes[a] || 0));
Â  Â  Â  Â  Â  Â  Â  Â  missingSigns.sort((a, b) => (top.signes[b] || 0) - (top.signes[a] || 0));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const resultsDiv = document.createElement('div'); resultsDiv.className='result-list';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Nouvelle fonction de gÃ©nÃ©ration HTML plus jolie (STYLE DASHBOARD)
Â  Â  Â  Â  Â  Â  Â  Â  const createList = (title, items, type, typeLabel) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(items.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let icon = 'â„¹ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let badgeClass = 'badge-neutral';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'correct') { icon = 'âœ…'; badgeClass = 'badge-correct'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'missing') { icon = 'âš ï¸'; badgeClass = 'badge-missing'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const h = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.className = 'result-section-title';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.innerHTML = `${icon} ${title} <span style="opacity:0.6; font-size:0.9em; margin-left:auto;">${items.length}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.appendChild(h);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r.className = 'result-item';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="result-label">${formatSigneName(s)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="status-badge ${badgeClass}">${typeLabel}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.appendChild(r);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(wasManualError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createList("Signes manquÃ©s (Faux NÃ©gatifs)", missingSigns, "missing", "Non");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createList("Autres signes", notAskedSigns, "neutral", "Inconnu");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createList("Signes bien identifiÃ©s", correctSigns, "correct", "ValidÃ©");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(missingSigns.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createList("Attention : Signes manquÃ©s", missingSigns, "missing", "Erreur");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createList("Autres signes du tableau", notAskedSigns, "neutral", "Non demandÃ©");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(resultsDiv);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(top.pdf && top.pdf !== '#') {
Â  Â  Â  Â  Â  Â  Â  Â  const pdfBtn = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  pdfBtn.href = top.pdf; pdfBtn.target = "_blank"; pdfBtn.className = 'btn'; pdfBtn.textContent = 'ğŸ“„ Voir la fiche PDF complÃ¨te'; pdfBtn.style.marginTop = '20px'; pdfBtn.style.display = 'block'; pdfBtn.style.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // TRACKING PDF DOWNLOAD
Â  Â  Â  Â  Â  Â  Â  Â  pdfBtn.onclick = trackPdf;

Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(pdfBtn);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnGroup = document.createElement('div'); btnGroup.className='button-group';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // BOUTON REJOUER DIRECT
Â  Â  Â  Â  Â  Â  const btnReplay = document.createElement('button'); btnReplay.className='btn btn-success'; btnReplay.textContent = 'ğŸ”„ Rejouer tout de suite';Â 
Â  Â  Â  Â  Â  Â  btnReplay.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â state.dailyTarget = null; // Reset daily flag if random play
Â  Â  Â  Â  Â  Â  Â  Â  Â renderDemographics();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const btnHome = document.createElement('button'); btnHome.className='link'; btnHome.textContent = 'ğŸ  Retour Accueil'; btnHome.onclick = renderHome;
Â  Â  Â  Â  Â  Â  btnGroup.appendChild(btnReplay); btnGroup.appendChild(btnHome); card.appendChild(btnGroup); app.appendChild(card);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderGlossary() {
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  const app = q('#app'); app.innerHTML='';
Â  Â  Â  Â  Â  Â  const titleCard = document.createElement('div'); titleCard.className='card center'; titleCard.innerHTML='<h2>ğŸ“š Glossaire</h2>';Â 
Â  Â  Â  Â  Â  Â  const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='ğŸ  Retour';
Â  Â  Â  Â  Â  Â  btnBack.style.marginBottom='20px'; btnBack.onclick=renderHome;
Â  Â  Â  Â  Â  Â  titleCard.appendChild(btnBack); app.appendChild(titleCard);

Â  Â  Â  Â  Â  Â  const searchContainer = document.createElement('div'); searchContainer.className = 'search-container';
Â  Â  Â  Â  Â  Â  const searchInput = document.createElement('input'); searchInput.className = 'search-input'; searchInput.placeholder = 'Rechercher une pathologie (ex: Grippe...)'; searchInput.type = 'text';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ADDED SEARCH ICON
Â  Â  Â  Â  Â  Â  const searchIcon = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  searchIcon.innerHTML = `<svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  searchContainer.appendChild(searchIcon);
Â  Â  Â  Â  Â  Â  searchContainer.appendChild(searchInput);Â 
Â  Â  Â  Â  Â  Â  app.appendChild(searchContainer);

Â  Â  Â  Â  Â  Â  const wrapper = document.createElement('div'); wrapper.className = 'glossary-wrapper';
Â  Â  Â  Â  Â  Â  const sidebar = document.createElement('div'); sidebar.className = 'alphabet-sidebar';
Â  Â  Â  Â  Â  Â  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
Â  Â  Â  Â  Â  Â  const sortedPathos = [...PATHOLOGIES].sort((a, b) => a.name.localeCompare(b.name));
Â  Â  Â  Â  Â  Â  const existingLetters = new Set(sortedPathos.map(p => p.name.charAt(0).toUpperCase()));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  alphabet.forEach(letter => {
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a'); link.textContent = letter; link.className = 'alpha-link';
Â  Â  Â  Â  Â  Â  Â  Â  if (existingLetters.has(letter)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.href = `#letter-${letter}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.onclick = (e) => { e.preventDefault(); const target = document.getElementById(`letter-${letter}`); if(target) target.scrollIntoView({behavior: 'smooth', block: 'start'}); };
Â  Â  Â  Â  Â  Â  Â  Â  } else { link.classList.add('disabled'); }
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.appendChild(link);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  wrapper.appendChild(sidebar);

Â  Â  Â  Â  Â  Â  const content = document.createElement('div'); content.className = 'glossary-content';
Â  Â  Â  Â  Â  Â  function renderGrid(pathos, showHeaders = true) {
Â  Â  Â  Â  Â  Â  Â  Â  content.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if(pathos.length === 0) { content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Aucune pathologie trouvÃ©e.</div>'; return; }
Â  Â  Â  Â  Â  Â  Â  Â  if(!showHeaders) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const grid = document.createElement('div'); grid.className = 'letter-grid';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pathos.forEach(p => { grid.appendChild(createPathoCard(p)); }); content.appendChild(grid);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphabet.forEach(letter => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const letterPathos = pathos.filter(p => p.name.charAt(0).toUpperCase() === letter);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(letterPathos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const letterHeader = document.createElement('div'); letterHeader.className = 'letter-header'; letterHeader.id = `letter-${letter}`; letterHeader.textContent = letter; content.appendChild(letterHeader);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const grid = document.createElement('div'); grid.className = 'letter-grid';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  letterPathos.forEach(p => { grid.appendChild(createPathoCard(p)); }); content.appendChild(grid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function createPathoCard(p) {
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); card.className='patho-card';
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML=`<div class="patho-name">${p.name}</div><div class="patho-desc">${p.short}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  card.onclick=()=>{Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p.pdf && p.pdf !== '#') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trackPdf(); // Track download on glossary click too
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(p.pdf,'_blank');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else showAlert('Fiche PDF non disponible','error');Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  return card;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderGrid(sortedPathos, true);
Â  Â  Â  Â  Â  Â  searchInput.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const term = e.target.value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  if(term.length > 0) { sidebar.style.display = 'none'; const filtered = sortedPathos.filter(p => p.name.toLowerCase().includes(term)); renderGrid(filtered, false); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { sidebar.style.display = 'flex'; renderGrid(sortedPathos, true); }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  wrapper.appendChild(content); app.appendChild(wrapper);
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
