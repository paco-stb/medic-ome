<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicome - Training Lab</title>
    
    <link rel="canonical" href="https://medicome.fr/" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü©∫</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= STYLE CHROME / DARK GLOSS ================= */
        :root {
          /* Palette Deep Chrome */
          --bg-dark: #020b16;
          --bg-light: #1e3c72;
          --glass-bg: rgba(13, 25, 48, 0.75);
          --glass-border: rgba(100, 200, 255, 0.15);
          --accent: #00d2ff;
          --accent-glow: rgba(0, 210, 255, 0.4);
          --text-main: #ffffff;
          --text-muted: #b0c4de;
          
          --success: #00ff9d;
          --error: #ff4d4d;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
          font-family: 'Inter', sans-serif;
          background: radial-gradient(circle at 50% 0%, var(--bg-light), var(--bg-dark) 80%);
          background-attachment: fixed;
          color: var(--text-main);
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }

        /* HEADER GLASSMORPHISM */
        header {
          display: flex;
          justify-content: space-between;
          padding: 16px 24px;
          background: rgba(2, 11, 22, 0.8);
          backdrop-filter: blur(15px);
          -webkit-backdrop-filter: blur(15px);
          align-items: center;
          border-bottom: 1px solid var(--glass-border);
          position: sticky; top: 0; z-index: 100;
          box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .brand { 
            font-size:22px; font-weight:700; color:var(--accent); 
            display: flex; align-items: center; gap: 12px; 
            text-shadow: 0 0 10px var(--accent-glow);
        }
        .logo-svg { width: 32px; height: 32px; fill: var(--accent); filter: drop-shadow(0 0 5px var(--accent)); }
        
        .top-right { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        
        .pseudo { 
            color:var(--accent); font-weight:600; padding:6px 12px; 
            background: rgba(0, 210, 255, 0.05); 
            border: 1px solid var(--glass-border);
            border-radius:20px; cursor:pointer; font-size: 14px; 
        }

        /* BOUTONS & LINKS */
        .link {
          background: rgba(255,255,255,0.03);
          border:1px solid rgba(255,255,255,0.1);
          color: var(--text-muted);
          padding:8px 16px;
          border-radius:8px;
          cursor:pointer;
          transition:all 0.3s;
          font-size:14px;
        }
        .link:hover { 
            background: rgba(255,255,255,0.1); 
            color: white; 
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* CARDS */
        main { flex:1; max-width:1000px; width:100%; margin:0 auto; padding:30px 20px; display:flex; flex-direction:column; align-items:center; }
        
        .card { 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding:32px; 
            border-radius:20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.6), inset 0 0 0 1px var(--glass-border); 
            margin-bottom:16px; width:100%; max-width:600px; 
            transition: transform 0.3s ease;
        }
        
        .card h2 { margin-bottom:20px; font-size:26px; text-align:center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .card h3 { margin-bottom:16px; font-size:22px; text-align:center; color: var(--accent); }

        /* INPUTS */
        .input, select { 
            width:100%; padding:14px; border-radius:10px; 
            border:1px solid rgba(255,255,255,0.15); 
            background: rgba(0,0,0,0.3); 
            color: var(--text-main); 
            margin-top:8px; margin-bottom:12px; font-size:14px; 
            transition:all 0.3s; 
        }
        .input:focus, select:focus { 
            outline:none; border-color:var(--accent); 
            background: rgba(0,0,0,0.5); 
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* BOUTONS */
        .btn { 
            background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%);
            border:none; padding:14px 24px; border-radius:12px; 
            color: #000; cursor:pointer; font-weight:700; font-size:15px; 
            transition:all 0.3s; 
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover { 
            transform:translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6), inset 0 0 0 2px rgba(255,255,255,0.3);
        }
        
        .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: #022015; box-shadow: 0 4px 15px rgba(0, 176, 155, 0.4); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(0, 176, 155, 0.6); }
        
        .btn-error { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; box-shadow: 0 4px 15px rgba(203, 45, 62, 0.4); }
        .btn-error:hover { box-shadow: 0 6px 20px rgba(203, 45, 62, 0.6); }

        .btn-code { 
            background: transparent !important; 
            border: 1px solid var(--accent) !important; 
            color: var(--accent) !important;
            box-shadow: none !important;
        }
        .btn-code:hover { background: rgba(0, 210, 255, 0.1) !important; box-shadow: 0 0 15px var(--accent-glow) !important; }

        /* BOUTON RETOUR */
        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* ELEMENTS */
        .center { text-align:center; display:flex; flex-direction:column; align-items:center; }
        
        .question-text { 
            font-size:22px; text-align:center; line-height:1.6; padding:24px; 
            background: linear-gradient(90deg, rgba(0,210,255,0.05) 0%, rgba(0,210,255,0) 100%);
            border-radius:12px; border-left:4px solid var(--accent); 
            word-break:break-word; width: 100%; margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        
        .button-group { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:12px; width: 100%; }
        .small { opacity:0.6; font-size:13px; color:var(--text-muted); margin-top:12px; text-align:center; }
        
        /* GLOSSAIRE */
        .glossary-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:20px; width:100%; max-width:1000px; }
        .patho-card { 
            background: rgba(255, 255, 255, 0.03); 
            padding:24px; border-radius:16px; 
            border:1px solid rgba(255,255,255,0.05); 
            transition:all 0.3s; cursor:pointer; 
        }
        .patho-card:hover { 
            transform:translateY(-5px); 
            border-color:var(--accent); 
            background: rgba(0, 210, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--accent-glow);
        }
        .patho-name { font-size:18px; font-weight:700; color:var(--accent); margin-bottom:8px; }
        .patho-desc { font-size:14px; color:rgba(255,255,255,0.7); line-height:1.5; }

        /* RESULTATS & ALERTS */
        .alert { padding:14px; border-radius:10px; margin:12px 0; font-size:14px; width: 100%; text-align: center; font-weight: 500;}
        .alert-success { background: rgba(0, 255, 157, 0.1); border:1px solid var(--success); color:var(--success); box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); }
        .alert-error { background: rgba(255, 77, 77, 0.1); border:1px solid var(--error); color:var(--error); box-shadow: 0 0 15px rgba(255, 77, 77, 0.2); }

        .stat-box { 
            background: rgba(0,0,0,0.3); padding:20px; 
            border-radius:12px; margin:10px 0; 
            border: 1px solid rgba(255,255,255,0.05);
            text-align:center; 
        }
        .stat-number { font-size:36px; font-weight:700; color:white; text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .diagnostic-result { 
            background: rgba(0, 210, 255, 0.1); padding:30px; 
            border-radius:20px; margin:20px 0; 
            border:2px solid var(--accent); text-align:center; 
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .diagnostic-name { font-size:32px; font-weight:700; color:white; margin-bottom:12px; text-shadow: 0 0 10px var(--accent); }
        .score-badge { display:inline-block; background: var(--accent); color: #000; font-weight: 700; padding:6px 14px; border-radius:20px; font-size:14px; margin-top:12px; }
        
        .result-item { padding:12px 16px; border-radius:10px; margin-bottom:8px; background: rgba(0,0,0,0.3); display:flex; justify-content:space-between; align-items:center; border: 1px solid rgba(255,255,255,0.05); }
        .result-correct { border-left:4px solid var(--success); }
        .result-missing { border-left:4px solid #f59e0b; }
        .result-error { border-left:4px solid var(--error); }
        
        footer { text-align:center; padding:20px; background: rgba(0,0,0,0.3); font-size:13px; opacity:0.6; flex-shrink:0; border-top: 1px solid rgba(255,255,255,0.05); }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width:600px){
            .button-group{flex-direction:column;width:100%;}
            .btn,.link{width:100%;}
            .glossary-grid{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <svg class="logo-svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V5H19V19M11,17H13V13H17V11H13V7H11V11H7V13H11V17Z" />
            </svg>
            Medicome
        </div>
        
        <div class="top-right">
            <button id="homeBtn" class="link" style="display:none;">Accueil</button>
            <div id="pseudoBox" class="pseudo" style="display:none;">Utilisateur</div>
            <button id="logoutBtn" class="link" style="display:none;">D√©connexion</button>
        </div>
    </header>

    <main id="app">
        <div class="center">
            <div style="font-size: 40px; animation: spin 1s infinite linear; margin-bottom: 20px;">‚öôÔ∏è</div>
            <div class="small">Chargement du noyau m√©dical...</div>
        </div>
    </main>

    <footer>
        Medicome ¬© 2025 - Outil p√©dagogique pour les √©tudiants en M√©decine
    </footer>

    <script type="module">
        if (window.location.hostname.includes("github.io")) {
            window.location.href = "https://medicome.fr";
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCig9G4gYHU5h642YV1IZxthYm_IXp6vZU",
            authDomain: "medicome-paco.firebaseapp.com",
            projectId: "medicome-paco",
            storageBucket: "medicome-paco.firebasestorage.app",
            messagingSenderId: "332171806096",
            appId: "1:332171806096:web:36889325196a7a718b5f15",
            measurementId: "G-81HJ9DWBMX"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erreur Firebase:", error);
            document.querySelector('#app').innerHTML = `<div class="alert alert-error">Erreur de configuration : ${error.message}</div>`;
        }

        let PATHOLOGIES = [];
        const ACCESS_CODES = [ { code: "SuperCode1", pseudo:"Admin" } ];

        // AJOUT DE L'HISTORIQUE DANS LE STATE
        let state = {
            currentUser: null, pseudo: null, progression: { correct: 0, incorrect: 0 },
            isGuest: false, demo:{}, currentSign:null, answers:{}, asked:[], allSigns:[], ranked: [], diagnosticShown:false, previousDiagnostics:[],
            history: [] // Nouvelle pile pour le bouton Retour
        };

        async function initApp() {
            try {
                const response = await fetch('./pathologies.json');
                if (!response.ok) throw new Error("Impossible de lire le fichier de donn√©es");
                PATHOLOGIES = await response.json();
                console.log("Donn√©es m√©dicales charg√©es:", PATHOLOGIES.length, "pathologies");
                startAuthListener();
            } catch (err) {
                console.error(err);
                document.querySelector('#app').innerHTML = `
                    <div class="card center">
                        <h2 style="color:var(--error)">Erreur de chargement</h2>
                        <p>Impossible de charger 'pathologies.json'.</p>
                        <div class="small" style="color:orange">${err.message}</div>
                    </div>
                `;
            }
        }
        initApp();

        function startAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user; state.isGuest = false;
                    let displayPseudo = user.displayName;
                    if (!displayPseudo && user.email) displayPseudo = user.email.split('@')[0];
                    state.pseudo = displayPseudo; updateHeader(); 
                    const docRef = doc(db, "users", user.uid);
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.pseudo) state.pseudo = data.pseudo;
                            state.progression = data.progression || { correct: 0, incorrect: 0 };
                        } else { saveProgression(); }
                        updateHeader(); renderHome();
                    } catch(e) { renderHome(); }
                } else {
                    const savedGuest = localStorage.getItem('medicome_guest_progression');
                    const savedPseudo = localStorage.getItem('medicome_guest_pseudo');
                    if(!state.isGuest && savedGuest && savedPseudo) {
                        state.isGuest = true; state.pseudo = savedPseudo;
                        state.progression = JSON.parse(savedGuest);
                        updateHeader(); renderHome();
                        setTimeout(() => showAlert(`Bon retour, ${state.pseudo} !`, 'success'), 500);
                    } else {
                        state.currentUser = null; state.pseudo = null; state.progression = { correct: 0, incorrect: 0 };
                        renderLogin(); updateHeader();
                    }
                }
            });
        }

        function q(sel){ return document.querySelector(sel); }
        function formatSigneName(sign){ return sign.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }
        function showAlert(message,type){
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type;
            alertDiv.textContent = message;
            const app = q('#app');
            if(app){ app.insertBefore(alertDiv,app.firstChild); setTimeout(()=>{ if(alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv); },3000); }
        }

        async function saveProgression() {
            if (!state.isGuest && state.currentUser) {
                try {
                    const userRef = doc(db, "users", state.currentUser.uid);
                    await setDoc(userRef, { progression: state.progression, pseudo: state.pseudo, lastUpdate: new Date() }, { merge: true });
                } catch (e) { console.error("Erreur sauvegarde Cloud", e); }
            } else if (state.isGuest) {
                localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
                localStorage.setItem('medicome_guest_pseudo', state.pseudo);
            }
        }

        function updateHeader(){
            const pseudoBox = q("#pseudoBox"); const homeBtn = q("#homeBtn"); const logoutBtn = q("#logoutBtn");
            if(state.pseudo){ 
                pseudoBox.textContent = state.pseudo + (state.isGuest ? " (Local)" : ""); 
                pseudoBox.style.display='inline-block'; pseudoBox.onclick=renderProfile;
                homeBtn.style.display='inline-block'; logoutBtn.style.display='inline-block';
            } else { 
                pseudoBox.style.display='none'; homeBtn.style.display='none'; logoutBtn.style.display='none';
            }
            homeBtn.onclick=renderHome;
            logoutBtn.onclick = () => {
                localStorage.removeItem('medicome_guest_progression'); localStorage.removeItem('medicome_guest_pseudo');
                state.isGuest = false; state.pseudo = null; state.currentUser = null; state.progression = { correct: 0, incorrect: 0 }; 
                signOut(auth).then(() => { renderLogin(); updateHeader(); showAlert("D√©connect√©", "success"); }).catch(() => { renderLogin(); updateHeader(); });
            };
        }

        function renderLogin() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center'; card.innerHTML='<h2>‚òÅÔ∏è Connexion Cloud</h2>';
            const inputUser = document.createElement('input'); inputUser.placeholder='Email'; inputUser.className='input';
            const inputPass = document.createElement('input'); inputPass.placeholder='Mot de passe'; inputPass.className='input'; inputPass.type='password';
            const btnLogin = document.createElement('button'); btnLogin.className='btn'; btnLogin.textContent='Se connecter';
            btnLogin.onclick = async () => {
                try { await signInWithEmailAndPassword(auth, inputUser.value, inputPass.value); showAlert("Connexion r√©ussie !", "success"); } catch (error) { showAlert("Erreur: " + error.message, "error"); }
            };
            card.appendChild(inputUser); card.appendChild(inputPass); card.appendChild(btnLogin);
            const sep = document.createElement('div'); sep.textContent='‚Äî Pas encore de compte ? ‚Äî'; sep.className='small'; sep.style.margin='16px 0'; card.appendChild(sep);
            const inRegEmail = document.createElement('input'); inRegEmail.placeholder='Nouvel Email'; inRegEmail.className='input';
            const inRegPass = document.createElement('input'); inRegPass.placeholder='Nouveau Mot de passe'; inRegPass.className='input'; inRegPass.type='password';
            const inPseudo = document.createElement('input'); inPseudo.placeholder='Votre Pseudo'; inPseudo.className='input';
            const btnReg = document.createElement('button'); btnReg.className='link'; btnReg.textContent='Cr√©er un compte Cloud';
            btnReg.onclick = async () => {
                if(!inRegEmail.value || !inRegPass.value || !inPseudo.value) return showAlert('Remplissez tout','error');
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, inRegEmail.value, inRegPass.value);
                    const user = userCredential.user; await updateProfile(user, { displayName: inPseudo.value });
                    await setDoc(doc(db, "users", user.uid), { pseudo: inPseudo.value, email: inRegEmail.value, progression: { correct: 0, incorrect: 0 }, createdAt: new Date() }, { merge: true });
                    state.pseudo = inPseudo.value; showAlert("Compte cr√©√© !", "success"); updateHeader(); renderHome();
                } catch (error) { showAlert("Erreur cr√©ation: " + error.message, "error"); }
            };
            card.appendChild(inRegEmail); card.appendChild(inRegPass); card.appendChild(inPseudo); card.appendChild(btnReg);
            const sepCode = document.createElement('div'); sepCode.textContent='‚Äî ou Acc√®s Rapide (Local) ‚Äî'; sepCode.className='small'; sepCode.style.margin='16px 0'; card.appendChild(sepCode);
            const inputCode = document.createElement('input'); inputCode.placeholder='Cl√© d\'acc√®s'; inputCode.className='input';
            const btnCode = document.createElement('button'); btnCode.className='btn btn-code'; btnCode.textContent='Utiliser une cl√©';
            btnCode.onclick = () => {
                const codeFound = ACCESS_CODES.find(ac => ac.code === inputCode.value);
                if(codeFound) {
                    state.isGuest = true; state.pseudo = codeFound.pseudo; state.progression = {correct:0, incorrect:0};
                    saveProgression(); updateHeader(); renderHome(); showAlert(`Mode Invit√©: ${codeFound.pseudo}`, 'success');
                } else { showAlert('Cl√© invalide', 'error'); }
            };
            card.appendChild(inputCode); card.appendChild(btnCode); app.appendChild(card);
        }

        function renderHome() {
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const card = document.createElement('div'); card.className='card center';
            let cloudBadge = state.isGuest ? '<span style="color:orange; font-size:0.8em; margin-bottom:10px">üíæ Mode Local (Navigateur)</span>' : '<span style="color:var(--success); font-size:0.8em; margin-bottom:10px">‚òÅÔ∏è Sauvegarde Cloud Active</span>';
            const displayName = state.pseudo || '...';
            card.innerHTML = `<h2>üëã Bonjour ${displayName}</h2>${cloudBadge}
                            <div class="stat-box" style="width:100%"><div class="stat-number">${prog.correct + prog.incorrect}</div><div class="stat-label">Cas r√©solus</div></div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-top:12px;">
                            <div class="stat-box" style="text-align:center; background:rgba(0, 255, 157, 0.1); border-color:var(--success)"><div class="stat-number" style="color:var(--success);">${prog.correct}</div><div class="stat-label">Corrects</div></div>
                            <div class="stat-box" style="text-align:center; background:rgba(255, 77, 77, 0.1); border-color:var(--error)"><div class="stat-number" style="color:var(--error);">${prog.incorrect}</div><div class="stat-label">Incorrects</div></div>
                            </div>`;
            const btnDiag = document.createElement('button'); btnDiag.className='btn'; btnDiag.textContent='ü©∫ Lancer Diagnostic'; btnDiag.style.marginTop='24px'; btnDiag.style.width='100%'; btnDiag.onclick=renderDemographics;
            const btnGloss = document.createElement('button'); btnGloss.className='link'; btnGloss.textContent='üìö Glossaire'; btnGloss.style.marginTop='12px'; btnGloss.onclick=renderGlossary;
            const btnProf = document.createElement('button'); btnProf.className='link'; btnProf.textContent='üë§ Profil'; btnProf.style.marginTop='6px'; btnProf.onclick=renderProfile;
            card.appendChild(btnDiag); card.appendChild(btnGloss); card.appendChild(btnProf); app.appendChild(card);
        }

        function renderProfile() {
            const app = q('#app'); app.innerHTML='';
            const prog = state.progression;
            const total = prog.correct + prog.incorrect;
            const successRate = total > 0 ? Math.round((prog.correct / total) * 100) : 0;
            const card = document.createElement('div'); card.className='card center';
            const title = document.createElement('h2'); title.textContent=`üë§ Profil de ${state.pseudo || 'Utilisateur'}`; card.appendChild(title);
            const gridDiv = document.createElement('div');
            gridDiv.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-top:12px;';
            gridDiv.innerHTML=`<div class="stat-box"><div class="stat-number" style="color:var(--success);">${prog.correct}</div><div class="stat-label">‚úì Corrects</div></div>
                               <div class="stat-box"><div class="stat-number" style="color:var(--error);">${prog.incorrect}</div><div class="stat-label">‚úó Incorrects</div></div>`;
            card.appendChild(gridDiv);
            const statRate = document.createElement('div');
            statRate.className='stat-box'; statRate.style.width='100%';
            statRate.style.cssText='margin-top:12px;background:rgba(0, 255, 157, 0.1);border-color:var(--success);';
            statRate.innerHTML=`<div class="stat-number" style="color:var(--success);">${successRate}%</div><div class="stat-label">Taux de r√©ussite</div>`;
            card.appendChild(statRate);
            const btnReset = document.createElement('button');
            btnReset.className = 'link'; btnReset.style.color = 'var(--error)'; btnReset.style.marginTop = '20px'; btnReset.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            btnReset.textContent = 'üóëÔ∏è R√©initialiser Stats';
            btnReset.onclick = async () => {
                if(confirm("Voulez-vous vraiment effacer toutes vos statistiques ?")) {
                    state.progression = { correct: 0, incorrect: 0 }; await saveProgression(); renderProfile(); showAlert("Statistiques remises √† z√©ro", "success");
                }
            };
            card.appendChild(btnReset);
            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='üè† Retour';
            btnBack.style.marginTop='20px'; btnBack.onclick=renderHome;
            card.appendChild(btnBack); app.appendChild(card);
        }

        // =================== JEU (DIAGNOSTIC) ===================

        function renderDemographics() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card';
            card.innerHTML=`<h3>üìã Donn√©es d√©mographiques</h3><p class="small" style="margin-bottom:20px">Param√©trez le patient virtuel.</p>`;
            const createSel = (lbl, id, opts) => {
                const l = document.createElement('label'); l.textContent=lbl; l.style.color='var(--accent)';
                const s = document.createElement('select'); s.id=id; s.className='input';
                opts.forEach(o=> { const op=document.createElement('option'); op.value=o[0]; op.textContent=o[1]; s.appendChild(op); });
                card.appendChild(l); card.appendChild(s);
            };
            createSel("Sexe", "demo-sexe", [["rien","Al√©atoire / Inconnu"],["femme","Femme"],["homme","Homme"]]);
            createSel("Plus de 30 ans ?", "demo-30", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
            createSel("Plus de 65 ans ?", "demo-65", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
            createSel("Ant√©c√©dents familiaux ?", "demo-atcd", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
            createSel("Fumeur ?", "demo-tabac", [["rien","Je ne sais pas"],["oui","Oui"],["non","Non"]]);
            
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            const btnStart = document.createElement('button'); btnStart.className='btn'; btnStart.textContent='‚ñ∂Ô∏è D√©marrer';
            btnStart.onclick=()=>{ 
            state.demo = {
                femme: q('#demo-sexe').value === 'femme', homme: q('#demo-sexe').value === 'homme',
                plus_de_30ans: q('#demo-30').value === 'oui', plus_de_65ans: q('#demo-65').value === 'oui',
                atcd_famille: q('#demo-atcd').value === 'oui', tabac: q('#demo-tabac').value === 'oui'
            };
            state.answers={}; state.asked=[]; state.diagnosticShown=false; state.previousDiagnostics=[]; state.history=[];
            askNextQuestion();
            };
            const btnCancel = document.createElement('button'); btnCancel.className='link'; btnCancel.textContent='Annuler'; btnCancel.onclick=renderHome;
            btnGroup.appendChild(btnStart); btnGroup.appendChild(btnCancel); card.appendChild(btnGroup); app.appendChild(card);
        }

        function prepareSigns() {
            let allSignsSet = new Set();
            PATHOLOGIES.forEach(p => { Object.keys(p.signes).forEach(s => allSignsSet.add(s)); });
            state.allSigns = Array.from(allSignsSet);
        }

        function rankPathologies() {
            const scores = PATHOLOGIES.map(p => {
                let score = 0;
                for(const facteur in p.facteurs){ if(state.demo[facteur] === true) score += p.facteurs[facteur]; }
                for(const signe in p.signes){
                    const ans = state.answers[signe];
                    if(ans === true) score += p.signes[signe];
                    else if(ans === false) score -= (p.signes[signe] * 0.5);
                }
                return {patho:p, score: Math.max(0, score)};
            });
            const totalScore = scores.reduce((sum, s) => sum + s.score, 0);
            state.ranked = scores.map(s => ({
                ...s, prob: totalScore > 0 ? ((s.score / totalScore) * 100).toFixed(1) : 0
            })).sort((a,b)=>b.prob - a.prob);
        }

        function getNextSmartSign(rankedPathos, remainingSigns) {
            if (rankedPathos.length < 2) return remainingSigns[Math.floor(Math.random() * remainingSigns.length)];
            const top1 = rankedPathos[0].patho, top2 = rankedPathos[1].patho;
            let best=null, maxD=-1;
            remainingSigns.forEach(s => {
                const w1 = top1.signes[s] || 0, w2 = top2.signes[s] || 0;
                const d = Math.abs(w1 - w2);
                if (d > maxD) { maxD = d; best = s; }
            });
            return (best && maxD > 0) ? best : remainingSigns[Math.floor(Math.random() * remainingSigns.length)];
        }

        function canShowDiagnostic() {
            const qNum = state.asked.length;
            if(state.ranked.length===0) return false;
            const topProb = parseFloat(state.ranked[0].prob);
            const topName = state.ranked[0].patho.name;
            if(state.previousDiagnostics.includes(topName)) return false;
            if(qNum >= 8 && topProb >= 90) return true;
            if(qNum >= 14 && topProb >= 85) return true;
            if(qNum >= 17 && topProb >= 75) return true;
            return false;
        }

        // --- NOUVELLE FONCTION POUR GERER LE RETOUR ARRIERE ---
        function renderCurrentQuestion() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            const signe = state.currentSign;
            
            card.innerHTML=`<div class="small" style="margin-bottom:12px; color:var(--accent)">QUESTION ${state.asked.length}</div>
                            <div class="question-text">Le patient pr√©sente-t-il :<br><strong style="font-size:1.2em; color:white;">${formatSigneName(signe)}</strong> ?</div>`;
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            
            const mkBtn = (txt, cls, val) => {
                const b = document.createElement('button'); b.className=cls; b.textContent=txt;
                b.onclick=()=>{ 
                    // SAUVEGARDE ETAT POUR RETOUR
                    state.history.push(JSON.stringify({
                        answers: state.answers,
                        asked: state.asked,
                        currentSign: state.currentSign
                    }));
                    
                    // REPONSE
                    state.answers[signe]=val; 
                    askNextQuestion(); 
                };
                btnGroup.appendChild(b);
            };
            mkBtn('OUI', 'btn btn-success', true);
            mkBtn('NON', 'btn btn-error', false);
            mkBtn('Je ne sais pas', 'link', null);
            card.appendChild(btnGroup);

            // BOUTONS NAVIGATION
            const navGroup = document.createElement('div');
            navGroup.style.display = 'flex';
            navGroup.style.gap = '15px';
            navGroup.style.marginTop = '20px';

            // Bouton Retour (si historique existe)
            if(state.history.length > 0) {
                const btnBack = document.createElement('button');
                btnBack.className='btn-back'; btnBack.textContent='‚¨ÖÔ∏è Retour';
                btnBack.onclick = () => {
                    const prevState = JSON.parse(state.history.pop());
                    state.answers = prevState.answers;
                    state.asked = prevState.asked;
                    state.currentSign = prevState.currentSign;
                    renderCurrentQuestion();
                };
                navGroup.appendChild(btnBack);
            }

            const btnAb = document.createElement('button'); btnAb.className='link'; btnAb.textContent='Abandonner'; 
            btnAb.onclick=renderHome;
            navGroup.appendChild(btnAb);
            card.appendChild(navGroup);

            app.appendChild(card);
        }

        function askNextQuestion() {
            prepareSigns(); rankPathologies();
            if(canShowDiagnostic()){ showDiagnostic(); return; }
            const remaining = state.allSigns.filter(s => !state.asked.includes(s));
            if(remaining.length===0){ showDiagnostic(); return; }
            
            const signe = getNextSmartSign(state.ranked, remaining);
            state.currentSign = signe; state.asked.push(signe);
            
            renderCurrentQuestion();
        }

        function showDiagnostic() {
            const app = q('#app');
            app.innerHTML = '';
            const loadingCard = document.createElement('div');
            loadingCard.className = 'card center';
            loadingCard.innerHTML = `
                <h3 style="color:var(--accent)">üîé Analyse IA en cours...</h3>
                <div style="margin: 30px 0; font-size: 50px; animation: spin 0.8s infinite linear;">‚öôÔ∏è</div>
                <p class="small">Comparaison base de donn√©es...</p>
            `;
            app.appendChild(loadingCard);

            setTimeout(() => {
                rankPathologies();
                const top = state.ranked[0];
                state.diagnosticShown = true;
                state.previousDiagnostics.push(top.patho.name);

                app.innerHTML = ''; 
                const card = document.createElement('div'); card.className='card center';
                const title = document.createElement('h2'); title.textContent='üí° Diagnostic Propos√©'; card.appendChild(title);
                
                let pdfButton = top.patho.pdf && top.patho.pdf !== '#' ? 
                    `<a class="link" style="color:var(--accent); border-color:var(--accent); display:inline-block; margin-top:10px;" href="${top.patho.pdf}" target="_blank">üìÑ Voir fiche PDF</a>` : 
                    `<span class="small" style="opacity:0.5">üìÑ Pas de fiche PDF</span>`;
                
                const diagDiv = document.createElement('div'); diagDiv.className='diagnostic-result';
                diagDiv.innerHTML = `<div class="diagnostic-name">${top.patho.name}</div>
                                     <div class="patho-desc" style="margin-top:8px">${top.patho.short}</div>
                                     <div class="score-badge">Probabilit√© : ${top.prob}%</div><br>
                                     ${pdfButton}`;
                card.appendChild(diagDiv);
                
                const btnGroup = document.createElement('div'); btnGroup.className='button-group';
                const btnTrue = document.createElement('button'); btnTrue.className='btn btn-success'; btnTrue.textContent='‚úÖ Correct';
                btnTrue.onclick = async () => { 
                    state.progression.correct++;
                    await saveProgression(); 
                    showAlert('Diagnostic valid√© !','success'); showDiagnosticDetails(top);
                };
                const btnFalse = document.createElement('button'); btnFalse.className='btn btn-error'; btnFalse.textContent='‚ùå Incorrect';
                btnFalse.onclick = async () => { 
                    state.progression.incorrect++;
                    await saveProgression(); 
                    showAlert('A√Øe... Continuons','error'); state.diagnosticShown=false; setTimeout(()=>askNextQuestion(), 800);
                };
                btnGroup.appendChild(btnTrue); btnGroup.appendChild(btnFalse); card.appendChild(btnGroup); app.appendChild(card);
            }, 1500);
        }

        function showDiagnosticDetails(top) {
            const app = q('#app'); app.innerHTML = '';
            const card = document.createElement('div'); card.className='card';
            const title = document.createElement('h2'); title.innerHTML = `‚úÖ ${top.patho.name}`; card.appendChild(title);
            const desc = document.createElement('div'); desc.className='patho-desc'; desc.textContent = top.patho.short; desc.style.marginBottom='20px'; desc.style.textAlign='center'; card.appendChild(desc);
            
            const pathoSigns = Object.keys(top.patho.signes);
            const correctSigns = [], missingSigns = [], erroneousSigns = [];
            
            pathoSigns.forEach(s => {
                const val = state.answers[s];
                if(val === true) correctSigns.push(s); else if(val === false) missingSigns.push(s);
            });
            state.allSigns.forEach(s => { if(state.answers[s] === true && !pathoSigns.includes(s)) erroneousSigns.push(s); });
            
            const resultsDiv = document.createElement('div'); resultsDiv.className='result-list';
            const createList = (title, items, type, typeLabel) => {
                if(items.length > 0) {
                    const h = document.createElement('h4'); h.textContent = `${title} (${items.length})`; h.style.marginTop='12px'; h.style.color='white'; resultsDiv.appendChild(h);
                    items.forEach(s => {
                        const r = document.createElement('div'); r.className='result-item result-'+type;
                        r.innerHTML = `<div>${formatSigneName(s)}</div><div style="opacity:0.8; font-size:0.9em">${typeLabel}</div>`;
                        resultsDiv.appendChild(r);
                    });
                }
            };
            createList("Signes corrects", correctSigns, "correct", "OK");
            createList("Signes attendus manquants", missingSigns, "missing", "Manqu√©");
            createList("Signes coch√©s par erreur", erroneousSigns, "error", "Erreur");
            card.appendChild(resultsDiv);
            
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            const btnHome = document.createElement('button'); btnHome.className='btn'; btnHome.textContent = 'üè† Retour Accueil'; btnHome.onclick = renderHome;
            btnGroup.appendChild(btnHome); card.appendChild(btnGroup); app.appendChild(card);
        }

        function renderGlossary() {
            const app = q('#app'); app.innerHTML='';
            const titleCard = document.createElement('div'); titleCard.className='card center'; titleCard.innerHTML='<h2>üìö Glossaire Pathologies</h2>'; 
            
            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='üè† Retour';
            btnBack.style.marginBottom='20px'; btnBack.onclick=renderHome;
            titleCard.appendChild(btnBack);
            app.appendChild(titleCard);

            const grid = document.createElement('div'); grid.className='glossary-grid';
            PATHOLOGIES.forEach(p=>{
                const card = document.createElement('div'); card.className='patho-card clickable';
                card.innerHTML=`<div class="patho-name">${p.name}</div><div class="patho-desc">${p.short}</div>`;
                card.onclick=()=>{ 
                    if(p.pdf && p.pdf !== '#') window.open(p.pdf,'_blank'); 
                    else showAlert('Fiche PDF non disponible','error'); 
                };
                grid.appendChild(card);
            });
            app.appendChild(grid);
        }
    </script>
</body>
</html>
