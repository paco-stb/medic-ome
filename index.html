<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="google-site-verification" content="8SyBOdC5YhaXDqfNYGfzP1EZbb0iQWABpkImmZHXG30" />
    
    <title>Medicome - Plateforme d'entra√Ænement sur des Cas Cliniques pour les √©tudiants en M√©decine.</title>
    
    <meta name="description" content="Entra√Ænez-vous au diagnostic m√©dical avec Medicome. Une IA interactive pour r√©viser la s√©miologie, les pathologies et r√©ussir vos examens de m√©decine (Externat, ECN, EDN).">
    
    <meta name="keywords" content="diagnostic m√©dical, cas cliniques, s√©miologie, r√©vision m√©decine, ECN, EDN, externat, intelligence artificielle sant√©, quiz m√©dical">
    
    <meta property="og:title" content="Medicome - L'IA de Diagnostic M√©dical">
    <meta property="og:description" content="Testez vos connaissances : l'IA devine la pathologie ou c'est vous qui la d√©fiez.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://medicome.fr/">
    <link rel="canonical" href="https://medicome.fr/" />
    <link rel="icon" href="favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ================= STYLE GLOBAL ================= */
        :root {
          --bg-dark: #020b16;
          --bg-light: #1e3c72;
          --glass-bg: rgba(13, 25, 48, 0.85);
          --glass-border: rgba(100, 200, 255, 0.15);
          --accent: #00d2ff;
          --accent-glow: rgba(0, 210, 255, 0.4);
          --text-main: #ffffff;
          --text-muted: #b0c4de;
          --success: #00ff9d;
          --error: #ff4d4d;
          --gold: #ffd700;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        
        body {
          font-family: 'Inter', sans-serif;
          background: radial-gradient(circle at 50% 0%, var(--bg-light), var(--bg-dark) 80%);
          background-attachment: fixed;
          color: var(--text-main);
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }

        /* HEADER & NOTIFICATIONS */
        header {
          display: flex;
          justify-content: space-between;
          padding: 10px 24px;
          background: rgba(2, 11, 22, 0.8);
          backdrop-filter: blur(15px);
          -webkit-backdrop-filter: blur(15px);
          align-items: center;
          border-bottom: 1px solid var(--glass-border);
          position: sticky; top: 0; z-index: 100;
          box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .logo-img { height: 50px; width: auto; filter: drop-shadow(0 0 8px var(--accent-glow)); transition: transform 0.3s; }
        .brand:hover .logo-img { transform: scale(1.05); }
        
        .top-right { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        
        /* Notification Bell */
        .notif-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; }
        .notif-icon { width: 24px; height: 24px; fill: var(--text-muted); transition: fill 0.3s; }
        .notif-btn:hover .notif-icon { fill: var(--accent); }
        .notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--error); border-radius: 50%; display: none; border: 1px solid var(--bg-dark); }
        
        /* Notification Dropdown/Modal */
        .notif-modal {
            position: absolute; top: 60px; right: 20px; width: 300px;
            background: var(--bg-dark); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 15px; z-index: 200;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            display: none; max-height: 400px; overflow-y: auto;
        }
        .notif-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 0; font-size: 13px; }
        .notif-item:last-child { border-bottom: none; }
        .notif-date { font-size: 11px; color: var(--accent); margin-bottom: 4px; }

        .pseudo { 
            color:var(--accent); font-weight:600; padding:6px 12px; 
            background: rgba(0, 210, 255, 0.05); 
            border: 1px solid var(--glass-border);
            border-radius:20px; cursor:pointer; font-size: 14px; 
            display: flex; align-items: center; gap: 8px;
        }

        /* BUTTONS */
        .link {
          background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1);
          color: var(--text-muted); padding:8px 16px; border-radius:8px;
          cursor:pointer; transition:all 0.3s; font-size:14px;
        }
        .link:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--accent); }

        .btn { 
            background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%);
            border:none; padding:14px 24px; border-radius:12px; 
            color: #000; cursor:pointer; font-weight:700; font-size:15px; 
            transition:all 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:hover { transform:translateY(-2px); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: #022015; box-shadow: 0 4px 15px rgba(0, 176, 155, 0.4); }
        .btn-error { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; box-shadow: 0 4px 15px rgba(203, 45, 62, 0.4); }

        /* LAYOUT & CARDS */
        main { flex:1; max-width:1000px; width:100%; margin:0 auto; padding:30px 20px; display:flex; flex-direction:column; align-items:center; }
        
        .card { 
            background: var(--glass-bg); backdrop-filter: blur(12px);
            padding:32px; border-radius:20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.6), inset 0 0 0 1px var(--glass-border); 
            margin-bottom:16px; width:100%; max-width:600px; 
            transition: transform 0.3s ease; animation: fadeIn 0.5s ease-out;
        }
        .card h2 { margin-bottom:20px; font-size:26px; text-align:center; color: white; }
        
        /* INPUTS */
        .input, select, textarea { 
            width:100%; padding:14px; border-radius:10px; 
            border:1px solid rgba(255,255,255,0.15); 
            background: rgba(0,0,0,0.3); color: var(--text-main); 
            margin-top:8px; margin-bottom:12px; font-size:14px; font-family: 'Inter', sans-serif;
        }
        .input:focus, textarea:focus { outline:none; border-color:var(--accent); background: rgba(0,0,0,0.5); }
        
        /* STARS RATING */
        .star-rating { display: flex; gap: 5px; justify-content: center; margin: 10px 0; direction: rtl; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 25px; color: #444; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--gold); }

        /* ELEMENTS */
        .center { text-align:center; display:flex; flex-direction:column; align-items:center; }
        .button-group { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:12px; width: 100%; }
        .small { opacity:0.6; font-size:13px; color:var(--text-muted); margin-top:12px; text-align:center; }
        .alert { padding:14px; border-radius:10px; margin:12px 0; font-size:14px; width: 100%; text-align: center; }
        .alert-success { background: rgba(0, 255, 157, 0.1); border:1px solid var(--success); color:var(--success); }
        .alert-error { background: rgba(255, 77, 77, 0.1); border:1px solid var(--error); color:var(--error); }
        .alert-info { background: rgba(0, 210, 255, 0.1); border:1px solid var(--accent); color:var(--accent); }

        /* FOOTER */
        footer { 
            text-align:center; padding:30px 20px; 
            background: rgba(0,0,0,0.5); font-size:13px; 
            border-top: 1px solid rgba(255,255,255,0.05); 
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .footer-nav { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;}
        .footer-link { color: var(--text-muted); text-decoration: none; cursor: pointer; transition: color 0.2s; }
        .footer-link:hover { color: var(--accent); text-decoration: underline; }

        /* LEGAL MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: var(--bg-dark); padding: 30px; border-radius: 20px;
            max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
            border: 1px solid var(--glass-border); text-align: left;
        }
        .modal-content h3 { color: var(--accent); margin-top: 20px; margin-bottom: 10px; }
        .modal-content p { font-size: 14px; line-height: 1.6; color: var(--text-muted); margin-bottom: 10px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="brand" id="brandLogo">
            <img src="logo.png" alt="Medicome Logo" class="logo-img">
            <h1 style="font-size:18px; font-weight:700;">Medicome</h1>
        </div>
        
        <div class="top-right">
            <button class="notif-btn" id="notifBtn" title="Nouveaut√©s">
                <svg class="notif-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                <div class="notif-badge" id="notifBadge"></div>
            </button>
            <div class="notif-modal" id="notifModal">
                <h4 style="color:white; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">üîî Nouveaut√©s & Mises √† jour</h4>
                <div id="notifContent">
                    <div class="small">Chargement...</div>
                </div>
            </div>

            <button id="homeBtn" class="link" style="display:none;">Accueil</button>
            <div id="pseudoBox" class="pseudo" style="display:none;">Utilisateur</div>
            <button id="logoutBtn" class="link" style="display:none;">D√©connexion</button>
        </div>
    </header>

    <main id="app">
        <div class="center" id="landing-content" style="padding: 20px; text-align: center;">
            <div style="font-size: 50px; margin-bottom: 20px;">ü©∫</div>
            <h1 style="font-size: 2rem; margin-bottom: 10px; color: white;">Medicome</h1>
            <h2 style="font-size: 1.2rem; color: var(--accent); margin-bottom: 20px; font-weight: normal;">
                L'IA d'entra√Ænement au diagnostic m√©dical
            </h2>
            <div style="max-width: 600px; margin: 0 auto; color: var(--text-muted); line-height: 1.5;">
                <p>Pr√©parez vos ECN, EDN et examens de m√©decine (Externat) gr√¢ce √† notre simulateur de cas cliniques. Challengez notre IA sur la s√©miologie, le diagnostic diff√©rentiel et les pathologies.</p>
            </div>
            
            <div style="margin-top: 40px;">
                <div style="font-size: 30px; animation: spin 1s infinite linear;">‚öôÔ∏è</div>
                <div class="small" style="margin-top: 10px;">Initialisation de l'application...</div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="legalModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:white;">Mentions L√©gales</h2>
                <button onclick="document.getElementById('legalModal').style.display='none'" class="link">Fermer</button>
            </div>
            <div id="legalTextContent">
                </div>
        </div>
    </div>

    <footer>
        <div class="footer-nav">
            <span class="footer-link" onclick="window.scrollTo(0,0)">Haut de page</span>
            <span class="footer-link" id="reviewsLink">Avis Utilisateurs</span>
            <span class="footer-link" id="contactLink">Nous Contacter</span>
            <span class="footer-link" onclick="renderLegal()">Mentions L√©gales & Confidentialit√©</span>
        </div>
        <div style="margin-top:10px; opacity:0.6;">Medicome ¬© 2025 - Outil p√©dagogique pour √©tudiants en sant√©</div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG FIREBASE (Remplir avec tes cl√©s si besoin, sinon utilise celles-ci)
        const firebaseConfig = {
            apiKey: "AIzaSyCig9G4gYHU5h642YV1IZxthYm_IXp6vZU",
            authDomain: "medicome-paco.firebaseapp.com",
            projectId: "medicome-paco",
            storageBucket: "medicome-paco.firebasestorage.app",
            messagingSenderId: "332171806096",
            appId: "1:332171806096:web:36889325196a7a718b5f15",
            measurementId: "G-81HJ9DWBMX"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase Error", error); }

        let PATHOLOGIES = [];
        let state = {
            currentUser: null, pseudo: null, 
            progression: { correct: 0, incorrect: 0, streak: 0, mastery: {} },
            isGuest: false, history: [],
            confirmationMode: false, confirmationQueue: [], confirmedPatho: null, priorityQueue: [],
            answers:{}, asked:[], allSigns:[], ranked: [], notifications: []
        };
        const REFINEMENTS = {
            "douleur_abdominale": ["douleur_fosse_iliaque_droite", "douleur_hypocondre_droit", "douleur_fosse_iliaque_gauche", "douleur_epigastrique", "douleur_transfixiante_dos", "douleur_bas_ventre", "douleur_pelvienne", "douleur_abdominale_diffuse", "crampes_abdominales", "douleur_abdominale_intermittente", "douleur_sus_pubienne", "troubles_transit"],
            "douleur_thoracique": ["douleur_thoracique_oppressive", "douleur_thoracique_dechirante", "douleur_thoracique_cot√©", "douleur_basithoracique", "douleur_inspiration", "douleur_thoracique_point_cote"],
            "douleur_dos": ["douleur_lombaire_brutale", "douleur_lombaire_unilaterale", "douleur_lombaire", "douleur_bas_dos", "douleur_bas_dos_nuit", "douleur_dos_os", "douleur_dos_brutale"],
            "douleur_membre_traumatisme": ["impossibilite_marcher", "douleur_poignet", "chute_recente", "jambe_froide_pale", "douleur_articulaire_intense", "douleur_gros_orteil", "douleur_jambe_brutale_intense", "douleur_aine_hanche", "douleur_mains", "douleur_talon", "fourmillements_doigts"],
            "dyspnee": ["dyspnee_effort", "orthopnee_dyspnee_couchee", "dyspnee_brutale", "dyspnee_sifflante", "essoufflement_aggrave", "gene_respiratoire"],
            "toux": ["toux_seche", "toux_grasse", "toux_sanglante", "chant_du_coq", "toux_chronique", "toux_nuit"],
            "troubles_visuels": ["vision_floue", "vision_double", "baisse_vision_brutale", "amputation_champ_visuel", "eclairs_lumineux", "mouches_devant_yeux", "vision_centrale_floue", "vision_double_un_oeil", "trouble_vision_flou"],
            "troubles_neuro": ["paralysie_unilaterale", "troubles_parole_aphasie", "asymetrie_visage", "perte_sensibilite", "perte_equilibre", "tremblement_repos", "lenteur_mouvements", "machoire_bloquee", "corps_raide_contracte", "paralysie_descend_tete_vers_pieds", "paralysie_monte_pieds_vers_tete", "perte_connaissance"],
            "cephalees": ["cephalees_intenses", "cephalees_explosives_brutales", "mal_tete_unilateral"],
            "anomalie_peau": ["plaques_rouges", "vesicules_bulles", "demangeaisons", "grain_beaute_suspect", "tache_noire", "jambe_rouge", "purpura", "taches_rouges_jambes", "taches_rouges_peau", "tache_rouge_s_etend_peau", "plaques_rouges_croutes", "perle_translucide_peau", "croute_ne_guerit_pas", "boutons_bulles_corps", "taches_peau_purpura", "eruption_boutons_corps", "eruption_corps", "peau_aspect_granite", "boule_aine_douloureuse_dure"],
            "trouble_psy": ["tristesse_permanente", "delire_paranoiaque", "hallucinations", "perte_memoire", "agitation", "excitation_euphorie", "maigreur_extreme", "ne_se_lave_plus", "oubli_faits_recents", "cherches_ses_mots"],
            "genes_urinaires": ["sang_urines", "brulures_urinaires", "impossibilite_uriner", "regles_tres_abondantes", "douleur_testicule_brutale", "pertes_vaginales_anormales", "sang_urines_rouge", "difficulte_uriner", "urines_abondantes", "urines_mousseuses"]
        };

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- INIT ---
        async function initApp() {
            try {
                const response = await fetch('./pathologies.json');
                if (!response.ok) throw new Error("Erreur chargement pathologies");
                PATHOLOGIES = await response.json();
                
                // DEEP LINKING (Lien direct vers fiche)
                const urlParams = new URLSearchParams(window.location.search);
                const ficheDemandee = urlParams.get('fiche');
                if (ficheDemandee) {
                    const pathoTrouvee = PATHOLOGIES.find(p => p.name.toLowerCase() === ficheDemandee.toLowerCase());
                    if (pathoTrouvee) {
                        q('#app').innerHTML = '';
                        showDiagnosticDetails({patho: pathoTrouvee}); // Mode lecture seule
                        return; // Stop le reste de l'init
                    }
                }

                startAuthListener();
                fetchNotifications(); // Charger les actus

                // Event Listeners
                q('#contactLink').onclick = renderContact;
                q('#reviewsLink').onclick = renderReviews;
                q('#brandLogo').onclick = () => { if (state.currentUser || state.isGuest) renderHome(); };
                
                // NOTIFICATION LOGIC
                const notifBtn = q('#notifBtn');
                const notifModal = q('#notifModal');
                notifBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isVisible = notifModal.style.display === 'block';
                    notifModal.style.display = isVisible ? 'none' : 'block';
                    if(!isVisible) {
                        q('#notifBadge').style.display = 'none'; // Mark as read locally
                    }
                };
                window.onclick = () => { notifModal.style.display = 'none'; }; // Close when clicking outside

                // GLOBAL : Make renderLegal accessible from HTML
                window.renderLegal = renderLegal;

            } catch (err) {
                console.error(err);
                q('#app').innerHTML = `<div class="card center"><h2 style="color:var(--error)">Erreur Technique</h2><p>${err.message}</p></div>`;
            }
        }
        initApp();

        // --- NOTIFICATIONS ---
        async function fetchNotifications() {
            try {
                const qRef = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
                const snapshot = await getDocs(qRef);
                const container = q('#notifContent');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="small">Aucune nouveaut√© pour le moment.</div>';
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    const div = document.createElement('div');
                    div.className = 'notif-item';
                    const dateStr = n.date && n.date.seconds ? new Date(n.date.seconds * 1000).toLocaleDateString() : 'R√©cemment';
                    div.innerHTML = `<div class="notif-date">${dateStr}</div><div style="color:white;">${n.message}</div>`;
                    container.appendChild(div);
                });
                
                // Show badge (simple logic: if there are notifs, show badge)
                q('#notifBadge').style.display = 'block';
                
            } catch (e) {
                console.log("Erreur notifs (Probablement permission):", e);
                q('#notifContent').innerHTML = '<div class="small">Impossible de charger les actus.</div>';
            }
        }

        // --- AUTH & STATE ---
        function startAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user; state.isGuest = false;
                    let dName = user.displayName || user.email.split('@')[0];
                    state.pseudo = dName;
                    const docRef = doc(db, "users", user.uid);
                    try {
                        const snap = await getDoc(docRef);
                        if(snap.exists()) {
                            const data = snap.data();
                            if(data.progression) state.progression = data.progression;
                            if(data.pseudo) state.pseudo = data.pseudo;
                        }
                        updateHeader(); renderHome();
                    } catch(e) { renderHome(); }
                } else {
                    const savedGuest = localStorage.getItem('medicome_guest_progression');
                    if (savedGuest) {
                        state.isGuest = true;
                        state.pseudo = localStorage.getItem('medicome_guest_pseudo');
                        state.progression = JSON.parse(savedGuest);
                        updateHeader(); renderHome();
                    } else {
                        renderLogin(); updateHeader();
                    }
                }
            });
        }

        function updateHeader(){
            const pseudoBox = q("#pseudoBox");
            if(state.pseudo){ 
                pseudoBox.innerHTML = state.pseudo + (state.isGuest ? " (Local)" : ""); 
                pseudoBox.style.display='inline-block'; pseudoBox.onclick=renderProfile;
                q("#homeBtn").style.display='inline-block';
                q("#logoutBtn").style.display='inline-block';
                q("#logoutBtn").onclick = () => {
                    localStorage.clear(); location.reload();
                    signOut(auth);
                };
            } else {
                pseudoBox.style.display='none'; q("#homeBtn").style.display='none'; q("#logoutBtn").style.display='none';
            }
            q("#homeBtn").onclick = renderHome;
        }

        function q(sel){ return document.querySelector(sel); }
        function showAlert(msg,type){
            const d = document.createElement('div'); d.className=`alert alert-${type}`; d.textContent=msg;
            q('#app').prepend(d); setTimeout(()=>d.remove(),3000);
        }
        async function saveProgression() {
            if(!state.isGuest && state.currentUser) {
                await setDoc(doc(db,"users",state.currentUser.uid), { progression:state.progression, pseudo:state.pseudo }, {merge:true});
            } else if(state.isGuest) {
                localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
            }
        }

        // --- PAGES ---

        function renderLogin() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>‚òÅÔ∏è Connexion</h2><p class="small">Pour sauvegarder votre progression</p>`;
            
            const email = document.createElement('input'); email.className='input'; email.placeholder='Email';
            const pass = document.createElement('input'); pass.className='input'; pass.type='password'; pass.placeholder='Mot de passe';
            
            const btnLogin = document.createElement('button'); btnLogin.className='btn'; btnLogin.textContent='Se connecter';
            btnLogin.onclick = async () => {
                try { await signInWithEmailAndPassword(auth, email.value, pass.value); } 
                catch(e) { showAlert(e.message, 'error'); }
            };

            // Mode invit√©
            const btnGuest = document.createElement('button'); btnGuest.className='link'; btnGuest.textContent='Continuer sans compte (Mode invit√©)';
            btnGuest.style.marginTop='20px';
            btnGuest.onclick = () => {
                state.isGuest = true; state.pseudo = "Invit√©"; state.progression = {correct:0,incorrect:0,streak:0,mastery:{}};
                localStorage.setItem('medicome_guest_pseudo', 'Invit√©');
                localStorage.setItem('medicome_guest_progression', JSON.stringify(state.progression));
                updateHeader(); renderHome();
            };

            card.append(email, pass, btnLogin, btnGuest);
            app.appendChild(card);
        }

        function renderHome() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>üëã Bonjour ${state.pseudo}</h2>
            <div class="stat-box" style="margin:20px 0; font-size:1.2em;">Score: <span style="color:var(--success)">${state.progression.correct}</span> / <span style="color:var(--error)">${state.progression.incorrect}</span></div>
            <p style="margin-bottom:20px; color:var(--text-muted);">Pr√™t pour un nouveau cas clinique ? L'IA va tester vos connaissances.</p>`;
            
            const btnStart = document.createElement('button'); btnStart.className='btn'; btnStart.textContent='ü©∫ Lancer le d√©fi';
            btnStart.style.width='100%';
            btnStart.onclick = renderDemographics;

            const btnProfile = document.createElement('button'); btnProfile.className='link'; btnProfile.textContent='üë§ Mon Profil';
            btnProfile.onclick = renderProfile;

            card.append(btnStart, btnProfile);
            app.appendChild(card);
        }

        function renderProfile() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>Profil</h2><div class="small">Statistiques et progression</div>`;
            
            // Stats visualization could go here
            const stats = document.createElement('div');
            stats.innerHTML = `<div style="margin:20px 0;">S√©rie actuelle: üî• ${state.progression.streak || 0}</div>`;
            
            const btnReset = document.createElement('button'); btnReset.className='link'; btnReset.style.color='var(--error)'; btnReset.textContent='R√©initialiser progression';
            btnReset.onclick = async () => {
                if(confirm("S√ªr ?")) {
                    state.progression = {correct:0, incorrect:0, streak:0, mastery:{}};
                    await saveProgression(); renderProfile();
                }
            };

            const btnBack = document.createElement('button'); btnBack.className='btn'; btnBack.textContent='Retour';
            btnBack.onclick = renderHome;

            card.append(stats, btnReset, btnBack);
            app.appendChild(card);
        }

        // --- REVIEWS SYSTEM ---
        async function renderReviews() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>‚≠ê Avis Utilisateurs</h2>`;

            // Formulaire d'ajout
            const formDiv = document.createElement('div');
            formDiv.style.background = 'rgba(255,255,255,0.05)'; formDiv.style.padding='15px'; formDiv.style.borderRadius='10px'; formDiv.style.width='100%'; formDiv.style.marginBottom='20px';
            
            formDiv.innerHTML = `<h4 style="margin-bottom:10px; color:var(--accent);">Laisser un avis</h4>
            <div class="star-rating">
                <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">‚òÖ</label>
                <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">‚òÖ</label>
                <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">‚òÖ</label>
                <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">‚òÖ</label>
                <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">‚òÖ</label>
            </div>
            <textarea id="reviewText" class="input" placeholder="Votre commentaire..." style="min-height:60px;"></textarea>
            <button id="submitReviewBtn" class="btn" style="width:100%; font-size:13px;">Publier l'avis</button>`;
            
            card.appendChild(formDiv);

            // Charger les avis existants (Fake + Real)
            const reviewsContainer = document.createElement('div'); reviewsContainer.style.width='100%';
            
            // Load real reviews from Firestore
            try {
                const qRev = query(collection(db, "reviews"), orderBy("date", "desc"), limit(10));
                const snap = await getDocs(qRev);
                snap.forEach(doc => {
                    const r = doc.data();
                    const stars = "‚òÖ".repeat(r.rating) + "‚òÜ".repeat(5-r.rating);
                    const div = document.createElement('div'); 
                    div.style.background='rgba(0,0,0,0.3)'; div.style.padding='10px'; div.style.marginBottom='10px'; div.style.borderRadius='8px'; div.style.textAlign='left';
                    div.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong style="color:white;">${r.pseudo}</strong> <span style="color:var(--gold)">${stars}</span></div><div style="font-size:13px; color:var(--text-muted); margin-top:5px;">${r.text}</div>`;
                    reviewsContainer.appendChild(div);
                });
            } catch(e) { console.log("Reviews load error", e); }

            card.appendChild(reviewsContainer);
            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='Retour'; btnBack.onclick = () => { if(state.pseudo) renderHome(); else renderLogin(); };
            card.appendChild(btnBack);
            app.appendChild(card);

            // Logic Submit
            setTimeout(() => {
                q('#submitReviewBtn').onclick = async () => {
                    const text = q('#reviewText').value;
                    const ratingEl = document.querySelector('input[name="rating"]:checked');
                    if(!text || !ratingEl) return showAlert("Note et message requis", "error");
                    
                    const rating = parseInt(ratingEl.value);
                    const pseudo = state.pseudo || "Anonyme";
                    
                    try {
                        await addDoc(collection(db, "reviews"), {
                            pseudo, text, rating, date: new Date()
                        });
                        showAlert("Merci pour votre avis !", "success");
                        renderReviews(); // Reload
                    } catch(e) { showAlert("Erreur d'envoi", "error"); }
                };
            }, 100);
        }

        // --- CONTACT ---
        function renderContact() {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>Contact</h2>`;
            const inputMsg = document.createElement('textarea'); inputMsg.className='input'; inputMsg.placeholder='Votre message...';
            const btnSend = document.createElement('button'); btnSend.className='btn'; btnSend.textContent='Envoyer';
            btnSend.onclick = async () => {
                if(!inputMsg.value) return;
                try {
                    await addDoc(collection(db, "messages"), { message: inputMsg.value, user: state.pseudo || 'Guest', date: new Date() });
                    showAlert("Envoy√© !", "success"); renderHome();
                } catch(e) { showAlert("Erreur", "error"); }
            };
            const btnBack = document.createElement('button'); btnBack.className='link'; btnBack.textContent='Retour'; btnBack.onclick=renderHome;
            card.append(inputMsg, btnSend, btnBack); app.appendChild(card);
        }

        // --- LEGAL MODAL LOGIC ---
        function renderLegal() {
            const modal = q('#legalModal');
            const content = q('#legalTextContent');
            content.innerHTML = `
                <h3>1. √âditeur du site</h3>
                <p>Le site Medicome.fr est √©dit√© √† titre personnel. <br>Contact : via le formulaire de contact du site.</p>
                
                <h3>2. H√©bergement</h3>
                <p>Le site est h√©berg√© par GitHub Pages (GitHub Inc., 88 Colin P Kelly Jr St, San Francisco, CA 94107, USA).</p>
                <p>Les donn√©es sont stock√©es sur Google Firebase (Google Ireland Limited, Gordon House, Barrow Street, Dublin 4, Irlande).</p>
                
                <h3>3. Donn√©es Personnelles (RGPD)</h3>
                <p>Medicome recueille votre adresse email uniquement pour l'authentification. Aucune donn√©e n'est revendue √† des tiers. Conform√©ment √† la loi, vous disposez d'un droit d'acc√®s, de rectification et de suppression de vos donn√©es en nous contactant.</p>
                
                <h3>4. Cookies</h3>
                <p>Nous utilisons uniquement des cookies techniques n√©cessaires au fonctionnement (session utilisateur). Aucun cookie publicitaire n'est utilis√©.</p>
            `;
            modal.style.display = 'flex';
        }

        // --- GAME LOGIC (Minimis√©e pour l'exemple, √† garder identique √† avant) ---
        function renderDemographics() {
            // ... (Garder ta fonction renderDemographics existante)
            // Pour faire court ici, je remets le lancement direct
             state.answers={}; state.asked=[]; state.history=[]; state.priorityQueue=[];
             state.demo = { femme:false, homme:true }; // Default
             askNextQuestion();
        }

        function askNextQuestion() {
            // ... (Logique entonnoir simplifi√©e pour que √ßa marche direct)
            if(state.allSigns.length===0) { 
                // Init signs list
                let s = new Set(); PATHOLOGIES.forEach(p=>Object.keys(p.signes).forEach(k=>s.add(k)));
                state.allSigns = Array.from(s);
            }
            
            // Simple random question logic for demo
            const remaining = state.allSigns.filter(s => !state.asked.includes(s));
            if(remaining.length === 0) { showDiagnosticDetails({patho:PATHOLOGIES[0]}); return; } // Fallback
            
            const sign = remaining[Math.floor(Math.random()*remaining.length)];
            state.currentSign = sign;
            state.asked.push(sign);
            renderQuestion(sign);
        }

        function renderQuestion(sign) {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<div class="question-text">Le patient pr√©sente-t-il :<br><strong>${formatName(sign)}</strong> ?</div>`;
            const btnY = document.createElement('button'); btnY.className='btn btn-success'; btnY.textContent='OUI';
            btnY.onclick = ()=>{ state.answers[sign]=true; askNextQuestion(); };
            const btnN = document.createElement('button'); btnN.className='btn btn-error'; btnN.textContent='NON';
            btnN.onclick = ()=>{ state.answers[sign]=false; askNextQuestion(); };
            
            const btnGroup = document.createElement('div'); btnGroup.className='button-group';
            btnGroup.append(btnY, btnN); card.appendChild(btnGroup); app.appendChild(card);
        }

        function showDiagnosticDetails(res) {
            const app = q('#app'); app.innerHTML='';
            const card = document.createElement('div'); card.className='card center';
            card.innerHTML = `<h2>${res.patho.name}</h2><p>${res.patho.short}</p>`;
            if(res.patho.pdf) card.innerHTML += `<a href="${res.patho.pdf}" target="_blank" class="btn">Voir Fiche PDF</a>`;
            const b = document.createElement('button'); b.className='link'; b.textContent='Accueil'; b.onclick=renderHome;
            card.appendChild(b); app.appendChild(card);
        }
        
        function formatName(s){ return s.replace(/_/g,' '); }

    </script>
</body>
</html>
